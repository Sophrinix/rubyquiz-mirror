<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>


<!-- Start Wayback Rewrite JS Include -->
<script type="text/javascript" src="/static/js/jwplayer/jwplayer.js" ></script>
<script type="text/javascript" src="/static/js/video-embed-rewriter.js"></script>
<script type="text/javascript">
function initYTVideo(id)
{
	_wmVideos_.init("/web/", id);
}
</script>
<!-- End Wayback Rewrite JS Include -->

  <meta http-equiv="Content-type" content="text/html; charset=utf-8">
	<title>Ruby Quiz - Tournament Matchups (#105)</title>
	<link rel="stylesheet" type="text/css" href="/web/20120121222823cs_/http://rubyquiz.com/quiz.css" />
	<link rel="stylesheet" type="text/css" href="/web/20120121222823cs_/http://rubyquiz.com/print.css" media="print" />
</head><body>
<!-- BEGIN WAYBACK TOOLBAR INSERT -->

<script type="text/javascript" src="/static/js/disclaim-element.js" ></script>
<script type="text/javascript" src="/static/js/graph-calc.js" ></script>
<script type="text/javascript" src="/static/jflot/jquery.min.js" ></script>
<script type="text/javascript">
//<![CDATA[
var firstDate = 820454400000;
var lastDate = 1388534399999;
var wbPrefix = "/web/";
var wbCurrentUrl = "http:\/\/rubyquiz.com\/quiz105.html";

var curYear = -1;
var curMonth = -1;
var yearCount = 18;
var firstYear = 1996;
var imgWidth = 450;
var yearImgWidth = 25;
var monthImgWidth = 2;
var trackerVal = "none";
var displayDay = "21";
var displayMonth = "Jan";
var displayYear = "2012";
var prettyMonths = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

function showTrackers(val) {
	if(val == trackerVal) {
		return;
	}
	if(val == "inline") {
		document.getElementById("displayYearEl").style.color = "#ec008c";
		document.getElementById("displayMonthEl").style.color = "#ec008c";
		document.getElementById("displayDayEl").style.color = "#ec008c";		
	} else {
		document.getElementById("displayYearEl").innerHTML = displayYear;
		document.getElementById("displayYearEl").style.color = "#ff0";
		document.getElementById("displayMonthEl").innerHTML = displayMonth;
		document.getElementById("displayMonthEl").style.color = "#ff0";
		document.getElementById("displayDayEl").innerHTML = displayDay;
		document.getElementById("displayDayEl").style.color = "#ff0";
	}
   document.getElementById("wbMouseTrackYearImg").style.display = val;
   document.getElementById("wbMouseTrackMonthImg").style.display = val;
   trackerVal = val;
}
function getElementX2(obj) {
	var thing = jQuery(obj);
	if((thing == undefined) 
			|| (typeof thing == "undefined") 
			|| (typeof thing.offset == "undefined")) {
		return getElementX(obj);
	}
	return Math.round(thing.offset().left);
}
function trackMouseMove(event,element) {

   var eventX = getEventX(event);
   var elementX = getElementX2(element);
   var xOff = eventX - elementX;
	if(xOff < 0) {
		xOff = 0;
	} else if(xOff > imgWidth) {
		xOff = imgWidth;
	}
   var monthOff = xOff % yearImgWidth;

   var year = Math.floor(xOff / yearImgWidth);
	var yearStart = year * yearImgWidth;
   var monthOfYear = Math.floor(monthOff / monthImgWidth);
   if(monthOfYear > 11) {
       monthOfYear = 11;
   }
   // 1 extra border pixel at the left edge of the year:
   var month = (year * 12) + monthOfYear;
   var day = 1;
	if(monthOff % 2 == 1) {
		day = 15;
	}
	var dateString = 
		zeroPad(year + firstYear) + 
		zeroPad(monthOfYear+1,2) +
		zeroPad(day,2) + "000000";

	var monthString = prettyMonths[monthOfYear];
	document.getElementById("displayYearEl").innerHTML = year + 1996;
	document.getElementById("displayMonthEl").innerHTML = monthString;
	// looks too jarring when it changes..
	//document.getElementById("displayDayEl").innerHTML = zeroPad(day,2);

	var url = wbPrefix + dateString + '/' +  wbCurrentUrl;
	document.getElementById('wm-graph-anchor').href = url;

   //document.getElementById("wmtbURL").value="evX("+eventX+") elX("+elementX+") xO("+xOff+") y("+year+") m("+month+") monthOff("+monthOff+") DS("+dateString+") Moy("+monthOfYear+") ms("+monthString+")";
   if(curYear != year) {
       var yrOff = year * yearImgWidth;
       document.getElementById("wbMouseTrackYearImg").style.left = yrOff + "px";
       curYear = year;
   }
   if(curMonth != month) {
       var mtOff = year + (month * monthImgWidth) + 1;
       document.getElementById("wbMouseTrackMonthImg").style.left = mtOff + "px";
       curMonth = month;
   }
}
//]]>
</script>

<style type="text/css">body{margin-top:0!important;padding-top:0!important;min-width:800px!important;}#wm-ipp a:hover{text-decoration:underline!important;}</style>
<div id="wm-ipp" style="display:none; position:relative;padding:0 5px;min-height:70px;min-width:800px; z-index:9000;">
<div id="wm-ipp-inside" style="position:fixed;padding:0!important;margin:0!important;width:97%;min-width:780px;border:5px solid #000;border-top:none;background-image:url(/static/images/toolbar/wm_tb_bk_trns.png);text-align:center;-moz-box-shadow:1px 1px 3px #333;-webkit-box-shadow:1px 1px 3px #333;box-shadow:1px 1px 3px #333;font-size:11px!important;font-family:'Lucida Grande','Arial',sans-serif!important;">
   <table style="border-collapse:collapse;margin:0;padding:0;width:100%;"><tbody><tr>
   <td style="padding:10px;vertical-align:top;min-width:110px;">
   <a href="/web/" title="Wayback Machine home page" style="background-color:transparent;border:none;"><img src="/static/images/toolbar/wayback-toolbar-logo.png" alt="Wayback Machine" width="110" height="39" border="0"/></a>
   </td>
   <td style="padding:0!important;text-align:center;vertical-align:top;width:100%;">

       <table style="border-collapse:collapse;margin:0 auto;padding:0;width:570px;"><tbody><tr>
       <td style="padding:3px 0;" colspan="2">
       <form target="_top" method="get" action="/web/form-submit.jsp" name="wmtb" id="wmtb" style="margin:0!important;padding:0!important;"><input type="text" name="url" id="wmtbURL" value="http://rubyquiz.com/quiz105.html" style="width:400px;font-size:11px;font-family:'Lucida Grande','Arial',sans-serif;" onfocus="javascript:this.focus();this.select();" /><input type="hidden" name="type" value="replay" /><input type="hidden" name="date" value="20120121222823" /><input type="submit" value="Go" style="font-size:11px;font-family:'Lucida Grande','Arial',sans-serif;margin-left:5px;" /><span id="wm_tb_options" style="display:block;"></span></form>
       </td>
       <td style="vertical-align:bottom;padding:5px 0 0 0!important;" rowspan="2">
           <table style="border-collapse:collapse;width:110px;color:#99a;font-family:'Helvetica','Lucida Grande','Arial',sans-serif;"><tbody>
			
           <!-- NEXT/PREV MONTH NAV AND MONTH INDICATOR -->
           <tr style="width:110px;height:16px;font-size:10px!important;">
           	<td style="padding-right:9px;font-size:11px!important;font-weight:bold;text-transform:uppercase;text-align:right;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20110827193002/http://www.rubyquiz.com/quiz105.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="27 Aug 2011"><strong>AUG</strong></a>
		                
               </td>
               <td id="displayMonthEl" style="background:#000;color:#ff0;font-size:11px!important;font-weight:bold;text-transform:uppercase;width:34px;height:15px;padding-top:1px;text-align:center;" title="You are here: 22:28:23 Jan 21, 2012">JAN</td>
				<td style="padding-left:9px;font-size:11px!important;font-weight:bold;text-transform:uppercase;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20120418135957/http://www.rubyquiz.com/quiz105.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="18 Apr 2012"><strong>APR</strong></a>
		                
               </td>
           </tr>

           <!-- NEXT/PREV CAPTURE NAV AND DAY OF MONTH INDICATOR -->
           <tr>
               <td style="padding-right:9px;white-space:nowrap;overflow:visible;text-align:right!important;vertical-align:middle!important;" nowrap="nowrap">
               
		                <a href="/web/20120103145007/http://www.rubyquiz.com/quiz105.html" title="14:50:07 Jan 3, 2012" style="background-color:transparent;border:none;"><img src="/static/images/toolbar/wm_tb_prv_on.png" alt="Previous capture" width="14" height="16" border="0" /></a>
		                
               </td>
               <td id="displayDayEl" style="background:#000;color:#ff0;width:34px;height:24px;padding:2px 0 0 0;text-align:center;font-size:24px;font-weight: bold;" title="You are here: 22:28:23 Jan 21, 2012">21</td>
				<td style="padding-left:9px;white-space:nowrap;overflow:visible;text-align:left!important;vertical-align:middle!important;" nowrap="nowrap">
               
		                <a href="/web/20120122040222/http://rubyquiz.com/quiz105.html" title="4:02:22 Jan 22, 2012" style="background-color:transparent;border:none;"><img src="/static/images/toolbar/wm_tb_nxt_on.png" alt="Next capture" width="14" height="16" border="0"/></a>
		                
			    </td>
           </tr>

           <!-- NEXT/PREV YEAR NAV AND YEAR INDICATOR -->
           <tr style="width:110px;height:13px;font-size:9px!important;">
				<td style="padding-right:9px;font-size:11px!important;font-weight: bold;text-align:right;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20101127175130/http://rubyquiz.com/quiz105.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="27 Nov 2010"><strong>2010</strong></a>
		                
               </td>
               <td id="displayYearEl" style="background:#000;color:#ff0;font-size:11px!important;font-weight: bold;padding-top:1px;width:34px;height:13px;text-align:center;" title="You are here: 22:28:23 Jan 21, 2012">2012</td>
				<td style="padding-left:9px;font-size:11px!important;font-weight: bold;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20130215052720/http://rubyquiz.com/quiz105.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="15 Feb 2013"><strong>2013</strong></a>
		                
				</td>
           </tr>
           </tbody></table>
       </td>

       </tr>
       <tr>
       <td style="vertical-align:middle;padding:0!important;">
           <a href="/web/20120121222823*/http://rubyquiz.com/quiz105.html" style="color:#33f;font-size:11px;font-weight:bold;background-color:transparent;border:none;" title="See a list of every capture for this URL"><strong>26 captures</strong></a>
           <div style="margin:0!important;padding:0!important;color:#666;font-size:9px;padding-top:2px!important;white-space:nowrap;" title="Timespan for captures of this URL">7 Jul 07 - 15 Feb 13</div>
       </td>
       <td style="padding:0!important;">
       <a style="position:relative; white-space:nowrap; width:450px;height:27px;" href="" id="wm-graph-anchor">
       <div id="wm-ipp-sparkline" style="position:relative; white-space:nowrap; width:450px;height:27px;background-color:#fff;cursor:pointer;border-right:1px solid #ccc;" title="Explore captures for this URL">
			<img id="sparklineImgId" style="position:absolute; z-index:9012; top:0px; left:0px;"
				onmouseover="showTrackers('inline');" 
				onmouseout="showTrackers('none');"
				onmousemove="trackMouseMove(event,this)"
				alt="sparklines"
				width="450"
				height="27"
				border="0"
				src="/web/jsp/graph.jsp?graphdata=450_27_1996:-1:000000000000_1997:-1:000000000000_1998:-1:000000000000_1999:-1:000000000000_2000:-1:000000000000_2001:-1:000000000000_2002:-1:000000000000_2003:-1:000000000000_2004:-1:000000000000_2005:-1:000000000000_2006:-1:000000000000_2007:-1:000000200000_2008:-1:000000000000_2009:-1:000000000000_2010:-1:000000000010_2011:-1:000000020000_2012:0:40014000a100_2013:-1:010000000000"></img>
			<img id="wbMouseTrackYearImg" 
				style="display:none; position:absolute; z-index:9010;"
				width="25" 
				height="27"
				border="0"
				src="/static/images/toolbar/transp-yellow-pixel.png"></img>
			<img id="wbMouseTrackMonthImg"
				style="display:none; position:absolute; z-index:9011; " 
				width="2"
				height="27" 
				border="0"
				src="/static/images/toolbar/transp-red-pixel.png"></img>
       </div>
		</a>

       </td>
       </tr></tbody></table>
   </td>
   <td style="text-align:right;padding:5px;width:65px;font-size:11px!important;">
       <a href="javascript:;" onclick="document.getElementById('wm-ipp').style.display='none';" style="display:block;padding-right:18px;background:url(/static/images/toolbar/wm_tb_close.png) no-repeat 100% 0;color:#33f;font-family:'Lucida Grande','Arial',sans-serif;margin-bottom:23px;background-color:transparent;border:none;" title="Close the toolbar">Close</a>
       <a href="http://faq.web.archive.org/" style="display:block;padding-right:18px;background:url(/static/images/toolbar/wm_tb_help.png) no-repeat 100% 0;color:#33f;font-family:'Lucida Grande','Arial',sans-serif;background-color:transparent;border:none;" title="Get some help using the Wayback Machine">Help</a>
   </td>
   </tr></tbody></table>

</div>
</div>
<script type="text/javascript">
 var wmDisclaimBanner = document.getElementById("wm-ipp");
 if(wmDisclaimBanner != null) {
   disclaimElement(wmDisclaimBanner);
 }
</script>
<!-- END WAYBACK TOOLBAR INSERT -->

	<div id="page">
		<div id="header"><span class="ruby">Ruby</span> <span class="quiz">Quiz</span></div>
		<div id="content">
			<span class="title">Tournament Matchups (#105)</span>
			<p>by Demetrius Nunes</p>
			<p>In a single-elimination tournament, there is usually a previously established ranking for the participating players or teams, such as that the best players or teams are matched against the worst ones. This is done this way so there is a higher chance for the top players/teams to meet in the final.</p>
			<p>For example, in a small 8-player tournament, there would be 3 rounds. This first round would be setup like this:</p>
			<p class="example">Round 1<br />1 x 8<br />2 x 7<br />3 x 6<br />4 x 5</p>
			<p>This is easy enough. The tough part is arranging the pairing for the following rounds respecting the best vs worst rule, so, imagining that all the favorites won their games, we would have 1x4 and 2x3 in round 2 and then finally 1x2 in the final. For this to happen, the tournament would have to be arranged this way:</p>
			<p class="example">R1  R2  R3<br />============<br />1<br />---<br />   |---<br />---    |<br />8      |<br />       |---<br />4      |   |<br />---    |   |<br />   |---    |<br />---        |<br />5          |<br />           |----<br />2          |<br />---        |<br />   |---    |<br />---    |   |<br />7      |   |<br />       |---<br />3      |<br />---    |<br />   |---<br />---<br />6</p>
			<p>If the numbers of players/teams is not a potency of 2, then the top players would have a "bye" in the first round, so, a 6-player draw would go like this:</p>
			<p class="example">R1  R2  R3<br />============<br />1<br />---<br />   |---<br />---    |<br />bye    |<br />       |---<br />4      |   |<br />---    |   |<br />   |---    |<br />---        |<br />5          |<br />           |----<br />2          |<br />---        |<br />   |---    |<br />---    |   |<br />bye    |   |<br />       |---<br />3      |<br />---    |<br />   |---<br />---<br />6</p>
			<p>So, this quiz is about writing a single-elimination tournament generator for any number of players/teams obeying the best vs worst rule in all rounds.</p>
			<p>For a quick look at correct answers see this "got-the-job-done" javascript/html implementation at:</p>
			<p><a href="/web/20120121222823/http://www.crowsdarts.com/brackets/playoff-chart.html">Playoff Charts</a></p>
			<p>We are looking for correct data modeling and calculation, not for correct presentation output of the tournament draw, but it would be nice to implement a #to_s output like the ones seen above (or even better: how about a beautiful RMagick generated image?!). In all cases, keep the model and presentation cleanly separated.</p>
			<hr />
			<p><span class="title">Quiz Summary</span></p>
			<p>Quite a few people took a stab at this problem with some mighty clever code.  I'll confess that I spent a fair amount of time in IRb just to understand some of the entries.  Perhaps that is instructive in and of itself though, so let me share an exploration of code with you.</p>
			<p>I want to take a look at Marshall T. Vandegrift's solution here.  It's some clever code that taught me fun new tricks, but I had to play with it a bit to understand all of it.  It begins with a simple require:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="comment">#! /usr/bin/env ruby</span><br /><br />    require <span class="string">'facet/symbol/to_proc'</span><br /><br />    <span class="comment"># ...</span><br /><br /></div></div>
			<p>If your not familiar with it, the Facets library is a collection of extensions to Ruby.  As we see here, you can hand pick the extensions you will need for your program.  Marshall asked for the popular Railsism Symbol#to_proc.  The method goes something like:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="keyword">class</span> Symbol<br />      <span class="keyword">def</span> to_proc<br />        lambda { |arg| arg.send(<span class="keyword">self</span>) }<br />      <span class="keyword">end</span><br />    <span class="keyword">end</span><br /><br /></div></div>
			<p>The version in the Facets library is a bit more powerful than that, but this is all Marshall really needed.  The trick here is that Ruby translates a trailing &amp;whatever in a method call to whatever.to_proc().  Thus the above hack allows us to shorthand common iterations like:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    words.map { |word| word.downcase }<br /><br /></div></div>
			<p>to:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    words.map(&amp;:downcase)<br /><br /></div></div>
			<p>Let's get back to Marshall's code now:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="comment"># ...</span><br /><br />    <span class="keyword">class</span> &lt;&lt; Math<br />      <span class="keyword">def</span> log2(n); log(n) / log(2); <span class="keyword">end</span><br />    <span class="keyword">end</span><br /><br />    <span class="comment"># ...</span><br /><br /></div></div>
			<p>Now I'm sure all you math geeks just looked at that and nodded, but I said, "What's that for?"  To find out I decided to play with it in IRb a little:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    &gt;&gt; <span class="keyword">class</span> &lt;&lt; Math<br />    &gt;&gt;   <span class="keyword">def</span> log2(n); log(n) / log(2); <span class="keyword">end</span><br />    &gt;&gt; <span class="keyword">end</span><br />    =&gt; <span class="keyword">nil</span><br />    &gt;&gt; (1..10).map { |i| Math.log2(i) }<br />    =&gt; [0.0, 1.0, 1.58496250072116, 2.0, 2.32192809488736, 2.58496250072116,<br />        2.8073549220576, 3.0, 3.16992500144231, 3.32192809488736]<br />    &gt;&gt; (1..10).map { |i| Math.log2(i).ceil }<br />    =&gt; [0, 1, 2, 2, 3, 3, 3, 3, 4, 4]<br />    &gt;&gt; puts (1..10).map { |i| <span class="string">"#{i}: #{Math.log2(i).ceil}"</span> }<br />    1: 0<br />    2: 1<br />    3: 2<br />    4: 2<br />    5: 3<br />    6: 3<br />    7: 3<br />    8: 3<br />    9: 4<br />    10: 4<br />    =&gt; <span class="keyword">nil</span><br /><br /></div></div>
			<p>Let me talk you through my thought process a bit there.  I thought, well that looks like a mathematical function that expects a numerical argument.  Let's feed it a handful of numbers and see if I can make sense of the output.  Egad, fractions!  OK, this doesn't seem like a problem to involve fractions, so we probably need to round up or down.  I'll try up.  That set of numbers look promising.  Let's match them up with the inputs and see if they mean anything to me.</p>
			<p>There are only a few numbers in this problem:  number of players, number of byes, and number of rounds were all I could think of.  Ah yes, number of rounds.  Two players need only one game.  The quiz listed three rounds for both eight and six player sets.  Looks like this is a handy way to calculate the needed number of rounds.</p>
			<p>Like I said, I'm sure most of you got to skip my little journey to enlightenment there, but the rest of us have to use the tools we can.</p>
			<p>Back to Marshall's code:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="comment"># ...</span><br /><br />    <span class="keyword">class</span> Array<br />      <span class="keyword">def</span> half_size; size &gt;&gt; 1; <span class="keyword">end</span><br />      <span class="keyword">def</span> top_half; <span class="keyword">self</span>[0, half_size]; <span class="keyword">end</span><br />      <span class="keyword">def</span> bottom_half; <span class="keyword">self</span>[half_size, half_size]; <span class="keyword">end</span><br />    <span class="keyword">end</span><br /><br />    <span class="comment"># ...</span><br /><br /></div></div>
			<p>This time I was pretty sure I knew what the code did, just from the method names if nothing else.  I still had questions though.  "How does that work with odd sizes?"  I asked IRb:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    &gt;&gt; <span class="keyword">class</span> Array<br />    &gt;&gt;   <span class="keyword">def</span> half_size; size &gt;&gt; 1; <span class="keyword">end</span><br />    &gt;&gt;   <span class="keyword">def</span> top_half; <span class="keyword">self</span>[0, half_size]; <span class="keyword">end</span><br />    &gt;&gt;   <span class="keyword">def</span> bottom_half; <span class="keyword">self</span>[half_size, half_size]; <span class="keyword">end</span><br />    &gt;&gt; <span class="keyword">end</span><br />    =&gt; <span class="keyword">nil</span><br />    &gt;&gt; a = (1..5).to_a<br />    =&gt; [1, 2, 3, 4, 5]<br />    &gt;&gt; a.half_size<br />    =&gt; 2<br />    &gt;&gt; a.size / 2<br />    =&gt; 2<br />    &gt;&gt; a.top_half<br />    =&gt; [1, 2]<br />    &gt;&gt; a.bottom_half<br />    =&gt; [3, 4]<br />    &gt;&gt; a.pop<br />    =&gt; 5<br />    &gt;&gt; a<br />    =&gt; [1, 2, 3, 4]<br />    &gt;&gt; a.half_size<br />    =&gt; 2<br />    &gt;&gt; a.top_half<br />    =&gt; [1, 2]<br />    &gt;&gt; a.bottom_half<br />    =&gt; [3, 4]<br /><br /></div></div>
			<p>Answer:  It doesn't.  Good to know.</p>
			<p>To figure out why this doesn't matter, we need the next bit of code:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="comment"># ...</span><br /><br />    <span class="keyword">class</span> Tournament<br />      <span class="keyword">def</span> initialize(players)<br />        raise <span class="string">"Tournament requires 2 or more players"</span> <span class="keyword">if</span> players.size &lt; 2<br /><br />        <span class="variable">@players</span> = players<br />        <span class="variable">@matches</span> = (0...nrounds).inject(seed) <span class="keyword">do</span> |(memo,)|<br />          memo.top_half.zip(memo.bottom_half.reverse)<br />        <span class="keyword">end</span><br />      <span class="keyword">end</span><br /><br />      attr_reader :players<br />      attr_reader :matches<br /><br />      <span class="keyword">def</span> render(renderer = AsciiRenderer)<br />        extend renderer<br />        render_tournament<br />      <span class="keyword">end</span><br /><br />      protected<br />      <span class="keyword">def</span> seed; <span class="variable">@seed</span> ||= players + Array.new(nbyes, :bye); <span class="keyword">end</span><br />      <span class="keyword">def</span> nplayers; players.size; <span class="keyword">end</span><br />      <span class="keyword">def</span> nrounds; Math.log2(nplayers).ceil; <span class="keyword">end</span><br />      <span class="keyword">def</span> nbyes; (1 &lt;&lt; nrounds) - nplayers; <span class="keyword">end</span><br />    <span class="keyword">end</span><br /><br />    <span class="comment"># ...</span><br /><br /></div></div>
			<p>My first reaction was, "Hey look at that nrounds() method.  I was right!"  The second one was, "Ick.  Look at the nbyes() method.  Marshall knows more math than James."  Back to IRb we go:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    &gt;&gt; <span class="keyword">def</span> test_bytes(rounds, players)<br />    &gt;&gt;   pow_of_2 = 1 &lt;&lt; rounds<br />    &gt;&gt;   byes     = pow_of_2 - players<br />    &gt;&gt;   puts <span class="string">"Byes #{byes} (pow_of_2 = #{pow_of_2})"</span><br />    &gt;&gt; <span class="keyword">end</span><br />    =&gt; <span class="keyword">nil</span><br />    &gt;&gt; test_bytes(3, 6)<br />    Byes 2 (pow_of_2 = 8)<br />    =&gt; <span class="keyword">nil</span><br />    &gt;&gt; test_bytes(3, 8)<br />    Byes 0 (pow_of_2 = 8)<br />    =&gt; <span class="keyword">nil</span><br />    &gt;&gt; test_bytes(1, 2)<br />    Byes 0 (pow_of_2 = 2)<br />    =&gt; <span class="keyword">nil</span><br /><br /></div></div>
			<p>Bit shifting rounds places to the left appears to give us the power of two equal to the number of players or just above.  Handy that.  With it we can just pull off the number of players and we have a count of how many byes are needed.  Now have another look at how this was put to use:</p>
			<div class="code"><span class="type">ruby</span><div class="body">      <span class="keyword">def</span> seed; <span class="variable">@seed</span> ||= players + Array.new(nbyes, :bye); <span class="keyword">end</span><br /><br /></div></div>
			<p>The seed() turns out to be an Array of players (on top) and byes (at the bottom).  Given that, we know that seed().size() will be a power of two which is an even number.  That tells us why the Array dividers didn't need to work with odd counts.</p>
			<p>It's all coming together.  Have one last peek at how the matchups are made:</p>
			<div class="code"><span class="type">ruby</span><div class="body">      <span class="keyword">def</span> initialize(players)<br />        raise <span class="string">"Tournament requires 2 or more players"</span> <span class="keyword">if</span> players.size &lt; 2<br /><br />        <span class="variable">@players</span> = players<br />        <span class="variable">@matches</span> = (0...nrounds).inject(seed) <span class="keyword">do</span> |(memo,)|<br />          memo.top_half.zip(memo.bottom_half.reverse)<br />        <span class="keyword">end</span><br />      <span class="keyword">end</span><br /><br /></div></div>
			<p>The entire tournament is arranged there with what gets my vote for the scariest use of inject() I have ever seen.  The icky (memo,) construct is used to discard the unused second value, which means inject() is pretty much a times() call here, save that it updates the mutated Array at each step.  Here's a study of what exactly is being constructed and a more verbose but hopefully easier to understand way to write it:</p>
			<div class="code"><span class="type">ruby</span><div class="body">  &gt;&gt; (0...3).inject([1, 2, 3, 4, 5, 6, :bye, :bye]) <span class="keyword">do</span> |memo, unused|<br />  ?&gt;   p memo<br />  &gt;&gt;   memo.top_half.zip(memo.bottom_half.reverse)<br />  &gt;&gt; <span class="keyword">end</span><br />  [1, 2, 3, 4, 5, 6, :bye, :bye]<br />  [[1, :bye], [2, :bye], [3, 6], [4, 5]]<br />  [[[1, :bye], [4, 5]], [[2, :bye], [3, 6]]]<br />  =&gt; [[[[1, :bye], [4, 5]], [[2, :bye], [3, 6]]]]<br />  &gt;&gt; matchups = [1, 2, 3, 4, 5, 6, :bye, :bye]<br />  =&gt; [1, 2, 3, 4, 5, 6, :bye, :bye]<br />  &gt;&gt; 3.times <span class="keyword">do</span><br />  ?&gt;   p matchups<br />  &gt;&gt;   matchups = matchups.top_half.zip(matchups.bottom_half.reverse)<br />  &gt;&gt; <span class="keyword">end</span><br />  [1, 2, 3, 4, 5, 6, :bye, :bye]<br />  [[1, :bye], [2, :bye], [3, 6], [4, 5]]<br />  [[[1, :bye], [4, 5]], [[2, :bye], [3, 6]]]<br />  =&gt; 3<br />  &gt;&gt; matchups<br />  =&gt; [[[[1, :bye], [4, 5]], [[2, :bye], [3, 6]]]]<br /><br /></div></div>
			<p>This shows the fascinating Array structure that gets built, nesting each round's matchups.  I also tried to break down the operation into a more normal Ruby construct.</p>
			<p>At this point, we have the entire tournament planned out.  Now it's time to do some drawing.</p>
			<p>I'll stop clowning around with IRb at this point and just cover the code normally.  I do think it's important to realize what a powerful tool of exploration this can be though.  It's great to be able to segment out the elements of code you don't understand and explore what it does by making a few method calls.</p>
			<p>How Marshall triggers the rendering code is more cleverness, but with Ruby this time instead of math.  Let me refresh your memory:</p>
			<div class="code"><span class="type">ruby</span><div class="body">      attr_reader :matches<br /><br />      <span class="keyword">def</span> render(renderer = AsciiRenderer)<br />        extend renderer<br />        render_tournament<br />      <span class="keyword">end</span><br /><br /></div></div>
			<p>The matches() accessor and other utility methods provides all we need to render results.  Marshall decides to use those as the methods supporting a rendering mixin.  A call to render() then mixes the desired rendering Module into this object and triggers the process.  This allows each tournament to use a different renderer.</p>
			<p>Here's the renderer included with the code for drawing ASCII charts:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="comment"># ...</span><br /><br />    <span class="keyword">module</span> Tournament::AsciiRenderer<br />      protected<br />      <span class="keyword">def</span> render_tournament<br />        render_header.concat(render_rounds).join(<span class="string">"\n"</span>)<br />      <span class="keyword">end</span><br /><br />      <span class="comment"># ...</span><br /><br /></div></div>
			<p>The end result, we can see, is just the headers plus each round.  Let's dip into those rendering methods:</p>
			<div class="code"><span class="type">ruby</span><div class="body">      <span class="comment"># ...</span><br /><br />      private<br />      <span class="keyword">def</span> render_header<br />        [ (1..nrounds).collect { |r| <span class="string">"R#{r}"</span>.ljust(width + 1) }.join,<br />          (<span class="string">'='</span> * (nrounds * (width + 1))) ]<br />      <span class="keyword">end</span><br /><br />      <span class="comment"># ...</span><br /><br /></div></div>
			<p>The overall rendering process builds an Array of lines, which are join()ed as we saw in render_tournament().  The lines here start the process off with a row of round numbers and a row of equals signs to set them off from the content.</p>
			<p>Then we get to round rendering, which is a little more involved:</p>
			<div class="code"><span class="type">ruby</span><div class="body">      <span class="comment"># ...</span><br /><br />      <span class="keyword">def</span> render_rounds<br />        render_match(matches.first)<br />      <span class="keyword">end</span><br /><br />      <span class="keyword">def</span> render_match(match)<br />        <span class="keyword">unless</span> match.kind_of? Array<br />          draw = [ render_player(match), slot1 ]<br />          (<span class="variable">@flip</span> = !<span class="variable">@flip</span>) ? draw : draw.reverse<br />        <span class="keyword">else</span><br />          draw = match.collect <span class="keyword">do</span> |match_|<br />            render_match(match_)<br />          <span class="keyword">end</span>.inject <span class="keyword">do</span> |memo, draw_|<br />            (memo &lt;&lt; (<span class="string">' '</span> * memo.first.size)).concat(draw_)<br />          <span class="keyword">end</span><br /><br />          fh = (draw.size - 3) / 4<br />          sh = [ (draw.size + 1) / 4, 2 ].max<br />          draw_ = [ [space]*sh, [flow]*fh, slot, [flow]*fh, [space]*sh ]<br />          draw.zip(draw_.flatten).collect(&amp;:join)<br />        <span class="keyword">end</span><br />      <span class="keyword">end</span><br /><br />      <span class="keyword">def</span> render_player(player)<br />        player.to_s.ljust(width)<br />      <span class="keyword">end</span><br /><br />      <span class="keyword">def</span> slot;  <span class="string">'|'</span> &lt;&lt; (<span class="string">'-'</span> * width); <span class="keyword">end</span><br />      <span class="keyword">def</span> slot1;        (<span class="string">'-'</span> * width); <span class="keyword">end</span><br />      <span class="keyword">def</span> flow;  <span class="string">'|'</span> &lt;&lt; (<span class="string">' '</span> * width); <span class="keyword">end</span><br />      <span class="keyword">def</span> space; <span class="string">' '</span> &lt;&lt; (<span class="string">' '</span> * width); <span class="keyword">end</span><br /><br />      <span class="keyword">def</span> width<br />        <span class="variable">@width</span> ||= seed.collect { |x| x.to_s.size }.max;<br />      <span class="keyword">end</span><br />    <span class="keyword">end</span><br /><br />    <span class="comment"># ...</span><br /><br /></div></div>
			<p>The process begins in render_rounds() which strips an extra layer of nesting off of matches() and makes a hand-off to render_match().</p>
			<p>In render_match() the flow is split by a slightly confusing unless/else construct.  Arrays (or rounds) are handled in the else clause, which recursively renders each match and then joins the results together with enough slots()s, flow()s, and space()s.  Strings and Symbols (or players) are handled in the unless clause.  This is mainly just a delegation to render_player() and slot1(), but the line order has to be reversed every other time to make even player names list under the chart bar.</p>
			<p>The width() is the helper we have seen used all through the rendering process to determine field width which is just the longest player's name.  Note how the value is cached here with the ||= operator, so it only has to be calculated the first time.</p>
			<p>All that remains is the code to start us off:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="comment"># ...</span><br /><br />    <span class="keyword">if</span> <span class="keyword">__FILE__</span> == <span class="global">$0</span><br />      puts Tournament.new(ARGV).render<br />    <span class="keyword">end</span><br /><br /></div></div>
			<p>ARGV is assumed to be a list of player names in rank order and thus passed to Tournament.new() to build the matches.  A call to render() generates the chart which is dumped by puts().</p>
			<p>Many of the solutions involved clever code in their own right, so don't forget to look through them.  My thanks to all for giving us the fun code to play with and to Marshall for teaching me some math.</p>
			<p>Tomorrow we will tackle board setup for a Bobby Fischer created chess variant...</p>
		</div>
		<div id="logo"><img src="/web/20120121222823im_/http://rubyquiz.com/images/ruby_quiz_logo.jpg" alt="" width="157" height="150" /></div>
		<div id="links">
			<span class="title">Quiz Solutions</span>
			<ol>
				<li><a href="/web/20120121222823/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/229013">Louis J Scoras</a></li>
				<li><a href="/web/20120121222823/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/229028">Matthias Kegelmann</a></li>
				<li><a href="/web/20120121222823/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/229030">Daniel Finnie</a></li>
				<li><a href="/web/20120121222823/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/229031">Daniel Finnie (2)</a></li>
				<li><a href="/web/20120121222823/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/229049">Fred Wulff</a></li>
				<li><a href="/web/20120121222823/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/229059">Dema</a></li>
				<li><a href="/web/20120121222823/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/229067">Daniel Finnie (3)</a></li>
				<li><a href="/web/20120121222823/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/229068">Eric</a></li>
				<li><a href="/web/20120121222823/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/229071">Max Muermann</a></li>
				<li><a href="/web/20120121222823/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/229102">Pedro Fortuny Ayuso</a></li>
				<li><a href="/web/20120121222823/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/229146">Robert Dober</a></li>
				<li><a href="/web/20120121222823/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/229159">John Baylor</a></li>
				<li><a href="/web/20120121222823/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/229272">C&eacute;dric Finance</a></li>
				<li><a href="/web/20120121222823/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/229344">John Baylor (2)</a></li>
				<li><a href="/web/20120121222823/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/229371">Matthew Moss</a></li>
				<li><a href="/web/20120121222823/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/229373">William James</a></li>
				<li><a href="/web/20120121222823/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/229376">Marshall T. Vandegrift</a></li>
				<li><a href="/web/20120121222823/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/229731">William James (2)</a></li>
			</ol>
			<p><a href="/web/20120121222823/http://rubyquiz.com/quiz105_sols.zip">Download Solutions</a></p>
			<p><a href="/web/20120121222823/http://rubyquiz.com/index.html">Back to Quiz Listing</a></p>
		</div>
		<div id="footer">&nbsp;</div>
	</div>
</body>
</html>





<!--
     FILE ARCHIVED ON 22:28:23 Jan 21, 2012 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 13:10:31 Jun 5, 2013.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
