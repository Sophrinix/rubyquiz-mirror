<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>


<!-- Start Wayback Rewrite JS Include -->
<script type="text/javascript" src="/static/js/jwplayer/jwplayer.js" ></script>
<script type="text/javascript" src="/static/js/video-embed-rewriter.js"></script>
<script type="text/javascript">
function initYTVideo(id)
{
	_wmVideos_.init("/web/", id);
}
</script>
<!-- End Wayback Rewrite JS Include -->

  <meta http-equiv="Content-type" content="text/html; charset=utf-8">
	<title>Ruby Quiz - Verbal Arithmetic (#128)</title>
	<link rel="stylesheet" type="text/css" href="/web/20120121184247cs_/http://rubyquiz.com/quiz.css" />
	<link rel="stylesheet" type="text/css" href="/web/20120121184247cs_/http://rubyquiz.com/print.css" media="print" />
</head><body>
<!-- BEGIN WAYBACK TOOLBAR INSERT -->

<script type="text/javascript" src="/static/js/disclaim-element.js" ></script>
<script type="text/javascript" src="/static/js/graph-calc.js" ></script>
<script type="text/javascript" src="/static/jflot/jquery.min.js" ></script>
<script type="text/javascript">
//<![CDATA[
var firstDate = 820454400000;
var lastDate = 1388534399999;
var wbPrefix = "/web/";
var wbCurrentUrl = "http:\/\/rubyquiz.com\/quiz128.html";

var curYear = -1;
var curMonth = -1;
var yearCount = 18;
var firstYear = 1996;
var imgWidth = 450;
var yearImgWidth = 25;
var monthImgWidth = 2;
var trackerVal = "none";
var displayDay = "21";
var displayMonth = "Jan";
var displayYear = "2012";
var prettyMonths = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

function showTrackers(val) {
	if(val == trackerVal) {
		return;
	}
	if(val == "inline") {
		document.getElementById("displayYearEl").style.color = "#ec008c";
		document.getElementById("displayMonthEl").style.color = "#ec008c";
		document.getElementById("displayDayEl").style.color = "#ec008c";		
	} else {
		document.getElementById("displayYearEl").innerHTML = displayYear;
		document.getElementById("displayYearEl").style.color = "#ff0";
		document.getElementById("displayMonthEl").innerHTML = displayMonth;
		document.getElementById("displayMonthEl").style.color = "#ff0";
		document.getElementById("displayDayEl").innerHTML = displayDay;
		document.getElementById("displayDayEl").style.color = "#ff0";
	}
   document.getElementById("wbMouseTrackYearImg").style.display = val;
   document.getElementById("wbMouseTrackMonthImg").style.display = val;
   trackerVal = val;
}
function getElementX2(obj) {
	var thing = jQuery(obj);
	if((thing == undefined) 
			|| (typeof thing == "undefined") 
			|| (typeof thing.offset == "undefined")) {
		return getElementX(obj);
	}
	return Math.round(thing.offset().left);
}
function trackMouseMove(event,element) {

   var eventX = getEventX(event);
   var elementX = getElementX2(element);
   var xOff = eventX - elementX;
	if(xOff < 0) {
		xOff = 0;
	} else if(xOff > imgWidth) {
		xOff = imgWidth;
	}
   var monthOff = xOff % yearImgWidth;

   var year = Math.floor(xOff / yearImgWidth);
	var yearStart = year * yearImgWidth;
   var monthOfYear = Math.floor(monthOff / monthImgWidth);
   if(monthOfYear > 11) {
       monthOfYear = 11;
   }
   // 1 extra border pixel at the left edge of the year:
   var month = (year * 12) + monthOfYear;
   var day = 1;
	if(monthOff % 2 == 1) {
		day = 15;
	}
	var dateString = 
		zeroPad(year + firstYear) + 
		zeroPad(monthOfYear+1,2) +
		zeroPad(day,2) + "000000";

	var monthString = prettyMonths[monthOfYear];
	document.getElementById("displayYearEl").innerHTML = year + 1996;
	document.getElementById("displayMonthEl").innerHTML = monthString;
	// looks too jarring when it changes..
	//document.getElementById("displayDayEl").innerHTML = zeroPad(day,2);

	var url = wbPrefix + dateString + '/' +  wbCurrentUrl;
	document.getElementById('wm-graph-anchor').href = url;

   //document.getElementById("wmtbURL").value="evX("+eventX+") elX("+elementX+") xO("+xOff+") y("+year+") m("+month+") monthOff("+monthOff+") DS("+dateString+") Moy("+monthOfYear+") ms("+monthString+")";
   if(curYear != year) {
       var yrOff = year * yearImgWidth;
       document.getElementById("wbMouseTrackYearImg").style.left = yrOff + "px";
       curYear = year;
   }
   if(curMonth != month) {
       var mtOff = year + (month * monthImgWidth) + 1;
       document.getElementById("wbMouseTrackMonthImg").style.left = mtOff + "px";
       curMonth = month;
   }
}
//]]>
</script>

<style type="text/css">body{margin-top:0!important;padding-top:0!important;min-width:800px!important;}#wm-ipp a:hover{text-decoration:underline!important;}</style>
<div id="wm-ipp" style="display:none; position:relative;padding:0 5px;min-height:70px;min-width:800px; z-index:9000;">
<div id="wm-ipp-inside" style="position:fixed;padding:0!important;margin:0!important;width:97%;min-width:780px;border:5px solid #000;border-top:none;background-image:url(/static/images/toolbar/wm_tb_bk_trns.png);text-align:center;-moz-box-shadow:1px 1px 3px #333;-webkit-box-shadow:1px 1px 3px #333;box-shadow:1px 1px 3px #333;font-size:11px!important;font-family:'Lucida Grande','Arial',sans-serif!important;">
   <table style="border-collapse:collapse;margin:0;padding:0;width:100%;"><tbody><tr>
   <td style="padding:10px;vertical-align:top;min-width:110px;">
   <a href="/web/" title="Wayback Machine home page" style="background-color:transparent;border:none;"><img src="/static/images/toolbar/wayback-toolbar-logo.png" alt="Wayback Machine" width="110" height="39" border="0"/></a>
   </td>
   <td style="padding:0!important;text-align:center;vertical-align:top;width:100%;">

       <table style="border-collapse:collapse;margin:0 auto;padding:0;width:570px;"><tbody><tr>
       <td style="padding:3px 0;" colspan="2">
       <form target="_top" method="get" action="/web/form-submit.jsp" name="wmtb" id="wmtb" style="margin:0!important;padding:0!important;"><input type="text" name="url" id="wmtbURL" value="http://rubyquiz.com/quiz128.html" style="width:400px;font-size:11px;font-family:'Lucida Grande','Arial',sans-serif;" onfocus="javascript:this.focus();this.select();" /><input type="hidden" name="type" value="replay" /><input type="hidden" name="date" value="20120121184247" /><input type="submit" value="Go" style="font-size:11px;font-family:'Lucida Grande','Arial',sans-serif;margin-left:5px;" /><span id="wm_tb_options" style="display:block;"></span></form>
       </td>
       <td style="vertical-align:bottom;padding:5px 0 0 0!important;" rowspan="2">
           <table style="border-collapse:collapse;width:110px;color:#99a;font-family:'Helvetica','Lucida Grande','Arial',sans-serif;"><tbody>
			
           <!-- NEXT/PREV MONTH NAV AND MONTH INDICATOR -->
           <tr style="width:110px;height:16px;font-size:10px!important;">
           	<td style="padding-right:9px;font-size:11px!important;font-weight:bold;text-transform:uppercase;text-align:right;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20101127174000/http://rubyquiz.com/quiz128.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="27 Nov 2010"><strong>NOV</strong></a>
		                
               </td>
               <td id="displayMonthEl" style="background:#000;color:#ff0;font-size:11px!important;font-weight:bold;text-transform:uppercase;width:34px;height:15px;padding-top:1px;text-align:center;" title="You are here: 18:42:47 Jan 21, 2012">JAN</td>
				<td style="padding-left:9px;font-size:11px!important;font-weight:bold;text-transform:uppercase;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20120418100921/http://www.rubyquiz.com/quiz128.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="18 Apr 2012"><strong>APR</strong></a>
		                
               </td>
           </tr>

           <!-- NEXT/PREV CAPTURE NAV AND DAY OF MONTH INDICATOR -->
           <tr>
               <td style="padding-right:9px;white-space:nowrap;overflow:visible;text-align:right!important;vertical-align:middle!important;" nowrap="nowrap">
               
		                <a href="/web/20101127174000/http://rubyquiz.com/quiz128.html" title="17:40:00 Nov 27, 2010" style="background-color:transparent;border:none;"><img src="/static/images/toolbar/wm_tb_prv_on.png" alt="Previous capture" width="14" height="16" border="0" /></a>
		                
               </td>
               <td id="displayDayEl" style="background:#000;color:#ff0;width:34px;height:24px;padding:2px 0 0 0;text-align:center;font-size:24px;font-weight: bold;" title="You are here: 18:42:47 Jan 21, 2012">21</td>
				<td style="padding-left:9px;white-space:nowrap;overflow:visible;text-align:left!important;vertical-align:middle!important;" nowrap="nowrap">
               
		                <a href="/web/20120418100921/http://www.rubyquiz.com/quiz128.html" title="10:09:21 Apr 18, 2012" style="background-color:transparent;border:none;"><img src="/static/images/toolbar/wm_tb_nxt_on.png" alt="Next capture" width="14" height="16" border="0"/></a>
		                
			    </td>
           </tr>

           <!-- NEXT/PREV YEAR NAV AND YEAR INDICATOR -->
           <tr style="width:110px;height:13px;font-size:9px!important;">
				<td style="padding-right:9px;font-size:11px!important;font-weight: bold;text-align:right;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20101127174000/http://rubyquiz.com/quiz128.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="27 Nov 2010"><strong>2010</strong></a>
		                
               </td>
               <td id="displayYearEl" style="background:#000;color:#ff0;font-size:11px!important;font-weight: bold;padding-top:1px;width:34px;height:13px;text-align:center;" title="You are here: 18:42:47 Jan 21, 2012">2012</td>
				<td style="padding-left:9px;font-size:11px!important;font-weight: bold;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20130215052554/http://rubyquiz.com/quiz128.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="15 Feb 2013"><strong>2013</strong></a>
		                
				</td>
           </tr>
           </tbody></table>
       </td>

       </tr>
       <tr>
       <td style="vertical-align:middle;padding:0!important;">
           <a href="/web/20120121184247*/http://rubyquiz.com/quiz128.html" style="color:#33f;font-size:11px;font-weight:bold;background-color:transparent;border:none;" title="See a list of every capture for this URL"><strong>24 captures</strong></a>
           <div style="margin:0!important;padding:0!important;color:#666;font-size:9px;padding-top:2px!important;white-space:nowrap;" title="Timespan for captures of this URL">25 Jun 07 - 15 Feb 13</div>
       </td>
       <td style="padding:0!important;">
       <a style="position:relative; white-space:nowrap; width:450px;height:27px;" href="" id="wm-graph-anchor">
       <div id="wm-ipp-sparkline" style="position:relative; white-space:nowrap; width:450px;height:27px;background-color:#fff;cursor:pointer;border-right:1px solid #ccc;" title="Explore captures for this URL">
			<img id="sparklineImgId" style="position:absolute; z-index:9012; top:0px; left:0px;"
				onmouseover="showTrackers('inline');" 
				onmouseout="showTrackers('none');"
				onmousemove="trackMouseMove(event,this)"
				alt="sparklines"
				width="450"
				height="27"
				border="0"
				src="/web/jsp/graph.jsp?graphdata=450_27_1996:-1:000000000000_1997:-1:000000000000_1998:-1:000000000000_1999:-1:000000000000_2000:-1:000000000000_2001:-1:000000000000_2002:-1:000000000000_2003:-1:000000000000_2004:-1:000000000000_2005:-1:000000000000_2006:-1:000000000000_2007:-1:000001000000_2008:-1:000000000000_2009:-1:000000000000_2010:-1:000000000010_2011:-1:000000000000_2012:0:10018000a100_2013:-1:010000000000"></img>
			<img id="wbMouseTrackYearImg" 
				style="display:none; position:absolute; z-index:9010;"
				width="25" 
				height="27"
				border="0"
				src="/static/images/toolbar/transp-yellow-pixel.png"></img>
			<img id="wbMouseTrackMonthImg"
				style="display:none; position:absolute; z-index:9011; " 
				width="2"
				height="27" 
				border="0"
				src="/static/images/toolbar/transp-red-pixel.png"></img>
       </div>
		</a>

       </td>
       </tr></tbody></table>
   </td>
   <td style="text-align:right;padding:5px;width:65px;font-size:11px!important;">
       <a href="javascript:;" onclick="document.getElementById('wm-ipp').style.display='none';" style="display:block;padding-right:18px;background:url(/static/images/toolbar/wm_tb_close.png) no-repeat 100% 0;color:#33f;font-family:'Lucida Grande','Arial',sans-serif;margin-bottom:23px;background-color:transparent;border:none;" title="Close the toolbar">Close</a>
       <a href="http://faq.web.archive.org/" style="display:block;padding-right:18px;background:url(/static/images/toolbar/wm_tb_help.png) no-repeat 100% 0;color:#33f;font-family:'Lucida Grande','Arial',sans-serif;background-color:transparent;border:none;" title="Get some help using the Wayback Machine">Help</a>
   </td>
   </tr></tbody></table>

</div>
</div>
<script type="text/javascript">
 var wmDisclaimBanner = document.getElementById("wm-ipp");
 if(wmDisclaimBanner != null) {
   disclaimElement(wmDisclaimBanner);
 }
</script>
<!-- END WAYBACK TOOLBAR INSERT -->

	<div id="page">
		<div id="header"><span class="ruby">Ruby</span> <span class="quiz">Quiz</span></div>
		<div id="content">
			<span class="title">Verbal Arithmetic (#128)</span>
			<p>A famous set of computer problems involve verbal arithmetic.  In these problems, you are given equations of words like:</p>
			<p class="example">  send<br />+ more<br />------<br /> money</p>
			<p>or:</p>
			<p class="example">  forty<br />    ten<br />+   ten<br />-------<br />  sixty</p>
			<p>The goal is to find a single digit for each letter that makes the equation true.  Normal rules of number construction apply, so the first digit of a multi-digit number should be nonzero and each letter represents a different digit.</p>
			<p>This week's quiz is to build a program that reads in equations and outputs solutions.  You can decide how complex of an equation you want to support, with the examples above being the minimum implementation.</p>
			<p>Here's a solution you can test against:</p>
			<p class="example">$ ruby verbal_arithmetic.rb 'send+more=money'<br />s: 9<br />e: 5<br />n: 6<br />d: 7<br />m: 1<br />o: 0<br />r: 8<br />y: 2</p>
			<hr />
			<p><span class="title">Quiz Summary</span></p>
			<p>I'm always impressed by the creativity of the solutions, but I think this week stands out even more than usual.  I literally spent hours going through the solutions and learned some really great tricks from them.  I wish I could take you on the same tour of the code, but that would take this summary into the range of a full text book in length.</p>
			<p>Because I'm going to miss all of the following, let me point out some highlights for your own explorations:</p>
			<p class="example">* Though the brute-force solutions are slow, most of them handle any<br />  math equations Ruby can.  That is an interesting advantage.<br />* Andreas Launila sent in a fun preview of his Google Summer of Code<br />  project that looks to simplify many of these search problems we<br />  commonly use as quizzes.<br />* Glen's solution is a nifty metaprogramming solution that customizes<br />  itself to the equation entered.  It's lightning quick too.<br />* Morton Goldberg solved the quiz with some genetic programming and<br />  that code is still quite a bit zippier than a brute-force search.</p>
			<p>The solution I will show is from Eric I.  It has an interesting state machine design that tries to fail fast in an attempt to aggressively prune the search space.  It too finds solutions quite rapidly, though it only works for addition problems.</p>
			<p>Eric's code breaks the equation down into a small series of steps.  Instead of searching for a match for all numbers and then checking the result, this solution checks as many little sub-criteria as possible.  Does just this column add up correctly, given what we know at this point?  Is this digit a zero, because it starts a term somewhere else?</p>
			<p>These smaller tests lead to failures that allow the search to skip large groups in the set of possible solutions. For example, if S can't be seven in just one column, it's impossible to have any scenario where S is seven and all such attempts can be safely skipped.  That allows the code to zoom in on a correct answer faster.</p>
			<p>Now that we understand the logic, let's start tackling the code:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    require <span class="string">'set'</span><br /><br />    <span class="comment"># State represents the stage of a partially solved word equation.  It</span><br />    <span class="comment"># keeps track of what digits letters map to, which digits have not yet</span><br />    <span class="comment"># been assigned to letters, and the results of the last summed column,</span><br />    <span class="comment"># including the resulting digit and any carry if there is one.</span><br />    <span class="keyword">class</span> State<br />      attr_accessor :sum, :carry<br />      attr_reader :letters<br /><br />      <span class="keyword">def</span> initialize()<br />        <span class="variable">@available_digits</span> = Set.new(0..9)<br />        <span class="variable">@letters</span> = Hash.new<br />        <span class="variable">@sum</span>, <span class="variable">@carry</span> = 0, 0<br />      <span class="keyword">end</span><br /><br />      <span class="comment"># Return digit for letter.</span><br />      <span class="keyword">def</span> [](letter)<br />        <span class="variable">@letters</span>[letter]<br />      <span class="keyword">end</span><br /><br />      <span class="comment"># The the digit for a letter.</span><br />      <span class="keyword">def</span> []=(letter, digit)<br />        <span class="comment"># if the letter is currently assigned, return its digit to the</span><br />        <span class="comment"># available set</span><br />        <span class="variable">@available_digits</span>.add <span class="variable">@letters</span>[letter] <span class="keyword">if</span> <span class="variable">@letters</span>[letter]<br /><br />        <span class="variable">@letters</span>[letter] = digit<br />        <span class="variable">@available_digits</span>.delete digit<br />      <span class="keyword">end</span><br /><br />      <span class="comment"># Clear the digit for a letter.</span><br />      <span class="keyword">def</span> clear(letter)<br />        <span class="variable">@available_digits</span>.add <span class="variable">@letters</span>[letter]<br />        <span class="variable">@letters</span>[letter] = <span class="keyword">nil</span><br />      <span class="keyword">end</span><br /><br />      <span class="comment"># Return the available digits as an array copied from the set.</span><br />      <span class="keyword">def</span> available_digits<br />        <span class="variable">@available_digits</span>.to_a<br />      <span class="keyword">end</span><br /><br />      <span class="comment"># Tests whether a given digit is still available.</span><br />      <span class="keyword">def</span> available?(digit)<br />        <span class="variable">@available_digits</span>.member? digit<br />      <span class="keyword">end</span><br /><br />      <span class="comment"># Receives the total for a column and keeps track of it as the</span><br />      <span class="comment"># summed-to digit and any carry.</span><br />      <span class="keyword">def</span> column_total=(total)<br />        <span class="variable">@sum</span> = total % 10<br />        <span class="variable">@carry</span> = total / 10<br />      <span class="keyword">end</span><br />    <span class="keyword">end</span><br /><br />    <span class="comment"># ...</span><br /><br /></div></div>
			<p>This State object tracks progress through the equation, which will be solved column by column.  It has operations to track what each letter is currently assigned to, assign letters as they are determined, examine which digits have and have not been used, and track the sum of the last column plus any value carried over to the next column.  There's nothing too tricky in this data structure code.</p>
			<p>What we need to go with this, is an algorithm that drives this State object to a solution.  That code begins here:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="comment"># ...</span><br /><br />    <span class="comment"># Step is an "abstract" base level class from which all the "concrete"</span><br />    <span class="comment"># steps can be derived.  It simply handles the storage of the next</span><br />    <span class="comment"># step in the sequence.  Subclasses should provide 1) a to_s method to</span><br />    <span class="comment"># describe the step being performed and 2) a perform method to</span><br />    <span class="comment"># actually perform the step.</span><br />    <span class="keyword">class</span> Step<br />      attr_writer :next_step<br />    <span class="keyword">end</span><br /><br />    <span class="comment"># ...</span><br /><br /></div></div>
			<p>This base Step is about as simple as things get.  I merely provides a means of storing the next step in the process.</p>
			<p>Note that this class's abstract status and the required implementation for subclasses are all handled through the documentation.  That's perfectly reasonable in a dynamic language like Ruby where we can count on duck typing to resolve to the proper methods when the search is actually being performed.</p>
			<p>Let's advance to a concrete implementation of the Step class:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="comment"># ...</span><br /><br />    <span class="comment"># This step tries assigning each available digit to a given letter and</span><br />    <span class="comment"># continuing from there.</span><br />    <span class="keyword">class</span> ChooseStep &lt; Step<br />      <span class="keyword">def</span> initialize(letter)<br />        <span class="variable">@letter</span> = letter<br />      <span class="keyword">end</span><br /><br />      <span class="keyword">def</span> to_s<br />        <span class="string">"Choose a digit for \"#{@letter}\"."</span><br />      <span class="keyword">end</span><br /><br />      <span class="keyword">def</span> perform(state)<br />        state.available_digits.each <span class="keyword">do</span> |v|<br />          state[<span class="variable">@letter</span>] = v<br />          <span class="variable">@next_step</span>.perform(state)<br />        <span class="keyword">end</span><br />        state.clear(<span class="variable">@letter</span>)<br />      <span class="keyword">end</span><br />    <span class="keyword">end</span><br /><br />    <span class="comment"># ...</span><br /><br /></div></div>
			<p>This ChooseStep handles the digit guessing.  It is created for some letter and when perform() is triggered, it will try each unused in turn digit in that position.  After a new guess is set, the ChooseStep just hands off to a later step to verify that the current guess works.</p>
			<p>Here's another Step subclass:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="comment"># ...</span><br /><br />    <span class="comment"># This step sums up the given letters and changes to state to reflect</span><br />    <span class="comment"># the sum.  Because we may have to backtrack, it stores the previous</span><br />    <span class="comment"># saved sum and carry for later restoration.</span><br />    <span class="keyword">class</span> SumColumnStep &lt; Step<br />      <span class="keyword">def</span> initialize(letters)<br />        <span class="variable">@letters</span> = letters<br />      <span class="keyword">end</span><br /><br />      <span class="keyword">def</span> to_s<br />        list = <span class="variable">@letters</span>.map { |l| <span class="string">"\"#{l}\""</span> }.join(<span class="string">', '</span>)<br />        <span class="string">"Sum the column using letters #{list} (and include carry)."</span><br />      <span class="keyword">end</span><br /><br />      <span class="keyword">def</span> perform(state)<br />        <span class="comment"># save sum and carry</span><br />        saved_sum, saved_carry = state.sum, state.carry<br /><br />        state.column_total =<br />          state.carry +<br />          <span class="variable">@letters</span>.inject(0) { |sum, letter| sum + state[letter] }<br />        <span class="variable">@next_step</span>.perform(state)<br /><br />        <span class="comment"># restore sum and carry</span><br />        state.sum, state.carry = saved_sum, saved_carry<br />      <span class="keyword">end</span><br />    <span class="keyword">end</span><br /><br />    <span class="comment"># ...</span><br /><br /></div></div>
			<p>This SumColumnStep will be added whenever guesses had been made for an entire column.  It's job is to add up that column and update the State with this new total.  You can see that it must save old State values and restore them when backtracking.</p>
			<p>Once we know a column total, we can use that to set a letter from the solution side of the equation:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="comment"># ...</span><br /><br />    <span class="comment"># This step determines the digit for a letter given the last column</span><br />    <span class="comment"># summed.  If the digit is not available, then we cannot continue.</span><br />    <span class="keyword">class</span> AssignOnSumStep &lt; Step<br />      <span class="keyword">def</span> initialize(letter)<br />        <span class="variable">@letter</span> = letter<br />      <span class="keyword">end</span><br /><br />      <span class="keyword">def</span> to_s<br />        <span class="string">"Set the digit for \"#{@letter}\" based on last column summed."</span><br />      <span class="keyword">end</span><br /><br />      <span class="keyword">def</span> perform(state)<br />        <span class="keyword">if</span> state.available? state.sum<br />          state[<span class="variable">@letter</span>] = state.sum<br />          <span class="variable">@next_step</span>.perform(state)<br />          state.clear(<span class="variable">@letter</span>)<br />        <span class="keyword">end</span><br />      <span class="keyword">end</span><br />    <span class="keyword">end</span><br /><br />    <span class="comment"># ...</span><br /><br /></div></div>
			<p>This AssignOnSumStep is added for letters in the solution of the equation.  It will set the value of that letter to the calculated sum of the column, provided that is a legal non-duplicate digit choice.</p>
			<p>When we have assigned that letter, we need to verify that the whole column makes sense mathematically:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="comment"># ...</span><br /><br />    <span class="comment"># This step will occur after a column is summed, and the result must</span><br />    <span class="comment"># match a letter that's already been assigned.</span><br />    <span class="keyword">class</span> CheckOnSumStep &lt; Step<br />      <span class="keyword">def</span> initialize(letter)<br />        <span class="variable">@letter</span> = letter<br />      <span class="keyword">end</span><br /><br />      <span class="keyword">def</span> to_s<br />        <span class="string">"Verify that last column summed matches current "</span> +<br />          <span class="string">"digit for \"#{@letter}\"."</span><br />      <span class="keyword">end</span><br /><br />      <span class="keyword">def</span> perform(state)<br />        <span class="variable">@next_step</span>.perform(state) <span class="keyword">if</span> state[<span class="variable">@letter</span>] == state.sum<br />      <span class="keyword">end</span><br />    <span class="keyword">end</span><br /><br />    <span class="comment"># ...</span><br /><br /></div></div>
			<p>Now, if we did all the guessing, summing, and assigning everything probably adds up.  But as we continue through the equation, some numbers will already be filled in.  Sums created using those may not balance with the total digit.  This CheckOnSumStep watches for such a case.</p>
			<p>If the sum doesn't check out, this class causes backtracking.  Note that all it has to do is not forward to the following steps which will cause recursion to unwind the stack until it has another option.</p>
			<p>One last check can trim the search space further:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="comment"># ...</span><br /><br />    <span class="comment"># This step will occur after a letter is assigned to a digit if the</span><br />    <span class="comment"># letter is not allowed to be a zero, because one or more terms begins</span><br />    <span class="comment"># with that letter.</span><br />    <span class="keyword">class</span> CheckNotZeroStep &lt; Step<br />      <span class="keyword">def</span> initialize(letter)<br />        <span class="variable">@letter</span> = letter<br />      <span class="keyword">end</span><br /><br />      <span class="keyword">def</span> to_s<br />        <span class="string">"Verify that \"#{@letter}\" has not been assigned to zero."</span><br />      <span class="keyword">end</span><br /><br />      <span class="keyword">def</span> perform(state)<br />        <span class="variable">@next_step</span>.perform(state) <span class="keyword">unless</span> state[<span class="variable">@letter</span>] == 0<br />      <span class="keyword">end</span><br />    <span class="keyword">end</span><br /><br />    <span class="comment"># ...</span><br /><br /></div></div>
			<p>This CheckNotZeroStep is used to ensure that a leading letter in a term is non-zero.  Again, it fails to forward calls when this is not the case.</p>
			<p>One more step is needed to catch correct solutions:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="comment"># ...</span><br /><br />    <span class="comment"># This step represents finishing the equation.  The carry must be zero</span><br />    <span class="comment"># for the perform to have found an actual result, so check that and</span><br />    <span class="comment"># display a digit -&gt; letter conversion table and dispaly the equation</span><br />    <span class="comment"># with the digits substituted in for the letters.</span><br />    <span class="keyword">class</span> FinishStep &lt; Step<br />      <span class="keyword">def</span> initialize(equation)<br />        <span class="variable">@equation</span> = equation<br />      <span class="keyword">end</span><br /><br />      <span class="keyword">def</span> to_s<br />        <span class="string">"Display a solution (provided carry is zero)!"</span><br />      <span class="keyword">end</span><br /><br />      <span class="keyword">def</span> perform(state)<br />        <span class="comment"># we're supposedly done, so there can't be anything left in carry</span><br />        <span class="keyword">return</span> <span class="keyword">unless</span> state.carry == 0<br /><br />        <span class="comment"># display a letter to digit table on a single line</span><br />        table = state.letters.invert<br />        puts<br />        puts table.keys.sort.map { |k| <span class="string">"#{table[k]}=#{k}"</span> }.join(<span class="string">'    '</span>)<br /><br />        <span class="comment"># display the equation with digits substituted for the letters</span><br />        equation = <span class="variable">@equation</span>.dup<br />        state.letters.each { |k, v| equation.gsub!(k, v.to_s) }<br />        puts<br />        puts equation<br />      <span class="keyword">end</span><br />    <span class="keyword">end</span><br /><br />    <span class="comment"># ...</span><br /><br /></div></div>
			<p>This method first ensures that we are successful by validating that we have no remaining carry value.  If that's true, our equation balanced out.</p>
			<p>The rest of the work here is just in printing the found result.  Nothing tricky there.</p>
			<p>We're now ready to get into the application code:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="comment"># ...</span><br /><br />    <span class="comment"># Do a basic test for the command-line arguments validity.</span><br />    <span class="keyword">unless</span> ARGV[0] =~ Regexp.new(<span class="string">'^[a-z]+(\+[a-z]+)*=[a-z]+$'</span>)<br />      STDERR.puts <span class="string">"invalid argument"</span><br />      exit 1<br />    <span class="keyword">end</span><br /><br />    <span class="comment"># Split the command-line argument into terms and figure out how many</span><br />    <span class="comment"># columns we're dealing with.</span><br />    terms = ARGV[0].split(<span class="string">/\+|=/</span>)<br />    column_count = terms.map { |e| e.size }.max<br /><br />    <span class="comment"># Build the display of the equation a line at a time.  The line</span><br />    <span class="comment"># containing the final term of the sum has to have room for the plus</span><br />    <span class="comment"># sign.</span><br />    display_columns = [column_count, terms[-2].size + 1].max<br />    display  = []<br />    terms[0..-3].each <span class="keyword">do</span> |term|<br />      display &lt;&lt; term.rjust(display_columns)<br />    <span class="keyword">end</span><br />    display &lt;&lt; <span class="string">"+"</span> + terms[-2].rjust(display_columns - 1)<br />    display &lt;&lt; <span class="string">"-"</span> * display_columns<br />    display &lt;&lt; terms[-1].rjust(display_columns)<br />    display = display.join(<span class="string">"\n"</span>)<br />    puts display<br /><br />    <span class="comment"># AssignOnSumStep which letters cannot be zero since they're the first</span><br />    <span class="comment"># letter of a term.</span><br />    nonzero_letters = Set.new<br />    terms.each { |e| nonzero_letters.add(e[0, 1]) }<br /><br />    <span class="comment"># A place to keep track of which letters have so-far been assigned.</span><br />    chosen_letters = Set.new<br /><br />    <span class="comment"># ...</span><br /><br /></div></div>
			<p>This code validates the input and breaks it into terms.  After that, the big chunk of code here displays the equation in a pretty format, like the examples from the quiz description.</p>
			<p>The rest of the code begins to divide up the input as needed to build the proper steps.  The first tactic is to locate and letters that must be nonzero, because they start a term.  A set is also prepared to hold letters that have be given values at any point in the process.</p>
			<p>Here's the heart of the process code:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="comment"># ...</span><br /><br />    <span class="comment"># Build up the steps needed to solve the equation.</span><br />    steps = []<br />    column_count.times <span class="keyword">do</span> |column|<br />      index = -column - 1<br />      letters = []                 <span class="comment"># letters for this column to be added</span><br /><br />      terms[0..-2].each <span class="keyword">do</span> |term|  <span class="comment"># for each term that's being added...</span><br />        letter = term[index, 1]<br />        <span class="keyword">next</span> <span class="keyword">if</span> letter.nil?        <span class="comment"># skip term if no letter in column</span><br />        letters &lt;&lt; letter          <span class="comment"># note that this letter is part of sum</span><br /><br />        <span class="comment"># if the letter does not have a digit, create a ChooseStep</span><br />        <span class="keyword">unless</span> chosen_letters.member? letter<br />          steps &lt;&lt; ChooseStep.new(letter)<br />          chosen_letters.add(letter)<br />          steps &lt;&lt; CheckNotZeroStep.new(letter) <span class="keyword">if</span><br />            nonzero_letters.member? letter<br />        <span class="keyword">end</span><br />      <span class="keyword">end</span><br /><br />      <span class="comment"># create a SumColumnStep for the column</span><br />      steps &lt;&lt; SumColumnStep.new(letters)<br /><br />      summed_letter = terms[-1][index, 1]  <span class="comment"># the letter being summed to</span><br /><br />      <span class="comment"># check whether the summed to letter should already have a digit</span><br />      <span class="keyword">if</span> chosen_letters.member? summed_letter<br />        <span class="comment"># should already have a digit, check that summed digit matches it</span><br />        steps &lt;&lt; CheckOnSumStep.new(summed_letter)<br />      <span class="keyword">else</span><br />        <span class="comment"># doesn't already have digit, so create a AssignOnSumStep for</span><br />        <span class="comment"># letter</span><br />        steps &lt;&lt; AssignOnSumStep.new(summed_letter)<br />        chosen_letters.add(summed_letter)<br /><br />        <span class="comment"># check whether this letter cannot be zero and if so add a</span><br />        <span class="comment"># CheckNotZeroStep</span><br />        steps &lt;&lt; CheckNotZeroStep.new(summed_letter) <span class="keyword">if</span><br />          nonzero_letters.member? summed_letter<br />      <span class="keyword">end</span><br />    <span class="keyword">end</span><br /><br />    <span class="comment"># ...</span><br /><br /></div></div>
			<p>This code breaks down the provided equation into the steps we've seen defined up to this point.  Though it's a fair bit of code, it's pretty straightforward and very well commented.  In short:</p>
			<p class="example">1.  Values are selected for the numbers in each column as needed.<br />2.  Columns are summed<br />3.  Sums are assigned and or validated as needed.</p>
			<p>With the setup complete, here's the code that kicks the solver into action:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="comment"># ...</span><br /><br />    <span class="comment"># should be done, so add a FinishStep</span><br />    steps &lt;&lt; FinishStep.new(display)<br /><br />    <span class="comment"># print out all the steps</span><br />    <span class="comment"># steps.each_with_index { |step, i| puts "#{i + 1}. #{step}" }</span><br /><br />    <span class="comment"># let each step know about the one that follows it.</span><br />    steps.each_with_index { |step, i| step.next_step = steps[i + 1] }<br /><br />    <span class="comment"># start performing with the first step.</span><br />    steps.first.perform(State.new)<br /><br /></div></div>
			<p>Here the FinishStep is added, all steps are linked, and the perform() call is made to get the ball rolling.  You can uncomment the second chunk of code to have a human-readable explanation of the steps added to the output.</p>
			<p>My thanks to all the super clever solvers who tackled this problem.  I was blown away with the creativity.</p>
			<p>Tomorrow we will put Ruby Quiz to work helping some friends of ours...</p>
		</div>
		<div id="logo"><img src="/web/20120121184247im_/http://rubyquiz.com/images/ruby_quiz_logo.jpg" alt="" width="157" height="150" /></div>
		<div id="links">
			<span class="title">Quiz Solutions</span>
			<ol>
				<li><a href="/web/20120121184247/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/255948">Raf Coremans</a></li>
				<li><a href="/web/20120121184247/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/255952">Aureliano Calvo</a></li>
				<li><a href="/web/20120121184247/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/255959">Holger Mack</a></li>
				<li><a href="/web/20120121184247/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/255960">Jesse Merriman</a></li>
				<li><a href="/web/20120121184247/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/255970">Eric I.</a></li>
				<li><a href="/web/20120121184247/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/255997">Justin Ethier</a></li>
				<li><a href="/web/20120121184247/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/256029">Glen F. Pankow</a></li>
				<li><a href="/web/20120121184247/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/256039">James Koppel</a></li>
				<li><a href="/web/20120121184247/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/256040">Gwendal</a></li>
				<li><a href="/web/20120121184247/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/256047">Morton Goldberg</a></li>
				<li><a href="/web/20120121184247/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/256120">James Edward Gray II</a></li>
				<li><a href="/web/20120121184247/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/256145">Morton Goldberg (2)</a></li>
				<li><a href="/web/20120121184247/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/256221">Andreas Launila</a></li>
				<li><a href="/web/20120121184247/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/256272">Bob Showalter</a></li>
			</ol>
			<p><a href="/web/20120121184247/http://rubyquiz.com/quiz128_sols.zip">Download Solutions</a></p>
			<p><a href="/web/20120121184247/http://rubyquiz.com/index.html">Back to Quiz Listing</a></p>
		</div>
		<div id="footer">&nbsp;</div>
	</div>
</body>
</html>





<!--
     FILE ARCHIVED ON 18:42:47 Jan 21, 2012 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 13:10:51 Jun 5, 2013.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
