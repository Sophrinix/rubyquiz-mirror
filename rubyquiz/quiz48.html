<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>


<!-- Start Wayback Rewrite JS Include -->
<script type="text/javascript" src="/static/js/jwplayer/jwplayer.js" ></script>
<script type="text/javascript" src="/static/js/video-embed-rewriter.js"></script>
<script type="text/javascript">
function initYTVideo(id)
{
	_wmVideos_.init("/web/", id);
}
</script>
<!-- End Wayback Rewrite JS Include -->

	<title>Ruby Quiz - Math Captcha (#48)</title>
	<link rel="stylesheet" type="text/css" href="/web/20120121215607cs_/http://rubyquiz.com/quiz.css" />
	<link rel="stylesheet" type="text/css" href="/web/20120121215607cs_/http://rubyquiz.com/print.css" media="print" />
</head><body>
<!-- BEGIN WAYBACK TOOLBAR INSERT -->

<script type="text/javascript" src="/static/js/disclaim-element.js" ></script>
<script type="text/javascript" src="/static/js/graph-calc.js" ></script>
<script type="text/javascript" src="/static/jflot/jquery.min.js" ></script>
<script type="text/javascript">
//<![CDATA[
var firstDate = 820454400000;
var lastDate = 1388534399999;
var wbPrefix = "/web/";
var wbCurrentUrl = "http:\/\/rubyquiz.com\/quiz48.html";

var curYear = -1;
var curMonth = -1;
var yearCount = 18;
var firstYear = 1996;
var imgWidth = 450;
var yearImgWidth = 25;
var monthImgWidth = 2;
var trackerVal = "none";
var displayDay = "21";
var displayMonth = "Jan";
var displayYear = "2012";
var prettyMonths = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

function showTrackers(val) {
	if(val == trackerVal) {
		return;
	}
	if(val == "inline") {
		document.getElementById("displayYearEl").style.color = "#ec008c";
		document.getElementById("displayMonthEl").style.color = "#ec008c";
		document.getElementById("displayDayEl").style.color = "#ec008c";		
	} else {
		document.getElementById("displayYearEl").innerHTML = displayYear;
		document.getElementById("displayYearEl").style.color = "#ff0";
		document.getElementById("displayMonthEl").innerHTML = displayMonth;
		document.getElementById("displayMonthEl").style.color = "#ff0";
		document.getElementById("displayDayEl").innerHTML = displayDay;
		document.getElementById("displayDayEl").style.color = "#ff0";
	}
   document.getElementById("wbMouseTrackYearImg").style.display = val;
   document.getElementById("wbMouseTrackMonthImg").style.display = val;
   trackerVal = val;
}
function getElementX2(obj) {
	var thing = jQuery(obj);
	if((thing == undefined) 
			|| (typeof thing == "undefined") 
			|| (typeof thing.offset == "undefined")) {
		return getElementX(obj);
	}
	return Math.round(thing.offset().left);
}
function trackMouseMove(event,element) {

   var eventX = getEventX(event);
   var elementX = getElementX2(element);
   var xOff = eventX - elementX;
	if(xOff < 0) {
		xOff = 0;
	} else if(xOff > imgWidth) {
		xOff = imgWidth;
	}
   var monthOff = xOff % yearImgWidth;

   var year = Math.floor(xOff / yearImgWidth);
	var yearStart = year * yearImgWidth;
   var monthOfYear = Math.floor(monthOff / monthImgWidth);
   if(monthOfYear > 11) {
       monthOfYear = 11;
   }
   // 1 extra border pixel at the left edge of the year:
   var month = (year * 12) + monthOfYear;
   var day = 1;
	if(monthOff % 2 == 1) {
		day = 15;
	}
	var dateString = 
		zeroPad(year + firstYear) + 
		zeroPad(monthOfYear+1,2) +
		zeroPad(day,2) + "000000";

	var monthString = prettyMonths[monthOfYear];
	document.getElementById("displayYearEl").innerHTML = year + 1996;
	document.getElementById("displayMonthEl").innerHTML = monthString;
	// looks too jarring when it changes..
	//document.getElementById("displayDayEl").innerHTML = zeroPad(day,2);

	var url = wbPrefix + dateString + '/' +  wbCurrentUrl;
	document.getElementById('wm-graph-anchor').href = url;

   //document.getElementById("wmtbURL").value="evX("+eventX+") elX("+elementX+") xO("+xOff+") y("+year+") m("+month+") monthOff("+monthOff+") DS("+dateString+") Moy("+monthOfYear+") ms("+monthString+")";
   if(curYear != year) {
       var yrOff = year * yearImgWidth;
       document.getElementById("wbMouseTrackYearImg").style.left = yrOff + "px";
       curYear = year;
   }
   if(curMonth != month) {
       var mtOff = year + (month * monthImgWidth) + 1;
       document.getElementById("wbMouseTrackMonthImg").style.left = mtOff + "px";
       curMonth = month;
   }
}
//]]>
</script>

<style type="text/css">body{margin-top:0!important;padding-top:0!important;min-width:800px!important;}#wm-ipp a:hover{text-decoration:underline!important;}</style>
<div id="wm-ipp" style="display:none; position:relative;padding:0 5px;min-height:70px;min-width:800px; z-index:9000;">
<div id="wm-ipp-inside" style="position:fixed;padding:0!important;margin:0!important;width:97%;min-width:780px;border:5px solid #000;border-top:none;background-image:url(/static/images/toolbar/wm_tb_bk_trns.png);text-align:center;-moz-box-shadow:1px 1px 3px #333;-webkit-box-shadow:1px 1px 3px #333;box-shadow:1px 1px 3px #333;font-size:11px!important;font-family:'Lucida Grande','Arial',sans-serif!important;">
   <table style="border-collapse:collapse;margin:0;padding:0;width:100%;"><tbody><tr>
   <td style="padding:10px;vertical-align:top;min-width:110px;">
   <a href="/web/" title="Wayback Machine home page" style="background-color:transparent;border:none;"><img src="/static/images/toolbar/wayback-toolbar-logo.png" alt="Wayback Machine" width="110" height="39" border="0"/></a>
   </td>
   <td style="padding:0!important;text-align:center;vertical-align:top;width:100%;">

       <table style="border-collapse:collapse;margin:0 auto;padding:0;width:570px;"><tbody><tr>
       <td style="padding:3px 0;" colspan="2">
       <form target="_top" method="get" action="/web/form-submit.jsp" name="wmtb" id="wmtb" style="margin:0!important;padding:0!important;"><input type="text" name="url" id="wmtbURL" value="http://rubyquiz.com/quiz48.html" style="width:400px;font-size:11px;font-family:'Lucida Grande','Arial',sans-serif;" onfocus="javascript:this.focus();this.select();" /><input type="hidden" name="type" value="replay" /><input type="hidden" name="date" value="20120121215607" /><input type="submit" value="Go" style="font-size:11px;font-family:'Lucida Grande','Arial',sans-serif;margin-left:5px;" /><span id="wm_tb_options" style="display:block;"></span></form>
       </td>
       <td style="vertical-align:bottom;padding:5px 0 0 0!important;" rowspan="2">
           <table style="border-collapse:collapse;width:110px;color:#99a;font-family:'Helvetica','Lucida Grande','Arial',sans-serif;"><tbody>
			
           <!-- NEXT/PREV MONTH NAV AND MONTH INDICATOR -->
           <tr style="width:110px;height:16px;font-size:10px!important;">
           	<td style="padding-right:9px;font-size:11px!important;font-weight:bold;text-transform:uppercase;text-align:right;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20110821162350/http://www.rubyquiz.com/quiz48.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="21 Aug 2011"><strong>AUG</strong></a>
		                
               </td>
               <td id="displayMonthEl" style="background:#000;color:#ff0;font-size:11px!important;font-weight:bold;text-transform:uppercase;width:34px;height:15px;padding-top:1px;text-align:center;" title="You are here: 21:56:07 Jan 21, 2012">JAN</td>
				<td style="padding-left:9px;font-size:11px!important;font-weight:bold;text-transform:uppercase;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20120418135450/http://www.rubyquiz.com/quiz48.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="18 Apr 2012"><strong>APR</strong></a>
		                
               </td>
           </tr>

           <!-- NEXT/PREV CAPTURE NAV AND DAY OF MONTH INDICATOR -->
           <tr>
               <td style="padding-right:9px;white-space:nowrap;overflow:visible;text-align:right!important;vertical-align:middle!important;" nowrap="nowrap">
               
		                <a href="/web/20110821162350/http://www.rubyquiz.com/quiz48.html" title="16:23:50 Aug 21, 2011" style="background-color:transparent;border:none;"><img src="/static/images/toolbar/wm_tb_prv_on.png" alt="Previous capture" width="14" height="16" border="0" /></a>
		                
               </td>
               <td id="displayDayEl" style="background:#000;color:#ff0;width:34px;height:24px;padding:2px 0 0 0;text-align:center;font-size:24px;font-weight: bold;" title="You are here: 21:56:07 Jan 21, 2012">21</td>
				<td style="padding-left:9px;white-space:nowrap;overflow:visible;text-align:left!important;vertical-align:middle!important;" nowrap="nowrap">
               
		                <a href="/web/20120122032634/http://rubyquiz.com/quiz48.html" title="3:26:34 Jan 22, 2012" style="background-color:transparent;border:none;"><img src="/static/images/toolbar/wm_tb_nxt_on.png" alt="Next capture" width="14" height="16" border="0"/></a>
		                
			    </td>
           </tr>

           <!-- NEXT/PREV YEAR NAV AND YEAR INDICATOR -->
           <tr style="width:110px;height:13px;font-size:9px!important;">
				<td style="padding-right:9px;font-size:11px!important;font-weight: bold;text-align:right;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20101127180154/http://rubyquiz.com/quiz48.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="27 Nov 2010"><strong>2010</strong></a>
		                
               </td>
               <td id="displayYearEl" style="background:#000;color:#ff0;font-size:11px!important;font-weight: bold;padding-top:1px;width:34px;height:13px;text-align:center;" title="You are here: 21:56:07 Jan 21, 2012">2012</td>
				<td style="padding-left:9px;font-size:11px!important;font-weight: bold;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20130128202331/http://rubyquiz.com/quiz48.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="28 Jan 2013"><strong>2013</strong></a>
		                
				</td>
           </tr>
           </tbody></table>
       </td>

       </tr>
       <tr>
       <td style="vertical-align:middle;padding:0!important;">
           <a href="/web/20120121215607*/http://rubyquiz.com/quiz48.html" style="color:#33f;font-size:11px;font-weight:bold;background-color:transparent;border:none;" title="See a list of every capture for this URL"><strong>37 captures</strong></a>
           <div style="margin:0!important;padding:0!important;color:#666;font-size:9px;padding-top:2px!important;white-space:nowrap;" title="Timespan for captures of this URL">16 May 06 - 28 Jan 13</div>
       </td>
       <td style="padding:0!important;">
       <a style="position:relative; white-space:nowrap; width:450px;height:27px;" href="" id="wm-graph-anchor">
       <div id="wm-ipp-sparkline" style="position:relative; white-space:nowrap; width:450px;height:27px;background-color:#fff;cursor:pointer;border-right:1px solid #ccc;" title="Explore captures for this URL">
			<img id="sparklineImgId" style="position:absolute; z-index:9012; top:0px; left:0px;"
				onmouseover="showTrackers('inline');" 
				onmouseout="showTrackers('none');"
				onmousemove="trackMouseMove(event,this)"
				alt="sparklines"
				width="450"
				height="27"
				border="0"
				src="/web/jsp/graph.jsp?graphdata=450_27_1996:-1:000000000000_1997:-1:000000000000_1998:-1:000000000000_1999:-1:000000000000_2000:-1:000000000000_2001:-1:000000000000_2002:-1:000000000000_2003:-1:000000000000_2004:-1:000000000000_2005:-1:000000000000_2006:-1:000010000100_2007:-1:000100100000_2008:-1:000020000000_2009:-1:000000000000_2010:-1:100000000010_2011:-1:000000010000_2012:0:3001c000a100_2013:-1:100000000000"></img>
			<img id="wbMouseTrackYearImg" 
				style="display:none; position:absolute; z-index:9010;"
				width="25" 
				height="27"
				border="0"
				src="/static/images/toolbar/transp-yellow-pixel.png"></img>
			<img id="wbMouseTrackMonthImg"
				style="display:none; position:absolute; z-index:9011; " 
				width="2"
				height="27" 
				border="0"
				src="/static/images/toolbar/transp-red-pixel.png"></img>
       </div>
		</a>

       </td>
       </tr></tbody></table>
   </td>
   <td style="text-align:right;padding:5px;width:65px;font-size:11px!important;">
       <a href="javascript:;" onclick="document.getElementById('wm-ipp').style.display='none';" style="display:block;padding-right:18px;background:url(/static/images/toolbar/wm_tb_close.png) no-repeat 100% 0;color:#33f;font-family:'Lucida Grande','Arial',sans-serif;margin-bottom:23px;background-color:transparent;border:none;" title="Close the toolbar">Close</a>
       <a href="http://faq.web.archive.org/" style="display:block;padding-right:18px;background:url(/static/images/toolbar/wm_tb_help.png) no-repeat 100% 0;color:#33f;font-family:'Lucida Grande','Arial',sans-serif;background-color:transparent;border:none;" title="Get some help using the Wayback Machine">Help</a>
   </td>
   </tr></tbody></table>

</div>
</div>
<script type="text/javascript">
 var wmDisclaimBanner = document.getElementById("wm-ipp");
 if(wmDisclaimBanner != null) {
   disclaimElement(wmDisclaimBanner);
 }
</script>
<!-- END WAYBACK TOOLBAR INSERT -->

	<div id="page">
		<div id="header"><span class="ruby">Ruby</span> <span class="quiz">Quiz</span></div>
		<div id="content">
			<span class="title">Math Captcha (#48)</span>
			<p>by Gavin Kistner</p>
			<p><b>Overview</b></p>
			<p class="example">"What is fifty times 'a', if 'a' is three?" #=&gt; 150</p>
			<p>Write a Captcha system that uses english-based math questions to distinguish humans from bots.</p>
			<p><b>Background and Details</b></p>
			<p>A 'captcha' is an automated way for a computer (usually a web server) to try to weed out bots, which don't have the 'intelligence' to answer a question that's fairly straightforward for a human. Captcha is an acronym for "Completely Automated Public Turing-test to tell Computers and Humans Apart"</p>
			<p>The most common form of captcha is an image that has been munged in such a way that it's supposed to be very hard for a computer to tell you what it says, but easy for a human. Recent studies (or at least articles) claim that it's proven quite possible to write OCR software that determines the right answer a large percentage of the time. Although image-based captchas can be improved (for example, by placing multiple colored words and asking the user to identify the 'cinnamon' word), they still have the fatal flaw of being inaccessible to the visually impaired.</p>
			<p>This quiz is to write a different kind of captcha system - one that asks the user questions in plain text. The trick is to use mathematics questions with a variety of forms and varying numbers, so that it should be difficult (though of course not impossible) to write a bot to parse them.</p>
			<p>For example, this questions of this form might be easy for a bot to parse:</p>
			<p class="example">"What is five plus two?"</p>
			<p>while this question should be substantially harder:</p>
			<p class="example">"How much is fifteen-hundred twenty-three, less the amount of non-thumbs on<br />one human hand?"</p>
			<p>A good balance between human comprehension, variety of question form, and ease of computation is an interesting challenge.</p>
			<p><b>The Rules</b></p>
			<p>Write a module that has two module methods: 'create_question' and 'check_answer'.</p>
			<p>The create_question method should return a hash with two specific keys:</p>
			<p class="example">p MathCaptcha.create_question<br />#=&gt; { :question =&gt; "Here is the string of the question", :answer_id =&gt; 17 }</p>
			<p>The check_answer method is passed a hash with two specific keys, and should return true if the supplied answer is correct, false if not.</p>
			<p class="example">p MathCaptcha.check_answer :answer =&gt; "Answer String", :answer_id =&gt; 17<br />#=&gt; false</p>
			<p><b>Extra Credit</b></p>
			<p><i>1)</i> Ensure that your library is easily extensible, making it easy for someone using your library to add new forms of question creation, and the answer that goes with each form.</p>
			<p><i>2)</i> For automated testing and non-ruby usage, it would be nice to provide your module with a command-line wrapper, with the following interface:</p>
			<p class="example">&gt; ruby math_captcha.rb<br />1424039 : What is the sum of the number of thumbs on a human and the number<br />of hooves on a horse?<br /><br />&gt; ruby math_captcha.rb --id 1424039 --answer 7<br />false<br /><br />&gt; ruby math_captcha.rb --id 1424039 --answer 6<br />true</p>
			<p><i>3)</i> Allow your 'create_question' method to take an integer difficulty argument. Low difficulties (0 being the lowest) represent trivial questions that an elementary school student might be able to answer, while higher difficulties range into algebra, trigonometry, calculus, linear algebra, and beyond. (It's up to you as to what the scale is.)</p>
			<p class="example">"Type the number that comes right before seventy-five."<br />"What is fifteen plus twelve minus six?"<br />"What is six x minus three i, if I said that i is two and x three?"<br />"What is two squared, cubed?"<br />"Is the cosine of zero one or zero?"<br />"What trigonometric function of an angle of a right triangle yields the<br />ratio of the adjacent side's length divided by the hypotenuse?"<br />"What is the derivative of 2x^2, when x is 3?"<br />"What is the dot product of the vectors [4 7] and [3 4]?"<br />"What is the cross product of the vectors [4 7] and [3 4]?"</p>
			<p><i>4)</i> Let your 'check_answer' method take a unique identifier (such as an IP address) along with the answer, and always return false for that identifier after a certain number of consecutive (or accumulated) failures have occurred.</p>
			<p><b>A Tip - Generating English Numerals</b></p>
			<p>Presumably parsing large numbers from english to computerese adds another stumbling block for any bot writer. ("5 + 2" is slightly easier than "five plus two" and a fair amount easier than "three-thousand-'n'-five twenty three plus five-oh-five".</p>
			<p>Ruby Quiz #25 has some nice code that you can appropriate for turning integers into english:  <a href="/web/20120121215607/http://www.rubyquiz.com/quiz25.html">http://www.rubyquiz.com/quiz25.html</a></p>
			<hr />
			<p><span class="title">Quiz Summary</span></p>
			<p>It's always great running the Ruby Quiz, because I quite literally learn something new every single week.  This week's big lesson:  Steal Glenn Parker's  code, whenever possible!</p>
			<p>Both Gavin and I "borrowed" Glenn's solution to Ruby Quiz #25 to help us convert digits to English words.  Thanks Glenn, you made us both look good.</p>
			<p>I'm going to show my solution below, mostly because it's shorter and I'm pretty lazy.  However, Gavin's code had some interesting things in it you really shouldn't miss.  So I'll talk about my favorite feature in that code a little first.</p>
			<p>I wasn't too keen on the extra credit idea of difficultly, because it sounded a little too subjective to me.  Neither Gavin or I really did that part, but Gavin did add categorization for the questions and I have to tell you that is one cool feature, both in idea and implementation.  Here's an explanation of how it works, from the author:</p>
			<p class="example">I created a framework where you categorize types of captchas in an<br />hierarchy, and you can ask for a specific type of captcha by using the<br />desired subclass.<br /><br />For example, in my code below, I have:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="keyword">class</span> Captcha::Zoology &lt; Captcha ... <span class="keyword">end</span><br />    <span class="keyword">class</span> Captcha::Math &lt; Captcha<br />       <span class="keyword">class</span> Basic &lt; Math ... <span class="keyword">end</span><br />       <span class="keyword">class</span> Algebra &lt; Math ... <span class="keyword">end</span><br />    <span class="keyword">end</span><br /><br /></div></div>
			<p class="example">This allows you to do:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    Captcha.create_question <span class="comment"># a question from any framework, while</span><br />    Captcha::Zoology.create_question <span class="comment"># only questions in this class</span><br />    Captcha::Math.create_question <span class="comment"># any question in Math or its subclasses</span><br />    Captcha::Math::Basic.create_question <span class="comment"># only Basic math questions</span><br /><br /></div></div>
			<p>Sounds clever, right?  I was far more impressed when I looked under the hood to find out how it is done.  It's really just a few simple methods doing the work:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="keyword">class</span> Captcha<br />      <span class="comment"># ...</span><br /><br />      <span class="comment"># Returns a hash with two values:</span><br />      <span class="comment"># _question_:: A string with the question that the user should answer</span><br />      <span class="comment"># _answer_id_:: A unique ID for this question that should be passed to</span><br />      <span class="comment">#               #check_answer or #get_answers</span><br />      <span class="keyword">def</span> <span class="keyword">self</span>.create_question<br />        question, answers = factories.random.call<br />        answer_id = AnswerStore.instance.store( answers )<br />        <span class="keyword">return</span> { :question =&gt; question, :answer_id =&gt; answer_id }<br />      <span class="keyword">end</span><br /><br />      <span class="comment"># ...</span><br /><br />      <span class="comment"># Add the block to my store of question factories</span><br />      <span class="keyword">def</span> <span class="keyword">self</span>.add_factory( &amp;block )<br />        ( <span class="variable">@factories</span> ||= [] ) &lt;&lt; block<br />      <span class="keyword">end</span><br /><br />      <span class="comment"># Keep track of the classes that inherit from me</span><br />      <span class="keyword">def</span> <span class="keyword">self</span>.inherited( subklass )<br />        ( <span class="variable">@subclasses</span> ||= [] ) &lt;&lt; subklass<br />      <span class="keyword">end</span><br /><br />      <span class="comment"># All the question factories in myself and subclasses</span><br />      <span class="keyword">def</span> <span class="keyword">self</span>.factories<br />        <span class="variable">@factories</span> ||= []<br />        <span class="variable">@subclasses</span> ||= []<br />        <span class="variable">@factories</span> + <span class="variable">@subclasses</span>.map{ |sub| sub.factories }.flatten<br />      <span class="keyword">end</span><br /><br />      <span class="comment"># ...</span><br />    <span class="keyword">end</span><br /><br /></div></div>
			<p>First notice the self.inherited() class method.  That's a hook Ruby calls whenever your class is subclassed.  This method just tracks all known subclasses, as you can see.</p>
			<p>The self.add_factory() method is used by subclasses to add "question factories" for the topic that class represents.  Again, these are just collected into an Array.</p>
			<p>The real magic is self.factories(), though it too is trivial.  When asked to return its factories, it returns its own and all the factories for subclasses.  All of that comes together in one more interface method.</p>
			<p>When user code asks for a question with self.create_question(), a call to self.factories() ensures that anything added by self.add_factory() can be selected in addition to any factories of known subclasses tracked by self.inherited().</p>
			<p>I just think that's too smooth.  Thanks for the lesson, Gavin!</p>
			<p>Alright, let's examine a complete example solution.  Here's the start of my code:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="comment">#!/usr/local/bin/ruby -w</span><br /><br />    require <span class="string">"erb"</span><br /><br />    <span class="comment"># Glenn Parker's code from Ruby Quiz 25...</span><br />    require <span class="string">"english_numerals"</span><br />    <span class="keyword">class</span> Integer<br />        alias_method :to_en, :to_english<br />    <span class="keyword">end</span><br /><br />    <span class="keyword">class</span> Array<br />        <span class="keyword">def</span> insert_at_nil( obj )<br />            <span class="keyword">if</span> i = index(<span class="keyword">nil</span>)<br />                <span class="keyword">self</span>[i] = obj<br />                i<br />            <span class="keyword">else</span><br />                <span class="keyword">self</span> &lt;&lt; obj<br />                size - 1<br />            <span class="keyword">end</span><br />        <span class="keyword">end</span><br />    <span class="keyword">end</span><br /><br />    <span class="comment"># ...</span><br /><br /></div></div>
			<p>Just a little setup work here.  I pull in ERb for question templates, load Glenn's Ruby Quiz #25 solution and add a shortcut to it, and finally add a method to Array for inserting an object at the first nil position and returning the index of where it ended up.</p>
			<p>Now we get to some captcha code:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="comment"># ...</span><br /><br />    <span class="keyword">module</span> MathCaptcha<br />        <span class="variable">@@captchas</span> = Array.new<br />        <span class="variable">@@answers</span>  = Array.new<br /><br />        <span class="keyword">def</span> <span class="keyword">self</span>.add_captcha( template, &amp;validator )<br />            <span class="variable">@@captchas</span> &lt;&lt; Array[template, validator]<br />        <span class="keyword">end</span><br /><br />        <span class="keyword">def</span> <span class="keyword">self</span>.create_question<br />            raise <span class="string">"No captchas loaded."</span> <span class="keyword">if</span> <span class="variable">@@captchas</span>.empty?<br /><br />            captcha = <span class="variable">@@captchas</span>[rand(<span class="variable">@@captchas</span>.size)]<br /><br />            args = Array.new<br />            <span class="keyword">class</span> &lt;&lt; args<br />                <span class="keyword">def</span> arg( value )<br />                    push(value)<br />                    value<br />                <span class="keyword">end</span><br /><br />                <span class="keyword">def</span> resolve( template )<br />                    ERB.new(template).result(binding)<br />                <span class="keyword">end</span><br />            <span class="keyword">end</span><br />            question = args.resolve(captcha.first)<br />            index    = <span class="variable">@@answers</span>.insert_at_nil(Array[captcha.first, *args])<br /><br />            Hash[:question  =&gt; question, :answer_id =&gt; index]<br />        <span class="keyword">end</span><br /><br />        <span class="comment"># ...</span><br /><br /></div></div>
			<p>The first method, self.add_captchas(), is my answer to the first extra credit.  My code reads a configuration file in which you can call this method as much as you want to prepare your captcha system.  You pass in two things:  An ERb template of the question and a block that will validate answers.</p>
			<p>Your template can embed whatever code is needed to produce a question.  Inside the template you have access to the magic arg() method, which returns whatever object is passed in, but ensures that that object will also be passed to the validation block along with the answer.  The point is that you can randomize whatever you like, and ensure that you have the pieces to validate answers for the resulting questions when the time comes.</p>
			<p>The block is passed the answer given and everything that was filtered through arg().  It is expected to return true or false, indicating if the answer is acceptable.</p>
			<p>The other method, self.create_question(), is what resolves the ERb template and tucks the answer details away for later use.  First, one of the added captchas is selected at random.  That template is then resolved in the context of a modified Array, with the previously mentioned arg() method.  The template and Array of arguments are then stored in the @@answers variable for later validation.  (We can't store the validator because it's a Proc and I serialize the answers.)  Finally, the question and answer id are returned.</p>
			<p>Here's the other half of the module:</p>
			<div class="code"><span class="type">ruby</span><div class="body">        <span class="comment"># ...</span><br /><br />        <span class="keyword">def</span> <span class="keyword">self</span>.check_answer( answer )<br />            raise <span class="string">"Answer id required."</span> <span class="keyword">unless</span> answer.include? :answer_id<br /><br />            template, *args = <span class="variable">@@answers</span>[answer[:answer_id]]<br />            raise <span class="string">"Answer not found."</span> <span class="keyword">if</span> template.nil?<br /><br />            validator = <span class="variable">@@captchas</span>.assoc(template).last<br />            raise <span class="string">"Unable to match captcha."</span> <span class="keyword">if</span> validator.nil?<br /><br />            <span class="keyword">if</span> validator[answer[:answer], *args]<br />                <span class="variable">@@answers</span>[answer[:answer_id]] = <span class="keyword">nil</span><br />                <span class="keyword">true</span><br />            <span class="keyword">else</span><br />                <span class="keyword">false</span><br />            <span class="keyword">end</span><br />        <span class="keyword">end</span><br /><br />        <span class="keyword">def</span> <span class="keyword">self</span>.load_answers( file )<br />            <span class="variable">@@answers</span> = File.open(file) { |answers| Marshal.load(answers) }<br />        <span class="keyword">end</span><br /><br />        <span class="keyword">def</span> <span class="keyword">self</span>.load_captchas( file )<br />            code = File.read(file)<br />            eval(code, binding)<br />        <span class="keyword">end</span><br /><br />        <span class="keyword">def</span> <span class="keyword">self</span>.save_answers( file )<br />            File.open(file, <span class="string">"w"</span>) { |answers| Marshal.dump(<span class="variable">@@answers</span>, answers) }<br />        <span class="keyword">end</span><br />    <span class="keyword">end</span><br /><br />    <span class="comment"># ...</span><br /><br /></div></div>
			<p>The other side of the equation is self.check_answer(), which uses the provided id to look up the answer details.  The template from those is used to fetch the validation block for that question and the block is called.  If the answer validates, we clear that answer out and return true.  The answer isn't cleared in the event of a false response, in case a typo was made.</p>
			<p>The other three methods are for loading and saving the data the program relies on.  Answers are serialized and read with the help of Marshal.  The captcha file is simply eval()ed in the context of the module, so it can add captchas using Ruby code.</p>
			<p>Here's the interface code:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="comment"># ...</span><br /><br />    <span class="keyword">if</span> <span class="keyword">__FILE__</span> == <span class="global">$0</span><br />        captchas = File.join(ENV[<span class="string">"HOME"</span>], <span class="string">".math_captchas"</span>)<br />        <span class="keyword">unless</span> File.exists? captchas<br />            File.open(captchas, <span class="string">"w"</span>) { |file| file &lt;&lt; DATA.read }<br />        <span class="keyword">end</span><br />        MathCaptcha.load_captchas(captchas)<br /><br />        answers = File.join(ENV[<span class="string">"HOME"</span>], <span class="string">".math_captcha_answers"</span>)<br />        MathCaptcha.load_answers(answers) <span class="keyword">if</span> File.exists? answers<br /><br />        <span class="keyword">END</span> { MathCaptcha.save_answers(answers) }<br /><br />        <span class="keyword">if</span> ARGV.empty?<br />            question = MathCaptcha.create_question<br />            puts <span class="string">"#{question[:answer_id]} : #{question[:question]}"</span><br />        <span class="keyword">else</span><br />            args = Hash.new<br />            <span class="keyword">while</span> ARGV.size &gt;= 2 <span class="keyword">and</span> ARGV.first =~ <span class="string">/^--\w+$/</span><br />                key       = ARGV.shift[2..-1].to_sym<br />                value     = ARGV.first =~ <span class="string">/^\d+$/</span> ? ARGV.shift.to_i : ARGV.shift<br />                args[key] = value<br />            <span class="keyword">end</span><br /><br />            answer = MathCaptcha.check_answer(args)<br />            puts answer<br /><br />            exit(answer ? 0 : -1)<br />        <span class="keyword">end</span><br />    <span class="keyword">end</span><br /><br />    <span class="comment"># ...</span><br /><br /></div></div>
			<p>The first part of that code reads the captcha and answer files into memory.  If the captcha file didn't exist, a sample file is created for the user to modify.  Once the answer file is loaded, an END { ... } block is registered so the program will be sure to update it on exit.</p>
			<p>Finally, we've come to the quiz interface.  If no arguments were given, create a question.  If we got arguments, check the answer for the indicated question and print true or false.  I also use the exit code to notify success or failure.</p>
			<p>I used the DATA section of the source to store the sample captcha file:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="comment"># ...</span><br /><br />    <span class="comment">__END__<br />    add_captcha(<br />        "&lt;%= arg(rand(10)).to_en.capitalize %&gt; plus &lt;%= arg(2).to_en %&gt;?"<br />    ) do |answer, *opers|<br />        if answer.is_a?(String) and answer =~ /^\d+$/<br />            answer = answer.to_i.to_en<br />        elsif answer.is_a?(Integer)<br />            answer = answer.to_en<br />        end<br />        answer == opers.inject { |sum, var| sum + var }.to_en<br />    end<br /><br /></span></div></div>
			<p>There's only one example there, but it does show how to use arg() and to_en().  The block only looks so complicated because I allow three different forms for the answer.  I think these templates are pretty flexible, since you get to use Ruby at both ends to build questions and check answers.</p>
			<p>My thanks to Gavin Kistner for a great problem and a clever solution.</p>
			<p>Tomorrow's challenge is for all you language junkies out there.  Bring your translation skills...</p>
		</div>
		<div id="logo"><img src="/web/20120121215607im_/http://rubyquiz.com/images/ruby_quiz_logo.jpg" alt="" width="157" height="150" /></div>
		<div id="links">
			<span class="title">Quiz Solutions</span>
			<ol>
				<li><a href="/web/20120121215607/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/157538">Gavin Kistner</a></li>
				<li><a href="/web/20120121215607/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/157581">James Edward Gray II</a></li>
			</ol>
			<p><a href="/web/20120121215607/http://rubyquiz.com/quiz48_sols.zip">Download Solutions</a></p>
			<p><a href="/web/20120121215607/http://rubyquiz.com/index.html">Back to Quiz Listing</a></p>
		</div>
		<div id="footer">&nbsp;</div>
	</div>
</body>
</html>





<!--
     FILE ARCHIVED ON 21:56:07 Jan 21, 2012 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 13:09:45 Jun 5, 2013.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
