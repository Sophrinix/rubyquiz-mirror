<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>


<!-- Start Wayback Rewrite JS Include -->
<script type="text/javascript" src="/static/js/jwplayer/jwplayer.js" ></script>
<script type="text/javascript" src="/static/js/video-embed-rewriter.js"></script>
<script type="text/javascript">
function initYTVideo(id)
{
	_wmVideos_.init("/web/", id);
}
</script>
<!-- End Wayback Rewrite JS Include -->

	<title>Ruby Quiz - Lost Cities (#51)</title>
	<link rel="stylesheet" type="text/css" href="/web/20120120003315cs_/http://rubyquiz.com/quiz.css" />
	<link rel="stylesheet" type="text/css" href="/web/20120120003315cs_/http://rubyquiz.com/print.css" media="print" />
</head><body>
<!-- BEGIN WAYBACK TOOLBAR INSERT -->

<script type="text/javascript" src="/static/js/disclaim-element.js" ></script>
<script type="text/javascript" src="/static/js/graph-calc.js" ></script>
<script type="text/javascript" src="/static/jflot/jquery.min.js" ></script>
<script type="text/javascript">
//<![CDATA[
var firstDate = 820454400000;
var lastDate = 1388534399999;
var wbPrefix = "/web/";
var wbCurrentUrl = "http:\/\/rubyquiz.com\/quiz51.html";

var curYear = -1;
var curMonth = -1;
var yearCount = 18;
var firstYear = 1996;
var imgWidth = 450;
var yearImgWidth = 25;
var monthImgWidth = 2;
var trackerVal = "none";
var displayDay = "20";
var displayMonth = "Jan";
var displayYear = "2012";
var prettyMonths = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

function showTrackers(val) {
	if(val == trackerVal) {
		return;
	}
	if(val == "inline") {
		document.getElementById("displayYearEl").style.color = "#ec008c";
		document.getElementById("displayMonthEl").style.color = "#ec008c";
		document.getElementById("displayDayEl").style.color = "#ec008c";		
	} else {
		document.getElementById("displayYearEl").innerHTML = displayYear;
		document.getElementById("displayYearEl").style.color = "#ff0";
		document.getElementById("displayMonthEl").innerHTML = displayMonth;
		document.getElementById("displayMonthEl").style.color = "#ff0";
		document.getElementById("displayDayEl").innerHTML = displayDay;
		document.getElementById("displayDayEl").style.color = "#ff0";
	}
   document.getElementById("wbMouseTrackYearImg").style.display = val;
   document.getElementById("wbMouseTrackMonthImg").style.display = val;
   trackerVal = val;
}
function getElementX2(obj) {
	var thing = jQuery(obj);
	if((thing == undefined) 
			|| (typeof thing == "undefined") 
			|| (typeof thing.offset == "undefined")) {
		return getElementX(obj);
	}
	return Math.round(thing.offset().left);
}
function trackMouseMove(event,element) {

   var eventX = getEventX(event);
   var elementX = getElementX2(element);
   var xOff = eventX - elementX;
	if(xOff < 0) {
		xOff = 0;
	} else if(xOff > imgWidth) {
		xOff = imgWidth;
	}
   var monthOff = xOff % yearImgWidth;

   var year = Math.floor(xOff / yearImgWidth);
	var yearStart = year * yearImgWidth;
   var monthOfYear = Math.floor(monthOff / monthImgWidth);
   if(monthOfYear > 11) {
       monthOfYear = 11;
   }
   // 1 extra border pixel at the left edge of the year:
   var month = (year * 12) + monthOfYear;
   var day = 1;
	if(monthOff % 2 == 1) {
		day = 15;
	}
	var dateString = 
		zeroPad(year + firstYear) + 
		zeroPad(monthOfYear+1,2) +
		zeroPad(day,2) + "000000";

	var monthString = prettyMonths[monthOfYear];
	document.getElementById("displayYearEl").innerHTML = year + 1996;
	document.getElementById("displayMonthEl").innerHTML = monthString;
	// looks too jarring when it changes..
	//document.getElementById("displayDayEl").innerHTML = zeroPad(day,2);

	var url = wbPrefix + dateString + '/' +  wbCurrentUrl;
	document.getElementById('wm-graph-anchor').href = url;

   //document.getElementById("wmtbURL").value="evX("+eventX+") elX("+elementX+") xO("+xOff+") y("+year+") m("+month+") monthOff("+monthOff+") DS("+dateString+") Moy("+monthOfYear+") ms("+monthString+")";
   if(curYear != year) {
       var yrOff = year * yearImgWidth;
       document.getElementById("wbMouseTrackYearImg").style.left = yrOff + "px";
       curYear = year;
   }
   if(curMonth != month) {
       var mtOff = year + (month * monthImgWidth) + 1;
       document.getElementById("wbMouseTrackMonthImg").style.left = mtOff + "px";
       curMonth = month;
   }
}
//]]>
</script>

<style type="text/css">body{margin-top:0!important;padding-top:0!important;min-width:800px!important;}#wm-ipp a:hover{text-decoration:underline!important;}</style>
<div id="wm-ipp" style="display:none; position:relative;padding:0 5px;min-height:70px;min-width:800px; z-index:9000;">
<div id="wm-ipp-inside" style="position:fixed;padding:0!important;margin:0!important;width:97%;min-width:780px;border:5px solid #000;border-top:none;background-image:url(/static/images/toolbar/wm_tb_bk_trns.png);text-align:center;-moz-box-shadow:1px 1px 3px #333;-webkit-box-shadow:1px 1px 3px #333;box-shadow:1px 1px 3px #333;font-size:11px!important;font-family:'Lucida Grande','Arial',sans-serif!important;">
   <table style="border-collapse:collapse;margin:0;padding:0;width:100%;"><tbody><tr>
   <td style="padding:10px;vertical-align:top;min-width:110px;">
   <a href="/web/" title="Wayback Machine home page" style="background-color:transparent;border:none;"><img src="/static/images/toolbar/wayback-toolbar-logo.png" alt="Wayback Machine" width="110" height="39" border="0"/></a>
   </td>
   <td style="padding:0!important;text-align:center;vertical-align:top;width:100%;">

       <table style="border-collapse:collapse;margin:0 auto;padding:0;width:570px;"><tbody><tr>
       <td style="padding:3px 0;" colspan="2">
       <form target="_top" method="get" action="/web/form-submit.jsp" name="wmtb" id="wmtb" style="margin:0!important;padding:0!important;"><input type="text" name="url" id="wmtbURL" value="http://rubyquiz.com/quiz51.html" style="width:400px;font-size:11px;font-family:'Lucida Grande','Arial',sans-serif;" onfocus="javascript:this.focus();this.select();" /><input type="hidden" name="type" value="replay" /><input type="hidden" name="date" value="20120120003315" /><input type="submit" value="Go" style="font-size:11px;font-family:'Lucida Grande','Arial',sans-serif;margin-left:5px;" /><span id="wm_tb_options" style="display:block;"></span></form>
       </td>
       <td style="vertical-align:bottom;padding:5px 0 0 0!important;" rowspan="2">
           <table style="border-collapse:collapse;width:110px;color:#99a;font-family:'Helvetica','Lucida Grande','Arial',sans-serif;"><tbody>
			
           <!-- NEXT/PREV MONTH NAV AND MONTH INDICATOR -->
           <tr style="width:110px;height:16px;font-size:10px!important;">
           	<td style="padding-right:9px;font-size:11px!important;font-weight:bold;text-transform:uppercase;text-align:right;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20101127172519/http://rubyquiz.com/quiz51.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="27 Nov 2010"><strong>NOV</strong></a>
		                
               </td>
               <td id="displayMonthEl" style="background:#000;color:#ff0;font-size:11px!important;font-weight:bold;text-transform:uppercase;width:34px;height:15px;padding-top:1px;text-align:center;" title="You are here: 0:33:15 Jan 20, 2012">JAN</td>
				<td style="padding-left:9px;font-size:11px!important;font-weight:bold;text-transform:uppercase;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20120418102001/http://www.rubyquiz.com/quiz51.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="18 Apr 2012"><strong>APR</strong></a>
		                
               </td>
           </tr>

           <!-- NEXT/PREV CAPTURE NAV AND DAY OF MONTH INDICATOR -->
           <tr>
               <td style="padding-right:9px;white-space:nowrap;overflow:visible;text-align:right!important;vertical-align:middle!important;" nowrap="nowrap">
               
		                <a href="/web/20101127172519/http://rubyquiz.com/quiz51.html" title="17:25:19 Nov 27, 2010" style="background-color:transparent;border:none;"><img src="/static/images/toolbar/wm_tb_prv_on.png" alt="Previous capture" width="14" height="16" border="0" /></a>
		                
               </td>
               <td id="displayDayEl" style="background:#000;color:#ff0;width:34px;height:24px;padding:2px 0 0 0;text-align:center;font-size:24px;font-weight: bold;" title="You are here: 0:33:15 Jan 20, 2012">20</td>
				<td style="padding-left:9px;white-space:nowrap;overflow:visible;text-align:left!important;vertical-align:middle!important;" nowrap="nowrap">
               
		                <a href="/web/20120418102001/http://www.rubyquiz.com/quiz51.html" title="10:20:01 Apr 18, 2012" style="background-color:transparent;border:none;"><img src="/static/images/toolbar/wm_tb_nxt_on.png" alt="Next capture" width="14" height="16" border="0"/></a>
		                
			    </td>
           </tr>

           <!-- NEXT/PREV YEAR NAV AND YEAR INDICATOR -->
           <tr style="width:110px;height:13px;font-size:9px!important;">
				<td style="padding-right:9px;font-size:11px!important;font-weight: bold;text-align:right;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20101127172519/http://rubyquiz.com/quiz51.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="27 Nov 2010"><strong>2010</strong></a>
		                
               </td>
               <td id="displayYearEl" style="background:#000;color:#ff0;font-size:11px!important;font-weight: bold;padding-top:1px;width:34px;height:13px;text-align:center;" title="You are here: 0:33:15 Jan 20, 2012">2012</td>
				<td style="padding-left:9px;font-size:11px!important;font-weight: bold;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20130215052335/http://rubyquiz.com/quiz51.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="15 Feb 2013"><strong>2013</strong></a>
		                
				</td>
           </tr>
           </tbody></table>
       </td>

       </tr>
       <tr>
       <td style="vertical-align:middle;padding:0!important;">
           <a href="/web/20120120003315*/http://rubyquiz.com/quiz51.html" style="color:#33f;font-size:11px;font-weight:bold;background-color:transparent;border:none;" title="See a list of every capture for this URL"><strong>29 captures</strong></a>
           <div style="margin:0!important;padding:0!important;color:#666;font-size:9px;padding-top:2px!important;white-space:nowrap;" title="Timespan for captures of this URL">24 Apr 06 - 15 Feb 13</div>
       </td>
       <td style="padding:0!important;">
       <a style="position:relative; white-space:nowrap; width:450px;height:27px;" href="" id="wm-graph-anchor">
       <div id="wm-ipp-sparkline" style="position:relative; white-space:nowrap; width:450px;height:27px;background-color:#fff;cursor:pointer;border-right:1px solid #ccc;" title="Explore captures for this URL">
			<img id="sparklineImgId" style="position:absolute; z-index:9012; top:0px; left:0px;"
				onmouseover="showTrackers('inline');" 
				onmouseout="showTrackers('none');"
				onmousemove="trackMouseMove(event,this)"
				alt="sparklines"
				width="450"
				height="27"
				border="0"
				src="/web/jsp/graph.jsp?graphdata=450_27_1996:-1:000000000000_1997:-1:000000000000_1998:-1:000000000000_1999:-1:000000000000_2000:-1:000000000000_2001:-1:000000000000_2002:-1:000000000000_2003:-1:000000000000_2004:-1:000000000000_2005:-1:000000000000_2006:-1:000110000100_2007:-1:000101000000_2008:-1:000020000000_2009:-1:000000000000_2010:-1:000000000010_2011:-1:000000000000_2012:0:10017000a100_2013:-1:010000000000"></img>
			<img id="wbMouseTrackYearImg" 
				style="display:none; position:absolute; z-index:9010;"
				width="25" 
				height="27"
				border="0"
				src="/static/images/toolbar/transp-yellow-pixel.png"></img>
			<img id="wbMouseTrackMonthImg"
				style="display:none; position:absolute; z-index:9011; " 
				width="2"
				height="27" 
				border="0"
				src="/static/images/toolbar/transp-red-pixel.png"></img>
       </div>
		</a>

       </td>
       </tr></tbody></table>
   </td>
   <td style="text-align:right;padding:5px;width:65px;font-size:11px!important;">
       <a href="javascript:;" onclick="document.getElementById('wm-ipp').style.display='none';" style="display:block;padding-right:18px;background:url(/static/images/toolbar/wm_tb_close.png) no-repeat 100% 0;color:#33f;font-family:'Lucida Grande','Arial',sans-serif;margin-bottom:23px;background-color:transparent;border:none;" title="Close the toolbar">Close</a>
       <a href="http://faq.web.archive.org/" style="display:block;padding-right:18px;background:url(/static/images/toolbar/wm_tb_help.png) no-repeat 100% 0;color:#33f;font-family:'Lucida Grande','Arial',sans-serif;background-color:transparent;border:none;" title="Get some help using the Wayback Machine">Help</a>
   </td>
   </tr></tbody></table>

</div>
</div>
<script type="text/javascript">
 var wmDisclaimBanner = document.getElementById("wm-ipp");
 if(wmDisclaimBanner != null) {
   disclaimElement(wmDisclaimBanner);
 }
</script>
<!-- END WAYBACK TOOLBAR INSERT -->

	<div id="page">
		<div id="header"><span class="ruby">Ruby</span> <span class="quiz">Quiz</span></div>
		<div id="content">
			<span class="title">Lost Cities (#51)</span>
			<p>My wife and I love to play a card game called Lost Cities.  It's an easy two player game.</p>
			<p>There are five "suits" representing locations in the world:  Deserts, Oceans, Mountains, Jungles, and Volcanoes.  Each suit contains three "investment" cards and one each of the numbers 2 through 10.</p>
			<p>Eight cards are dealt to each player, then play alternates turns.  On your turn, you must do exactly two things:  Play a card and draw a card, in that order.  When the last card is drawn from the deck, the game ends immediately.</p>
			<p>Each play gets an "expedition" pile for each of the five suits, and the players share five discard piles, again one for each suit.  To play a card, you may add it to your expedition pile for that suit or place it on the discard pile for that suit.</p>
			<p>Your expedition piles must go in order.  You may only play a higher card than the last one you played on that pile.  Investment cards are low and you may play up to all three of them, even though they are the same card.  They must still come before the number cards, of course.</p>
			<p>You have two choices when drawing a card.  You may take the top card from the deck or the last card played on any of the five discard piles.  You may not however, discard a card and then draw it again in the same turn.</p>
			<p>When the deck is exhausted, both player's scores are calculated based on the expedition piles.  High score wins.  (Players generally play a few hands and keep a running tally.)</p>
			<p>An expeditions score is calculated by the following formula:</p>
			<p class="example">points = (total_of_all_number_cards - 20) * (1 + investment_cards_count) +<br />         bonus_20_points_if_expedition_has_8_cards_or_more</p>
			<p>For example, if you had two investment cards and the 6, 8, and 10 in the oceans suit, that expedition is worth 12 points ((24 - 20) * (1 + 2) + 0).  Expeditions in which you didn't play a card don't count for or against you.  They are disregarded.</p>
			<p>That's the whole game.  Let's see a few rounds played out, as an example.  First, I'm shown my hand and I can select a card to play:</p>
			<p class="example">Deserts:<br />  Opponent:  <br />  Discards:  <br />       You:  <br />Oceans:<br />  Opponent:  <br />  Discards:  <br />       You:  <br />Mountains:<br />  Opponent:  <br />  Discards:  <br />       You:  <br />Jungles:<br />  Opponent:  <br />  Discards:  <br />       You:  <br />Volcanoes:<br />  Opponent:  <br />  Discards:  <br />       You:  <br />Deck:  ############################################ (44)<br />Hand:  InvD 2D 3D 5D 2O 5O 9J 5V<br />Score:  0 (You) vs. 0 (Opponent).  Your play?<br />id<br />You play the InvD.</p>
			<p>Then I am asked where I would like to draw from.  I don't really have a choice yet though, since the discard piles are empty:</p>
			<p class="example">Deserts:<br />  Opponent:  <br />  Discards:  <br />       You:  Inv (-40)<br />Oceans:<br />  Opponent:  <br />  Discards:  <br />       You:  <br />Mountains:<br />  Opponent:  <br />  Discards:  <br />       You:  <br />Jungles:<br />  Opponent:  <br />  Discards:  <br />       You:  <br />Volcanoes:<br />  Opponent:  <br />  Discards:  <br />       You:  <br />Deck:  ############################################ (44)<br />Hand:  2D 3D 5D 2O 5O 9J 5V<br />Score:  -40 (You) vs. 0 (Opponent).  Draw from?<br />n<br />You draw a card from the deck.</p>
			<p>Then my opponent gets a turn:</p>
			<p class="example">Your opponent plays the InvD.<br />Your opponent draws a card from the deck.</p>
			<p>And I get another turn:</p>
			<p class="example">Deserts:<br />  Opponent:  Inv (-40)<br />  Discards:  <br />       You:  Inv (-40)<br />Oceans:<br />  Opponent:  <br />  Discards:  <br />       You:  <br />Mountains:<br />  Opponent:  <br />  Discards:  <br />       You:  <br />Jungles:<br />  Opponent:  <br />  Discards:  <br />       You:  <br />Volcanoes:<br />  Opponent:  <br />  Discards:  <br />       You:  <br />Deck:  ########################################## (42)<br />Hand:  2D 3D 5D 2O 5O 6M 9J 5V<br />Score:  -40 (You) vs. -40 (Opponent).  Your play?<br />2d<br />You play the 2D.<br />Deserts:<br />  Opponent:  Inv (-40)<br />  Discards:  <br />       You:  Inv 2 (-36)<br />Oceans:<br />  Opponent:  <br />  Discards:  <br />       You:  <br />Mountains:<br />  Opponent:  <br />  Discards:  <br />       You:  <br />Jungles:<br />  Opponent:  <br />  Discards:  <br />       You:  <br />Volcanoes:<br />  Opponent:  <br />  Discards:  <br />       You:  <br />Deck:  ########################################## (42)<br />Hand:  3D 5D 2O 5O 6M 9J 5V<br />Score:  -36 (You) vs. -40 (Opponent).  Draw from?<br />n<br />You draw a card from the deck.</p>
			<p>We continue on like that until the deck is exhausted.</p>
			<p>You can get the code I'm using above at:</p>
			<p><a href="/web/20120120003315/http://rubyquiz.com/lost_cities.rb">Lost Cities Client/Server</a></p>
			<p>That code functions as a trivial line-oriented client and server.  To play a card just feed it a card value and suit in the form (?:[i2-9]|10)[domjv].  Add a "d" to the front of that if you wish to discard instead.  To draw, just name a pile or ask for a "n"ew card from the deck:  [domjvn].</p>
			<p>This week's Ruby Quiz?  To build an AI for playing Lost Cities, of course!</p>
			<p>You can tie into my server's very simple API buy defining a subclass of Player with a show() and move() method.  show() is called for each line of data the server sends to you, and move() is called when the server expects a response.  Here's a very DumbPlayer to get you going:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="comment">#!/usr/local/bin/ruby -w</span><br /><br />    <span class="keyword">class</span> DumbPlayer &lt; Player<br />      <span class="keyword">def</span> initialize<br />        <span class="keyword">super</span><br /><br />        <span class="variable">@data</span> = <span class="string">""</span><br /><br />        <span class="variable">@plays</span>   = <span class="keyword">nil</span><br />        <span class="variable">@discard</span> = <span class="keyword">nil</span><br />      <span class="keyword">end</span><br /><br />      <span class="keyword">def</span> show( game_data )<br />        <span class="keyword">if</span> game_data =~ <span class="string">/^You (?:play|discard)/</span><br />          <span class="variable">@plays</span>   = <span class="keyword">nil</span><br />          <span class="variable">@discard</span> = <span class="keyword">nil</span><br />        <span class="keyword">end</span><br /><br />        <span class="variable">@data</span> &lt;&lt; game_data<br />      <span class="keyword">end</span><br /><br />      <span class="keyword">def</span> move<br />        <span class="keyword">if</span> <span class="variable">@data</span>.include?(<span class="string">"Draw from?"</span>)<br />          draw_card<br />        <span class="keyword">else</span><br />          make_move<br />        <span class="keyword">end</span><br />      <span class="keyword">ensure</span><br />        <span class="variable">@data</span> = <span class="string">""</span><br />      <span class="keyword">end</span><br /><br />      private<br /><br />      <span class="keyword">def</span> draw_card<br />        <span class="string">"n"</span><br />      <span class="keyword">end</span><br /><br />      <span class="keyword">def</span> make_move<br />        <span class="keyword">if</span> <span class="variable">@plays</span>.nil? <span class="keyword">and</span> <span class="variable">@data</span> =~ <span class="string">/Hand:  (.+?)\s*$/</span><br />          <span class="variable">@plays</span>   = <span class="global">$1</span>.split.map { |card| card.sub(<span class="string">/Inv/</span>, <span class="string">"I"</span>) }<br />          <span class="variable">@discard</span> = <span class="string">"d#{@plays.first}"</span><br />        <span class="keyword">end</span><br /><br />        <span class="keyword">if</span> <span class="variable">@plays</span>.empty?<br />          <span class="variable">@discard</span><br />        <span class="keyword">else</span><br />          <span class="variable">@plays</span>.shift<br />        <span class="keyword">end</span><br />      <span class="keyword">end</span><br />    <span class="keyword">end</span><br /><br /></div></div>
			<p>If you save that as dumb_player.rb, you could play against it with something like:</p>
			<p class="example">$ ruby lost_cities.rb 9016<br /><br />... then in a different terminal ...<br /><br />$ ruby lost_cities.rb localhost 9016 dumb_player.rb</p>
			<p>Let the games begin!</p>
			<hr />
			<p><span class="title">Quiz Summary</span></p>
			<p>There's nothing too tough in this quiz, but it turned out to be pretty time consuming for me.  Not because it required a ton of code for a solution, but because I kept playing against my solution and tweaking its behavior.  Of course, as Daniel Sheppard pointed out, I should have tried him against DumbPlayer a little more:</p>
			<p class="example">$ ruby lost_cities.rb localhost 61676 risk_player.rb <br />Final Score:  -21 (You) vs. -60 (Opponent).<br />Congratulations, you win.<br />$ ruby lost_cities.rb localhost 61676 risk_player.rb <br />Final Score:  -32 (You) vs. -1 (Opponent).<br />I'm sorry, you lose.<br />$ ruby lost_cities.rb localhost 61676 risk_player.rb <br />Final Score:  -43 (You) vs. -43 (Opponent).<br />The game is a draw.<br />$ ruby lost_cities.rb localhost 61676 risk_player.rb <br />Final Score:  -51 (You) vs. 5 (Opponent).<br />I'm sorry, you lose.</p>
			<p>"You" above would be RiskPlayer and "Opponent" is DumbPlayer.  I guess DumbPlayer isn't so dumb and RiskPlayer doesn't take enough risks.</p>
			<p>There were also some issues with the server and DumbPlayer that may have made it harder for people to mess around with this problem.  I apologize for that.</p>
			<p>Daniel's own solution is very interesting, but quite a bit of code to show here.  Let me see if I can hit a highlight or two.  First, I'll let Daniel explain how the code was built:</p>
			<p class="example">Designing an AI for a game which you've never played is a pretty<br />daunting task... So I let the computer do the work with a little bit<br />of genetics.<br /><br />The rule_player.rb file contains the basic framework for parsing the<br />input and storing the knowledge and also the rules, as well as an<br />extra player named "MultiplierPlayer" which allows the rules to be<br />given different weightings<br /><br />The breeder.rb file contains the breeding system. It creates a bunch<br />of MultiplierPlayers with different weightings and plays them against<br />each other round-robin style. The 2 players with the most wins under<br />their belts get bred to form extra players and the worst players get<br />dropped. The players are then saved off in a yaml file. Being yaml,<br />it's easy to edit, so if you think you know better than the breeder,<br />it's easy to throw your figures into the race.<br /><br />...</p>
			<p>That YAML file is really neat.  Here's a peek at a small slice of it:</p>
			<p class="example">--- <br />- <br />  - <br />    - 1<br />    - 1<br />    - 0<br />    - 0<br />    - 0<br />    - 0<br />    - 0<br /># ...<br />- <br />  - Rules::PlayLowestFirst<br />  - Rules::MaximumScoreEndGame<br />  - Rules::IgnoreUnusable<br />  - Rules::DiscardUnusable<br />  - Rules::DepriveOpponent<br />  - Rules::AvoidLateInvestment<br />  - Rules::ExpectedInvestmentValue</p>
			<p>The bottom section has the rules that the genetics system is considering.  The top Array lists the weights the winner settled on, favoring the first two rules clearly.</p>
			<p>The player that puts the data to use is trivial:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    require <span class="string">'rule_player'</span><br />    require <span class="string">'yaml'</span><br /><br />    <span class="keyword">class</span> BredPlayer &lt; MultiplierPlayer<br />        <span class="keyword">def</span> initialize<br />            raise <span class="string">"No Data File"</span> <span class="keyword">unless</span> File.exist?(<span class="string">'data2.yaml'</span>)<br />            multipliers, rule_names = File.open(<span class="string">'data2.yaml'</span>,<span class="string">'r'</span>) <span class="keyword">do</span> |f|<br />                YAML::load(f)<br />            <span class="keyword">end</span><br />            <span class="keyword">super</span>(rule_names, multipliers[0])<br />        <span class="keyword">end</span><br />    <span class="keyword">end</span><br /><br /></div></div>
			<p>This is all designed to work with a testing framework Daniel provided, of course.  The really interesting part of Daniel's code, to me, was breeder.rb.  If you're at all interested in genetic programming, do look around in there.  It even has comments to drive you through the evolution process.  Neat stuff.</p>
			<p>Though my solution turns out to be a pretty bad player, it does have the elements any smarter solution would need.  Its flaw is in the logic, which is just me being a bad teacher for computer strategy.  Let's look past that and examine the code anyway:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="comment">#!/usr/local/bin/ruby -w</span><br /><br />    <span class="keyword">class</span> RiskPlayer &lt; Player<br />      <span class="keyword">def</span> <span class="keyword">self</span>.card_from_string( card )<br />        value, land = card[0..-2], card[-1, 1].downcase<br />        Game::Card.new( value[0] == ?I ? value : value.to_i,<br />                        Game::LANDS.find { |l| l[0, 1] == land } )<br />      <span class="keyword">end</span><br /><br />      <span class="keyword">def</span> initialize<br />        <span class="variable">@piles</span> = Hash.new <span class="keyword">do</span> |piles, player|<br />          piles[player] = Hash.new { |pile, land| pile[land] = Array.new }<br />        <span class="keyword">end</span><br /><br />        <span class="variable">@deck_size</span> = 60<br />        <span class="variable">@hand</span>      = <span class="keyword">nil</span><br /><br />        <span class="variable">@last_dicard</span> = <span class="keyword">nil</span><br /><br />        <span class="variable">@action</span> = <span class="keyword">nil</span><br /><br />        <span class="variable">@done</span> = <span class="keyword">false</span><br />      <span class="keyword">end</span><br /><br />      <span class="comment"># ...</span><br /><br /></div></div>
			<p>There's nothing tricky in there.  The class method is a helper for converting a String like "InvV" into and actual card object.</p>
			<p>Then initialize() just prepares the instance data this class needs to track.  The @piles variable looks a little ugly because I wanted it to invent the data structure as needed.  It's just a Hash containing three keys:  :me, :them, and :discards.  Each of those is a Hash that contains an Array pile for each land type.</p>
			<p>Now the quiz requires a parser for the protocol.  Here's the easiest approach I could come up with:</p>
			<div class="code"><span class="type">ruby</span><div class="body">      <span class="keyword">def</span> show( game_data )<br />        <span class="keyword">if</span> <span class="variable">@done</span><br />          puts game_data<br />        <span class="keyword">else</span><br />          <span class="keyword">if</span> game_data =~ <span class="string">/^(Your?)(?: opponent)? (play|discard)s? the (\w+)/</span><br />            card = <span class="keyword">self</span>.<span class="keyword">class</span>.card_from_string(<span class="global">$3</span>)<br />            <span class="keyword">if</span> <span class="global">$2</span> == <span class="string">"play"</span><br />              <span class="keyword">if</span> <span class="global">$1</span> == <span class="string">"You"</span><br />                <span class="variable">@piles</span>[:me][card.land] &lt;&lt; card<br />              <span class="keyword">else</span><br />                <span class="variable">@piles</span>[:them][card.land] &lt;&lt; card<br />              <span class="keyword">end</span><br />            <span class="keyword">else</span><br />              <span class="variable">@piles</span>[:discards][card.land] &lt;&lt; card<br />            <span class="keyword">end</span><br /><br />            <span class="variable">@last_discard</span> = <span class="keyword">nil</span> <span class="keyword">if</span> <span class="global">$1</span> == <span class="string">"Your"</span><br />          <span class="keyword">end</span><br />          <span class="keyword">if</span> game_data =~ <span class="string">/^You(?:r opponent)? picks? up the (\w+)/</span><br />            <span class="variable">@piles</span>[:discards][<span class="keyword">self</span>.<span class="keyword">class</span>.card_from_string(<span class="global">$1</span>).land].pop<br />          <span class="keyword">end</span><br /><br />          <span class="keyword">if</span> game_data =~ <span class="string">/^\s*Deck:\s+#+\s+\((\d+)\)/</span><br />            <span class="variable">@deck_size</span> = <span class="global">$1</span>.to_i<br />          <span class="keyword">end</span><br />          <span class="keyword">if</span> game_data =~ <span class="string">/^\s*Hand:((?:\s+\w+)+)/</span><br />            <span class="variable">@hand</span> = <span class="global">$1</span>.strip.split.map { |c| <span class="keyword">self</span>.<span class="keyword">class</span>.card_from_string(c) }<br />          <span class="keyword">end</span><br /><br />          <span class="keyword">if</span> game_data.include?(<span class="string">"Your play?"</span>)<br />            <span class="variable">@action</span> = :play_card<br />          <span class="keyword">elsif</span> game_data.include?(<span class="string">"Draw from?"</span>)<br />            <span class="variable">@action</span> = :draw_card<br />          <span class="keyword">end</span><br /><br />          <span class="variable">@done</span> = <span class="keyword">true</span> <span class="keyword">if</span> game_data.include?(<span class="string">"Game over."</span>)<br />        <span class="keyword">end</span><br />      <span class="keyword">end</span><br /><br /></div></div>
			<p>The server notifies you when everything happens and I think it's easier to just track those notifications than it is to track your own moves and/or parse the game board to figure out where everything is.  The messages are easy to break down with light Regexp usage.</p>
			<p>The else branch of that top level if statement handles the parsing.  First it breaks down play/discard messages and places the card on the indicated pile.  It pops cards off the discard piles too, as needed.  The next bit reads the deck size and your hand from the game board.  The third section tracks whether you were asked to play or draw and the final line watches for a "Game over." which causes the code to print the final score (if branch at the top of the method).</p>
			<p>With that in place, we can move our focus to responding to play requests:</p>
			<div class="code"><span class="type">ruby</span><div class="body">      <span class="comment"># ...</span><br /><br />      <span class="keyword">def</span> move<br />        send(<span class="variable">@action</span>)<br />      <span class="keyword">end</span><br /><br />      private<br /><br />      <span class="keyword">def</span> play_card<br />        plays, discards = <span class="variable">@hand</span>.partition { |card| playable? card }<br /><br />        <span class="keyword">if</span> plays.empty?<br />          discard_card(discards)<br />        <span class="keyword">else</span><br />          risks   = analyze_risks(plays)<br />          risk    = risks.max { |a, b| a.last &lt;=&gt; b.last }<br /><br />          <span class="keyword">return</span> discard_card(<span class="variable">@hand</span>) <span class="keyword">if</span> risk.last &lt; 0<br /><br />          land    = risks.max { |a, b| a.last &lt;=&gt; b.last }.first.land<br />          play    = plays.select { |card| card.land == land }.<br />                    sort_by { |c| c.value.is_a?(String) ? 0 : c.value }.first<br />          <span class="string">"#{play.value}#{play.land[0, 1]}"</span>.sub(<span class="string">"nv"</span>, <span class="string">""</span>)<br />        <span class="keyword">end</span><br />      <span class="keyword">end</span><br /><br />      <span class="keyword">def</span> discard_card( choices )<br />        discard = choices.sort_by <span class="keyword">do</span> |card|<br />          [ playable?(card) ? 1 : 0, playable?(card, :them) ? 1 : 0,<br />            card.value.is_a?(String) ? 0 : card.value ]<br />        <span class="keyword">end</span>.first<br /><br />        <span class="variable">@last_discard</span> = discard<br />        <span class="string">"d#{discard.value}#{discard.land[0, 1]}"</span>.sub(<span class="string">"nv"</span>, <span class="string">""</span>)<br />      <span class="keyword">end</span><br /><br />      <span class="keyword">def</span> draw_card<br />        want = <span class="variable">@piles</span>[:discards].find <span class="keyword">do</span> |land, cards|<br />          <span class="keyword">not</span> <span class="variable">@piles</span>[:me][land].empty? <span class="keyword">and</span><br />          cards.last != <span class="variable">@last_discard</span> <span class="keyword">and</span> cards.any? { |card| playable?(card) }<br />        <span class="keyword">end</span><br />        <span class="keyword">if</span> want<br />          want.first[0, 1]<br />        <span class="keyword">else</span><br />          <span class="string">"n"</span><br />        <span class="keyword">end</span><br />      <span class="keyword">end</span><br /><br />      <span class="keyword">def</span> playable?( card, who = :me )<br />        <span class="variable">@piles</span>[who][card.land].empty? <span class="keyword">or</span><br />        <span class="variable">@piles</span>[who][card.land].last.value.is_a?(String) <span class="keyword">or</span><br />        ( <span class="keyword">not</span> card.value.is_a?(String) <span class="keyword">and</span><br />          <span class="variable">@piles</span>[who][card.land].last.value &lt; card.value )<br />      <span class="keyword">end</span><br /><br />      <span class="comment"># ...</span><br /><br /></div></div>
			<p>First, move() calls the correct action method based on what the server last requested (:play_card or :draw_card).</p>
			<p>The main action method, play_card(), splits hands into playable cards and discards.  It analyzes the risks of each play and tries to find something fairly safe.  If it has no plays or doesn't like its choices, a handoff is made to discard_card().</p>
			<p>The discard method just sorts available discards by some general criteria:  Can I play this?  Can my opponent?  How much is it worth?  It tries to find something it can't play, the opponent can't play, and that is low in value.  It tosses that.</p>
			<p>The other action method, draw_card(), just scans the discard piles for cards it wants.  If it sees a goody, it will pull from that pile.  Otherwise it defaults to a draw from the deck.</p>
			<p>Finally, playable?() is just a tool that will tell you if a card can be played currently, by the indicated player.</p>
			<p>The missing piece is the risk analysis method:</p>
			<div class="code"><span class="type">ruby</span><div class="body">      <span class="comment"># ...</span><br /><br />      <span class="keyword">def</span> analyze_risks( plays )<br />        plays.inject(Hash.new) <span class="keyword">do</span> |risks, card|<br />          risks[card] = 0<br /><br />          me_total = ( <span class="variable">@piles</span>[:me][card.land] +<br />                       plays.select { |c| c.land == card.land }<br />                       ).inject(0) <span class="keyword">do</span> |total, c|<br />            <span class="keyword">if</span> c.value.is_a? String<br />              total<br />            <span class="keyword">else</span><br />              total + c.value<br />            <span class="keyword">end</span><br />          <span class="keyword">end</span><br />          risks[card] += 20 - me_total<br /><br />          them_total = <span class="variable">@piles</span>[:them][card.land].inject(0) <span class="keyword">do</span> |total, c|<br />            <span class="keyword">if</span> c.value.is_a? String<br />              total<br />            <span class="keyword">else</span><br />              total + c.value<br />            <span class="keyword">end</span><br />          <span class="keyword">end</span><br />          high = card.value.is_a?(String) ? 2 : card.value<br />          risks[card] += ( (high..10).inject { |sum, n| sum + n }<br />                           - (me_total + them_total) ) / 2<br /><br />          <span class="keyword">if</span> <span class="variable">@piles</span>[:me][card.land].empty?<br />            lands_played = <span class="variable">@piles</span>[:me].inject(0) <span class="keyword">do</span> |count, (land, cards)|<br />              <span class="keyword">if</span> cards.empty?<br />                count<br />              <span class="keyword">else</span><br />                count + 1<br />              <span class="keyword">end</span><br />            <span class="keyword">end</span><br /><br />            risks[card] -= (lands_played + 1) * 5<br />          <span class="keyword">end</span><br /><br />          risks<br />        <span class="keyword">end</span><br />      <span class="keyword">end</span><br />    <span class="keyword">end</span><br /><br /></div></div>
			<p>WARNING:  The above code is what needs tweaking to make the AI player smarter.</p>
			<p>This method could do whatever thinking is required.  It's just expected to return a Hash of playable cards (keys) and their ratings (values).  The play_card() method will play the highest rated card, as long as it isn't negative.</p>
			<p>I tried to distill a little of how I play down into computer terms here.  The method takes into account how many points it has in a given pile and how many more it could play from its hand.  It also adds up the total of the cards still at large (above the highest play it can make), and assumes it could luck into half of those.  Finally, it adds a penalty to the rating for each new pile started.  It's usually a mistake to play too many piles in Lost Cities, because you don't have time to finish them all off.  Again, this logic needs further refinement.</p>
			<p>For yet another spin on rules, Adam Shelly sent in a solution yesterday that has a whole bunch of criteria it bases decisions on.  Check out this list:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="comment"># ...</span><br /><br />    <span class="comment">#rules affecting play/hold decision : </span><br />    <span class="comment">#positive values mean play, negative mean hold</span><br />    <span class="variable">@prules</span> = {:rule_inSequence=&gt;[0.6,0.8],<br />               :rule_lowCard=&gt;[0.1,0.0],<br />               :rule_lowCards=&gt;[0.2,0.0],<br />               :rule_highCard=&gt;[-0.3,0.1],<br />               :rule_highCards=&gt;[-0.2,0.2],<br />               :rule_investments=&gt;[0.1,-0.2],<br />               :rule_onInvestments=&gt;[0.5,0.7],<br />               :rule_holdingInvestments=&gt;[-0.2,0.0],<br />               :rule_investmentWithHope=&gt;[0.5,0.3],<br />               :rule_investmentWithoutHope=&gt;[-0.6,-1.0],<br />               :rule_group10=&gt;[0.5,-0.4],<br />               :rule_group15=&gt;[0.6,-0.3],<br />               :rule_group20=&gt;[0.7,-0.2],<br />               :rule_group25=&gt;[0.9,-0.1],<br />               :rule_total20 =&gt;[0.35,1.0],<br />               :rule_total25 =&gt;[0.6,1.0],<br />               :rule_suitStarted=&gt;[0.7,0.9],<br />               :rule_closeToPrevious=&gt;[0.4,0.5],<br />               :rule_multiplier2=&gt;[0.4,0.8],<br />               :rule_multiplier3=&gt;[0.5,0.9],<br />               :rule_onUnplayed=&gt;[-0.5,-1.0],<br />               :rule_heHasPlayed=&gt;[-0.1,0.0],<br />               :rule_heHasPlayed10=&gt;[-0.2,0.0],<br />               :rule_heHasPlayed20=&gt;[-0.3,0.0],<br />               :rule_handNegative=&gt;[0.5,0.9],<br />               :rule_mustPlays=&gt;[-0.3,1.0],<br />               :rule_lowerInHand=&gt;[-0.5,-0.4],<br />               :rule_highestInHand=&gt;[-0.1,-0.01],<br />               :rule_2followsInvest=&gt;[0.3,0.5],<br />               :rule_finishGame=&gt;[0.0,2.0],<br />               :rule_possibleBelow=&gt;[-0.2,-0.05],<br />               :rule_possibleManyBelow=&gt;[-0.4,-0.1]}<br />    <span class="comment">#rules affecting keep/discard decision : </span><br />    <span class="comment">#positive values mean keep, negative mean discard</span><br />    <span class="variable">@drules</span> = {:rule_useless2me=&gt;[-0.5, 0.1],<br />               :rule_useless2him=&gt;[-0.2,0.1],<br />               :rule_useful2him=&gt;[0.4,0.5],<br />               :rule_useful2me=&gt;[0.3,0.3],<br />               :rule_heHasPlayed=&gt;[0.1,0.3],<br />               :rule_singleton=&gt;[-0.2,-0.1],<br />               :rule_noPartners=&gt;[-0.3,-0.3],<br />               :rule_wantFromDiscard=&gt;[0.3,0.5],<br />               :rule_belowLowestPlayable=&gt;[-0.2,0.0],<br />               :rule_dontDiscardForever=&gt;[0.5,1]}<br /><br />    <span class="comment"># ...</span><br /><br /></div></div>
			<p>Those numbers are weights, one set for early in the game and another for late.  Cards are ranked by these criteria which allows plays/discards to be found.  These weights are hand tuned, from Adam's experience.</p>
			<p>Many thanks to all who fiddled with the game and especially to those who even tried to build a player.</p>
			<p>Tomorrow we have the very core of what makes programmers into programmers...  Talking barnyard animals, of course.</p>
		</div>
		<div id="logo"><img src="/web/20120120003315im_/http://rubyquiz.com/images/ruby_quiz_logo.jpg" alt="" width="157" height="150" /></div>
		<div id="links">
			<span class="title">Quiz Solutions</span>
			<ol>
				<li><a href="/web/20120120003315/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/160832">Daniel Sheppard</a></li>
				<li><a href="/web/20120120003315/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/160995">Daniel Sheppard (2)</a></li>
				<li><a href="/web/20120120003315/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/161183">Bob Showalter</a></li>
				<li><a href="/web/20120120003315/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/161225">James Edward Gray II</a></li>
				<li><a href="/web/20120120003315/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/161265">Bob Showalter (2)</a></li>
				<li><a href="/web/20120120003315/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/161325">Daniel Sheppard (3)</a></li>
				<li><a href="/web/20120120003315/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/161413">Anthony Moralez</a></li>
				<li><a href="/web/20120120003315/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/161438">Adam Shelly</a></li>
				<li><a href="/web/20120120003315/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/161563">Adam Shelly (2)</a></li>
				<li><a href="/web/20120120003315/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/161597">Daniel Sheppard (4)</a></li>
			</ol>
			<p><a href="/web/20120120003315/http://rubyquiz.com/quiz51_sols.zip">Download Solutions</a></p>
			<p><a href="/web/20120120003315/http://rubyquiz.com/index.html">Back to Quiz Listing</a></p>
		</div>
		<div id="footer">&nbsp;</div>
	</div>
</body>
</html>





<!--
     FILE ARCHIVED ON 0:33:15 Jan 20, 2012 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 13:09:47 Jun 5, 2013.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
