<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>


<!-- Start Wayback Rewrite JS Include -->
<script type="text/javascript" src="/static/js/jwplayer/jwplayer.js" ></script>
<script type="text/javascript" src="/static/js/video-embed-rewriter.js"></script>
<script type="text/javascript">
function initYTVideo(id)
{
	_wmVideos_.init("/web/", id);
}
</script>
<!-- End Wayback Rewrite JS Include -->

	<title>Ruby Quiz - Port a Library (#64)</title>
	<link rel="stylesheet" type="text/css" href="/web/20120121201733cs_/http://rubyquiz.com/quiz.css" />
	<link rel="stylesheet" type="text/css" href="/web/20120121201733cs_/http://rubyquiz.com/print.css" media="print" />
</head><body>
<!-- BEGIN WAYBACK TOOLBAR INSERT -->

<script type="text/javascript" src="/static/js/disclaim-element.js" ></script>
<script type="text/javascript" src="/static/js/graph-calc.js" ></script>
<script type="text/javascript" src="/static/jflot/jquery.min.js" ></script>
<script type="text/javascript">
//<![CDATA[
var firstDate = 820454400000;
var lastDate = 1388534399999;
var wbPrefix = "/web/";
var wbCurrentUrl = "http:\/\/rubyquiz.com\/quiz64.html";

var curYear = -1;
var curMonth = -1;
var yearCount = 18;
var firstYear = 1996;
var imgWidth = 450;
var yearImgWidth = 25;
var monthImgWidth = 2;
var trackerVal = "none";
var displayDay = "21";
var displayMonth = "Jan";
var displayYear = "2012";
var prettyMonths = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

function showTrackers(val) {
	if(val == trackerVal) {
		return;
	}
	if(val == "inline") {
		document.getElementById("displayYearEl").style.color = "#ec008c";
		document.getElementById("displayMonthEl").style.color = "#ec008c";
		document.getElementById("displayDayEl").style.color = "#ec008c";		
	} else {
		document.getElementById("displayYearEl").innerHTML = displayYear;
		document.getElementById("displayYearEl").style.color = "#ff0";
		document.getElementById("displayMonthEl").innerHTML = displayMonth;
		document.getElementById("displayMonthEl").style.color = "#ff0";
		document.getElementById("displayDayEl").innerHTML = displayDay;
		document.getElementById("displayDayEl").style.color = "#ff0";
	}
   document.getElementById("wbMouseTrackYearImg").style.display = val;
   document.getElementById("wbMouseTrackMonthImg").style.display = val;
   trackerVal = val;
}
function getElementX2(obj) {
	var thing = jQuery(obj);
	if((thing == undefined) 
			|| (typeof thing == "undefined") 
			|| (typeof thing.offset == "undefined")) {
		return getElementX(obj);
	}
	return Math.round(thing.offset().left);
}
function trackMouseMove(event,element) {

   var eventX = getEventX(event);
   var elementX = getElementX2(element);
   var xOff = eventX - elementX;
	if(xOff < 0) {
		xOff = 0;
	} else if(xOff > imgWidth) {
		xOff = imgWidth;
	}
   var monthOff = xOff % yearImgWidth;

   var year = Math.floor(xOff / yearImgWidth);
	var yearStart = year * yearImgWidth;
   var monthOfYear = Math.floor(monthOff / monthImgWidth);
   if(monthOfYear > 11) {
       monthOfYear = 11;
   }
   // 1 extra border pixel at the left edge of the year:
   var month = (year * 12) + monthOfYear;
   var day = 1;
	if(monthOff % 2 == 1) {
		day = 15;
	}
	var dateString = 
		zeroPad(year + firstYear) + 
		zeroPad(monthOfYear+1,2) +
		zeroPad(day,2) + "000000";

	var monthString = prettyMonths[monthOfYear];
	document.getElementById("displayYearEl").innerHTML = year + 1996;
	document.getElementById("displayMonthEl").innerHTML = monthString;
	// looks too jarring when it changes..
	//document.getElementById("displayDayEl").innerHTML = zeroPad(day,2);

	var url = wbPrefix + dateString + '/' +  wbCurrentUrl;
	document.getElementById('wm-graph-anchor').href = url;

   //document.getElementById("wmtbURL").value="evX("+eventX+") elX("+elementX+") xO("+xOff+") y("+year+") m("+month+") monthOff("+monthOff+") DS("+dateString+") Moy("+monthOfYear+") ms("+monthString+")";
   if(curYear != year) {
       var yrOff = year * yearImgWidth;
       document.getElementById("wbMouseTrackYearImg").style.left = yrOff + "px";
       curYear = year;
   }
   if(curMonth != month) {
       var mtOff = year + (month * monthImgWidth) + 1;
       document.getElementById("wbMouseTrackMonthImg").style.left = mtOff + "px";
       curMonth = month;
   }
}
//]]>
</script>

<style type="text/css">body{margin-top:0!important;padding-top:0!important;min-width:800px!important;}#wm-ipp a:hover{text-decoration:underline!important;}</style>
<div id="wm-ipp" style="display:none; position:relative;padding:0 5px;min-height:70px;min-width:800px; z-index:9000;">
<div id="wm-ipp-inside" style="position:fixed;padding:0!important;margin:0!important;width:97%;min-width:780px;border:5px solid #000;border-top:none;background-image:url(/static/images/toolbar/wm_tb_bk_trns.png);text-align:center;-moz-box-shadow:1px 1px 3px #333;-webkit-box-shadow:1px 1px 3px #333;box-shadow:1px 1px 3px #333;font-size:11px!important;font-family:'Lucida Grande','Arial',sans-serif!important;">
   <table style="border-collapse:collapse;margin:0;padding:0;width:100%;"><tbody><tr>
   <td style="padding:10px;vertical-align:top;min-width:110px;">
   <a href="/web/" title="Wayback Machine home page" style="background-color:transparent;border:none;"><img src="/static/images/toolbar/wayback-toolbar-logo.png" alt="Wayback Machine" width="110" height="39" border="0"/></a>
   </td>
   <td style="padding:0!important;text-align:center;vertical-align:top;width:100%;">

       <table style="border-collapse:collapse;margin:0 auto;padding:0;width:570px;"><tbody><tr>
       <td style="padding:3px 0;" colspan="2">
       <form target="_top" method="get" action="/web/form-submit.jsp" name="wmtb" id="wmtb" style="margin:0!important;padding:0!important;"><input type="text" name="url" id="wmtbURL" value="http://rubyquiz.com/quiz64.html" style="width:400px;font-size:11px;font-family:'Lucida Grande','Arial',sans-serif;" onfocus="javascript:this.focus();this.select();" /><input type="hidden" name="type" value="replay" /><input type="hidden" name="date" value="20120121201733" /><input type="submit" value="Go" style="font-size:11px;font-family:'Lucida Grande','Arial',sans-serif;margin-left:5px;" /><span id="wm_tb_options" style="display:block;"></span></form>
       </td>
       <td style="vertical-align:bottom;padding:5px 0 0 0!important;" rowspan="2">
           <table style="border-collapse:collapse;width:110px;color:#99a;font-family:'Helvetica','Lucida Grande','Arial',sans-serif;"><tbody>
			
           <!-- NEXT/PREV MONTH NAV AND MONTH INDICATOR -->
           <tr style="width:110px;height:16px;font-size:10px!important;">
           	<td style="padding-right:9px;font-size:11px!important;font-weight:bold;text-transform:uppercase;text-align:right;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20110826111137/http://rubyquiz.com/quiz64.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="26 Aug 2011"><strong>AUG</strong></a>
		                
               </td>
               <td id="displayMonthEl" style="background:#000;color:#ff0;font-size:11px!important;font-weight:bold;text-transform:uppercase;width:34px;height:15px;padding-top:1px;text-align:center;" title="You are here: 20:17:33 Jan 21, 2012">JAN</td>
				<td style="padding-left:9px;font-size:11px!important;font-weight:bold;text-transform:uppercase;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20120418154958/http://www.rubyquiz.com/quiz64.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="18 Apr 2012"><strong>APR</strong></a>
		                
               </td>
           </tr>

           <!-- NEXT/PREV CAPTURE NAV AND DAY OF MONTH INDICATOR -->
           <tr>
               <td style="padding-right:9px;white-space:nowrap;overflow:visible;text-align:right!important;vertical-align:middle!important;" nowrap="nowrap">
               
		                <a href="/web/20110826111137/http://rubyquiz.com/quiz64.html" title="11:11:37 Aug 26, 2011" style="background-color:transparent;border:none;"><img src="/static/images/toolbar/wm_tb_prv_on.png" alt="Previous capture" width="14" height="16" border="0" /></a>
		                
               </td>
               <td id="displayDayEl" style="background:#000;color:#ff0;width:34px;height:24px;padding:2px 0 0 0;text-align:center;font-size:24px;font-weight: bold;" title="You are here: 20:17:33 Jan 21, 2012">21</td>
				<td style="padding-left:9px;white-space:nowrap;overflow:visible;text-align:left!important;vertical-align:middle!important;" nowrap="nowrap">
               
		                <a href="/web/20120418154958/http://www.rubyquiz.com/quiz64.html" title="15:49:58 Apr 18, 2012" style="background-color:transparent;border:none;"><img src="/static/images/toolbar/wm_tb_nxt_on.png" alt="Next capture" width="14" height="16" border="0"/></a>
		                
			    </td>
           </tr>

           <!-- NEXT/PREV YEAR NAV AND YEAR INDICATOR -->
           <tr style="width:110px;height:13px;font-size:9px!important;">
				<td style="padding-right:9px;font-size:11px!important;font-weight: bold;text-align:right;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20101127175520/http://rubyquiz.com/quiz64.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="27 Nov 2010"><strong>2010</strong></a>
		                
               </td>
               <td id="displayYearEl" style="background:#000;color:#ff0;font-size:11px!important;font-weight: bold;padding-top:1px;width:34px;height:13px;text-align:center;" title="You are here: 20:17:33 Jan 21, 2012">2012</td>
				<td style="padding-left:9px;font-size:11px!important;font-weight: bold;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20130215052746/http://rubyquiz.com/quiz64.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="15 Feb 2013"><strong>2013</strong></a>
		                
				</td>
           </tr>
           </tbody></table>
       </td>

       </tr>
       <tr>
       <td style="vertical-align:middle;padding:0!important;">
           <a href="/web/20120121201733*/http://rubyquiz.com/quiz64.html" style="color:#33f;font-size:11px;font-weight:bold;background-color:transparent;border:none;" title="See a list of every capture for this URL"><strong>30 captures</strong></a>
           <div style="margin:0!important;padding:0!important;color:#666;font-size:9px;padding-top:2px!important;white-space:nowrap;" title="Timespan for captures of this URL">16 May 06 - 15 Feb 13</div>
       </td>
       <td style="padding:0!important;">
       <a style="position:relative; white-space:nowrap; width:450px;height:27px;" href="" id="wm-graph-anchor">
       <div id="wm-ipp-sparkline" style="position:relative; white-space:nowrap; width:450px;height:27px;background-color:#fff;cursor:pointer;border-right:1px solid #ccc;" title="Explore captures for this URL">
			<img id="sparklineImgId" style="position:absolute; z-index:9012; top:0px; left:0px;"
				onmouseover="showTrackers('inline');" 
				onmouseout="showTrackers('none');"
				onmousemove="trackMouseMove(event,this)"
				alt="sparklines"
				width="450"
				height="27"
				border="0"
				src="/web/jsp/graph.jsp?graphdata=450_27_1996:-1:000000000000_1997:-1:000000000000_1998:-1:000000000000_1999:-1:000000000000_2000:-1:000000000000_2001:-1:000000000000_2002:-1:000000000000_2003:-1:000000000000_2004:-1:000000000000_2005:-1:000000000000_2006:-1:000010000100_2007:-1:000100100000_2008:-1:000020000000_2009:-1:000000000000_2010:-1:000000000010_2011:-1:000000110000_2012:0:10017000a100_2013:-1:010000000000"></img>
			<img id="wbMouseTrackYearImg" 
				style="display:none; position:absolute; z-index:9010;"
				width="25" 
				height="27"
				border="0"
				src="/static/images/toolbar/transp-yellow-pixel.png"></img>
			<img id="wbMouseTrackMonthImg"
				style="display:none; position:absolute; z-index:9011; " 
				width="2"
				height="27" 
				border="0"
				src="/static/images/toolbar/transp-red-pixel.png"></img>
       </div>
		</a>

       </td>
       </tr></tbody></table>
   </td>
   <td style="text-align:right;padding:5px;width:65px;font-size:11px!important;">
       <a href="javascript:;" onclick="document.getElementById('wm-ipp').style.display='none';" style="display:block;padding-right:18px;background:url(/static/images/toolbar/wm_tb_close.png) no-repeat 100% 0;color:#33f;font-family:'Lucida Grande','Arial',sans-serif;margin-bottom:23px;background-color:transparent;border:none;" title="Close the toolbar">Close</a>
       <a href="http://faq.web.archive.org/" style="display:block;padding-right:18px;background:url(/static/images/toolbar/wm_tb_help.png) no-repeat 100% 0;color:#33f;font-family:'Lucida Grande','Arial',sans-serif;background-color:transparent;border:none;" title="Get some help using the Wayback Machine">Help</a>
   </td>
   </tr></tbody></table>

</div>
</div>
<script type="text/javascript">
 var wmDisclaimBanner = document.getElementById("wm-ipp");
 if(wmDisclaimBanner != null) {
   disclaimElement(wmDisclaimBanner);
 }
</script>
<!-- END WAYBACK TOOLBAR INSERT -->

	<div id="page">
		<div id="header"><span class="ruby">Ruby</span> <span class="quiz">Quiz</span></div>
		<div id="content">
			<span class="title">Port a Library (#64)</span>
			<p>Twice this week, I've gone looking for the Ruby equivalent to a simple Perl module and had trouble finding what I was after.  Both times I've peeked inside the source and been surprised at how trivial the operations are.  "I could port that in no time,"  I thought.  This quiz is my thinly disguised attempt to pass my homework on to others.  :)</p>
			<p>Seriously, this quiz is *not* intended to be a lot of work.  Don't underestimate the power of a simple library.  (See the "Rethinking Memoization" thread where we are trying to improve a very helpful library that is literally 10 lines of code, in one of the forms presented.)</p>
			<p>Given all that, this is a build-it-yourself Ruby Quiz.  Most of us are familiar with another language.  Go into their libraries and find something you like, that is also simple, and port the library to Ruby.  (You might want to search the RAA and RubyForge first, just to make sure someone hasn't done similar work already.)  If a library is over 200 lines, forget it.  This one is for the little guys!</p>
			<p>If you'll allow a brief aside here, it can be interesting to consider what the word "port" means.  Obviously, the goal of this is to build a library that does the same things for Ruby.  Don't think that means you should copy every method, verbatim though.  If you don't think a method is needed, leave it out.  See a better way to do something, use your way.  Most important though, remember to Rubyize the interface.  It's fine to port your favorite Java library, but Ruby programmers don't want to call methodsNamedLikeThis().  Watch for chances to use blocks and jump on them *when they lead to a better experience*.  Just remember the adage, "If it ain't broke, don't fix it."</p>
			<p>A few more details:  Please tell us what your library does and show an example of simple usage in your submission email.  Be kind to your quiz summarizer.  ;)  Also, please credit the original library and author who worked so hard to give you something cool to play with!</p>
			<p>Now, if you have no idea what to port, here are two suggestions.  (Please feel free to post other suggestions to Ruby Talk.  These are *not* spoilers!)</p>
			<p class="example">File::ReadBackwards</p>
			<p>This is a Perl module (by Uri Guttman) for reading a file in reverse, line-by-line.  This can often be helpful for things like log files, where the interesting information is usually at the end.</p>
			<p>Don't worry about the Perl interface on this one, copy Ruby's File instead.  Heck, all I really want is a foreach() iterator.  Anything else is extra.</p>
			<p>This module is so well commented, you should be able to understand how it works, even if you aren't familiar with Perl.  Here's a link straight to the source:</p>
			<p><a href="/web/20120121201733/http://search.cpan.org/src/URI/File-ReadBackwards-1.04/ReadBackwards.pm">File::ReadBackwards Source on the CPAN</a></p>
			<p class="example">WWW::RobotRules</p>
			<p>This is another Perl module (by Gisle Aas) and it is actually over the 200 line limit.  Trust me though, it doesn't need to be.  :)</p>
			<p>The idea here is that many web sites provide a /robots.txt file, telling spider programs which pages they should not visit.  This module gives you a way to parse these rules and make queries about what you are allowed to visit.  You can learn all about the interface and even the file format of /robots.txt at:</p>
			<p><a href="/web/20120121201733/http://search.cpan.org/~gaas/libwww-perl-5.805/lib/WWW/RobotRules.pm">WWW::RobotRules on the CPAN</a></p>
			<hr />
			<p><span class="title">Quiz Summary</span></p>
			<p>The great element of porting a library is that you get examine another programmer's ideas.  If you're lucky, that may teach you a new trick or two.  I'll use my experience as an example.</p>
			<p class="example">Using Buffers</p>
			<p>When I decided to port File::ReadBackwards, the first question I asked myself was, how do you read a file backwards?  I decided that you would need to put the read head at the end of the file, then work it backwards bit by bit.  You can't return a line until you have the whole thing, so I knew I would need to buffer the reads.  I guessed I would be sure I had a line when I had seen two line endings (whatever is between them is a line) or run into the beginning of the file (no more data).  That actually turns out to be the rough process, but, luckily for me, Uri Guttman is smarter than me and reading Uri's code taught me a couple of tricks.</p>
			<p>Here's a simplified version of my port, showing only the interesting methods:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="comment"># Based on Perl's File::ReadBackwards module, by Uri Guttman.</span><br />    <span class="keyword">class</span> Elif<br />      MAX_READ_SIZE = 1 &lt;&lt; 10  <span class="comment"># 1024</span><br /><br />      <span class="keyword">def</span> initialize( *args )<br />        <span class="variable">@file</span> = File.new(*args)<br />        <span class="variable">@file</span>.seek(0, IO::SEEK_END)<br /><br />        <span class="variable">@current_pos</span> = <span class="variable">@file</span>.pos<br /><br />        <span class="variable">@read_size</span> = <span class="variable">@file</span>.pos % MAX_READ_SIZE<br />        <span class="variable">@read_size</span> = MAX_READ_SIZE <span class="keyword">if</span> <span class="variable">@read_size</span>.zero?<br /><br />        <span class="variable">@line_buffer</span> = Array.new<br />      <span class="keyword">end</span><br /><br />      <span class="keyword">def</span> gets( sep_string = <span class="global">$/</span> )<br />        <span class="keyword">return</span> <span class="variable">@line_buffer</span>.pop <span class="keyword">if</span> <span class="variable">@line_buffer</span>.size &gt; 2 <span class="keyword">or</span> <span class="variable">@current_pos</span>.zero?<br /><br />        <span class="variable">@current_pos</span> -= <span class="variable">@read_size</span><br />        <span class="variable">@file</span>.seek(<span class="variable">@current_pos</span>, IO::SEEK_SET)<br /><br />        <span class="variable">@line_buffer</span>[0] = <span class="string">"#{@file.read(@read_size)}#{@line_buffer[0]}"</span><br />        <span class="variable">@read_size</span>      = MAX_READ_SIZE  <span class="comment"># Set a size for the next read.</span><br /><br />        <span class="variable">@line_buffer</span>[0] =<br />          <span class="variable">@line_buffer</span>[0].scan(<span class="string">/.*?#{Regexp.escape(sep_string)}|.+/</span>)<br />        <span class="variable">@line_buffer</span>.flatten!<br /><br />        gets(sep_string)<br />      <span class="keyword">end</span><br />    <span class="keyword">end</span><br /><br /></div></div>
			<p>You can see the first trick Uri taught me in initialize().  Working the pointer backwards can be messy.  You have to keep track of where you are, shift the read pointer back, read some, but always make sure you have that many bytes left.  There's an easier way.</p>
			<p>If you pick some number of bytes you are going to read, you can consider the file to be in chunks that size.  For example, if we are going to read ten bytes at a time and have a twenty-four byte file, we can deal with it in chunks of ten, ten, and four.  The only odd chunk size is at the end, where we start, so we can deal with that immediately and then all future reads can be whatever chunk size we selected.</p>
			<p>That's what initialize() is doing:  Open the file, jump to the end, and set that initial read size to handle the dangling partial chunk.</p>
			<p>Now we can tackle gets() and I'll tell you about the other lesson Uri taught me.  First, the function of gets() is pretty basic:  If we know we have a line or that we are out of lines, return it or nil.  Otherwise, read some more data, trying to make one of those two exit conditions true, and recurse.  The only hard part is deciding when we have a line.</p>
			<p>I was dreaming up a complicated solution to this, when reading Uri's code showed me the light.  You can store the data in the buffer exactly like it is in the file (or whatever we've read of it so far).  We will break it at lines though, because that's what we're interested in reading.  At any given time, it's very likely the buffer holds a partial line (because we haven't seen the rest).  However, if we have at least two lines buffered, we can return one immediately.  One of them is likely a partial sure, but the last one, the one the user wants, must be full now.  This is easy to code, as you can see above.</p>
			<p>In gets(), I prepend each read to the first (likely partial) line.  Then I use scan() to find all the lines in there, creating an Array, then flatten!() to fold those lines back into the buffer, discarding the extra Array.</p>
			<p>Thanks for the lessons Uri!</p>
			<p>You really pick these insights up from reading the code of others, which is why I think reading code is important.  This is one of the big perks of running the Ruby Quiz.  I get to read a lot of code and the submissions are always teaching me things.  This week was no different, so now let me tell you what I learned from others.</p>
			<p class="example">Lazy Evaluation</p>
			<p>This next library came at just the right time for me.  I'm reading Higher-Order Perl, by Mark Jason Dominus, and trying to apply the ideas I am learning there to my Ruby usage.  One of the big concepts in the book is "lazy" code, which is just a fancy way of saying, I want to run this... later.</p>
			<p>There are a lot of advantages to something like this.  If an operation is expensive in computational terms, we can assure that it doesn't happen until it is needed.  The advantage to that is that it may not be needed at all, which keeps us from wasting time.</p>
			<p>Another less-used example is that we can delay evaluation until we have more information.  The standard PStore library is a great example here.  You pass it the path to the cache file in initialize(), but it waits until transaction() to actually open the file.  The reason is that you can start a "read-only" transaction, or a normal transaction that allows reading and writing.  By waiting to open the file, PStore knows the right mode to use, the right level of file locking to apply, etc.</p>
			<p>The tricky part to lazy evaluation, for me at least, is just getting your head around it.  When you decide you're ready though, here is an excellent first step:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="keyword">module</span> Trampoline<br />       <span class="comment"># Instance methods</span><br />       <span class="keyword">class</span> Bounce<br />          <span class="keyword">def</span> initialize(cons, klass, *args)<br />             <span class="variable">@klass</span>, <span class="variable">@cons</span>, <span class="variable">@args</span> = klass, cons, args<br />          <span class="keyword">end</span><br /><br />          <span class="keyword">def</span> method_missing(method, *args)<br />             <span class="variable">@obj</span> = <span class="variable">@klass</span>.send(<span class="variable">@cons</span>, *<span class="variable">@args</span>) <span class="keyword">unless</span> <span class="variable">@obj</span><br />             <span class="variable">@obj</span>.send(method, *args)<br />          <span class="keyword">end</span><br />       <span class="keyword">end</span><br /><br />       <span class="comment"># Class methods</span><br />       <span class="keyword">class</span> &lt;&lt; Bounce<br />          alias_method :old_new, :new<br /><br />          <span class="keyword">def</span> new(*args)<br />             old_new(:new, *args)<br />          <span class="keyword">end</span><br /><br />          <span class="keyword">def</span> method_missing(method, *args)<br />             old_new(method, *args)<br />          <span class="keyword">end</span><br />       <span class="keyword">end</span><br />    <span class="keyword">end</span><br /><br /></div></div>
			<p>That's Matthew Moss's port of the Perl Trampoline module, by Steven Lembark.  Let's break down what this does.</p>
			<p>First, the instance methods.  It seems that initialize() doesn't do anything except store some information.  We will find out what for in method_missing().</p>
			<p>Remember that method_missing() will be called for any message we haven't defined.  In this case, that's pretty much everything.  (More on that in a minute...)  When called, method_missing() makes sure @obj is defined.  If it's not, it is created by calling the proper cons(tructor) with the args initialize() tucked away.  Then the message is just forwarded to @obj.  That means the object is built just before the first method call, then reused to handle all future method calls.</p>
			<p>The only problem with the above strategy is that Bounce includes some default Ruby methods inherited from Object.  This means that something like a to_s() call isn't forwarded.  You can fix this by adding something like the following to Bounce:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    instance_methods.each { |m| undef_method m <span class="keyword">unless</span> m =~ <span class="string">/^__/</span> }<br /><br /></div></div>
			<p>Now let's look at the class methods. You can see that new() is moved and redefined, to change its interface for calling code.  Now we see another method_missing(), this time for the class itself.  It works just like the redefined new(), forwarding the message to the constructor.  Remember, not all objects are constructed with new().  Singleton objects often use instance(), for example.  This method allows for that.  Whatever is called will later be used to build the object.</p>
			<p>That's a great introduction to lazy evaluation.  When that sinks in a bit and you're ready for more, see the excellent lazy.rb library by MenTaLguY:</p>
			<p><a href="/web/20120121201733/http://moonbase.rydia.net/software/lazy.rb/">lazy.rb</a></p>
			<p class="example">Currying</p>
			<p>Another interesting technique discussed in Higher-Order Perl was also represented in the solutions to this quiz.  Ross Bamford ported Perl's Sub::Curry module by Johan Lodin.  Currying is basically the process of using functions to manufacture other functions, as seen in these simple examples:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    require <span class="string">"curry"</span><br /><br />    scale = lambda { |size, object| object * size }<br /><br />    puts <span class="string">"3 scaleded to a size of 10 is #{scale[10, 3]}."</span>  <span class="comment"># 30</span><br />    puts<br /><br />    <span class="comment"># curry some functions</span><br />    double = scale.curry(2)<br />    triple = scale.curry(3)<br />    halve  = scale.curry(0.5)<br /><br />    puts <span class="string">"4 doubled is #{double[4]}."</span>   <span class="comment"># 8</span><br />    puts <span class="string">"1 tripled is #{triple[1]}."</span>   <span class="comment"># 3</span><br />    puts <span class="string">"Half of 10 is #{halve[10]}."</span>  <span class="comment"># 5.0</span><br /><br /></div></div>
			<p>The great side of this library is that it can handle much more complicated argument setups than this.  For example, what if the arguments to scale had been reversed?  No problem:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    scale = lambda { |object, size| object * size }<br /><br />    puts <span class="string">"3 scaleded to a size of 10 is #{scale[10, 3]}."</span>  <span class="comment"># 30</span><br />    puts<br /><br />    <span class="comment"># we can leave "holes" in the argument list</span><br />    double = scale.curry(Curry::HOLE, 2)<br />    triple = scale.curry(Curry::HOLE, 3)<br />    halve  = scale.curry(Curry::HOLE, 0.5)<br /><br />    puts <span class="string">"4 doubled is #{double[4]}."</span>   <span class="comment"># 8</span><br />    puts <span class="string">"1 tripled is #{triple[1]}."</span>   <span class="comment"># 3</span><br />    puts <span class="string">"Half of 10 is #{halve[10]}."</span>  <span class="comment"># 5.0</span><br /><br /></div></div>
			<p>That works exactly the same, but if you're not impressed yet we can get even fancier.  The library already supports a bunch of "spices", like HOLE above, but you can also add your own:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="comment"># Lazy Evaluation meets Currying...</span><br />    <span class="keyword">class</span> LazySpice &lt; Curry::SpiceArg<br />      <span class="keyword">def</span> initialize( &amp;promise )<br />        <span class="keyword">super</span>(<span class="string">"LAZYSPICE"</span>)<br /><br />        <span class="variable">@promise</span> = promise<br />      <span class="keyword">end</span><br /><br />      <span class="keyword">def</span> spice_arg( args )  <span class="comment"># called to provide the missing argument</span><br />        [<span class="variable">@promise</span>.call]<br />      <span class="keyword">end</span><br />    <span class="keyword">end</span><br /><br />    logger = lambda <span class="keyword">do</span> |time, message|<br />      puts <span class="string">"[#{time.strftime('%I:%M:%S %p %m/%d/%y')}] #{message}"</span><br />    <span class="keyword">end</span><br /><br />    log_now = logger.curry(LazySpice.new { Time.now })<br /><br />    log_now[<span class="string">"First Message."</span>]   <span class="comment"># =&gt; [12:47:53 PM 02/01/06] First Message.</span><br />    sleep 3<br />    log_now[<span class="string">"Second Message."</span>]  <span class="comment"># =&gt; [12:47:56 PM 02/01/06] Second Message.</span><br /><br /></div></div>
			<p>Notice how the LazySpice isn't evaluated until the time of the call.  That lazy execution makes sure our message is stamped with the time it was actually logged.</p>
			<p>I'm not going to show the library here, since I've gone on long enough, but I hope you will agree that it's worth a look.</p>
			<p class="example">Wrap Up</p>
			<p>Please take some time to look into the other solutions I didn't cover here.  All of them were interesting ideas and I hope their authors will consider packaging them up for all to use.</p>
			<p>Myself, and others, were worried that this would not be a popular quiz.  It far exceeded my expectations though and I owe a big thank you to all who made that happen!  You are all so clever it makes even me look good.</p>
			<p>We'll go back to a more traditional Ruby Quiz problem tomorrow, I promise.  This time we will borrow a problem from the Code Katas...</p>
		</div>
		<div id="logo"><img src="/web/20120121201733im_/http://rubyquiz.com/images/ruby_quiz_logo.jpg" alt="" width="157" height="150" /></div>
		<div id="links">
			<span class="title">Quiz Solutions</span>
			<ol>
				<li><a href="/web/20120121201733/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/177343">Ross Bamford</a></li>
				<li><a href="/web/20120121201733/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/177347">James Edward Gray II</a></li>
				<li><a href="/web/20120121201733/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/177355">Christian Neukirchen</a></li>
				<li><a href="/web/20120121201733/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/177468">Matthew Moss</a></li>
				<li><a href="/web/20120121201733/http://groups.google.com/group/comp.lang.ruby/msg/bebef4f908a8bb9a">Martin DeMello</a></li>
				<li><a href="/web/20120121201733/http://groups.google.com/group/comp.lang.ruby/msg/025067c6960b9e1e">amrangaye</a></li>
				<li><a href="/web/20120121201733/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/177589">James Edward Gray II (2)</a></li>
				<li><a href="/web/20120121201733/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/177618">Adam Shelly</a></li>
			</ol>
			<p><a href="/web/20120121201733/http://rubyquiz.com/quiz64_sols.zip">Download Solutions</a></p>
			<p><a href="/web/20120121201733/http://rubyquiz.com/index.html">Back to Quiz Listing</a></p>
		</div>
		<div id="footer">&nbsp;</div>
	</div>
</body>
</html>





<!--
     FILE ARCHIVED ON 20:17:33 Jan 21, 2012 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 13:09:56 Jun 5, 2013.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
