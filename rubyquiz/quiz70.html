<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>


<!-- Start Wayback Rewrite JS Include -->
<script type="text/javascript" src="/static/js/jwplayer/jwplayer.js" ></script>
<script type="text/javascript" src="/static/js/video-embed-rewriter.js"></script>
<script type="text/javascript">
function initYTVideo(id)
{
	_wmVideos_.init("/web/", id);
}
</script>
<!-- End Wayback Rewrite JS Include -->

	<title>Ruby Quiz - Constraint Processing (#70)</title>
	<link rel="stylesheet" type="text/css" href="/web/20120121221601cs_/http://rubyquiz.com/quiz.css" />
	<link rel="stylesheet" type="text/css" href="/web/20120121221601cs_/http://rubyquiz.com/print.css" media="print" />
</head><body>
<!-- BEGIN WAYBACK TOOLBAR INSERT -->

<script type="text/javascript" src="/static/js/disclaim-element.js" ></script>
<script type="text/javascript" src="/static/js/graph-calc.js" ></script>
<script type="text/javascript" src="/static/jflot/jquery.min.js" ></script>
<script type="text/javascript">
//<![CDATA[
var firstDate = 820454400000;
var lastDate = 1388534399999;
var wbPrefix = "/web/";
var wbCurrentUrl = "http:\/\/rubyquiz.com\/quiz70.html";

var curYear = -1;
var curMonth = -1;
var yearCount = 18;
var firstYear = 1996;
var imgWidth = 450;
var yearImgWidth = 25;
var monthImgWidth = 2;
var trackerVal = "none";
var displayDay = "21";
var displayMonth = "Jan";
var displayYear = "2012";
var prettyMonths = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

function showTrackers(val) {
	if(val == trackerVal) {
		return;
	}
	if(val == "inline") {
		document.getElementById("displayYearEl").style.color = "#ec008c";
		document.getElementById("displayMonthEl").style.color = "#ec008c";
		document.getElementById("displayDayEl").style.color = "#ec008c";		
	} else {
		document.getElementById("displayYearEl").innerHTML = displayYear;
		document.getElementById("displayYearEl").style.color = "#ff0";
		document.getElementById("displayMonthEl").innerHTML = displayMonth;
		document.getElementById("displayMonthEl").style.color = "#ff0";
		document.getElementById("displayDayEl").innerHTML = displayDay;
		document.getElementById("displayDayEl").style.color = "#ff0";
	}
   document.getElementById("wbMouseTrackYearImg").style.display = val;
   document.getElementById("wbMouseTrackMonthImg").style.display = val;
   trackerVal = val;
}
function getElementX2(obj) {
	var thing = jQuery(obj);
	if((thing == undefined) 
			|| (typeof thing == "undefined") 
			|| (typeof thing.offset == "undefined")) {
		return getElementX(obj);
	}
	return Math.round(thing.offset().left);
}
function trackMouseMove(event,element) {

   var eventX = getEventX(event);
   var elementX = getElementX2(element);
   var xOff = eventX - elementX;
	if(xOff < 0) {
		xOff = 0;
	} else if(xOff > imgWidth) {
		xOff = imgWidth;
	}
   var monthOff = xOff % yearImgWidth;

   var year = Math.floor(xOff / yearImgWidth);
	var yearStart = year * yearImgWidth;
   var monthOfYear = Math.floor(monthOff / monthImgWidth);
   if(monthOfYear > 11) {
       monthOfYear = 11;
   }
   // 1 extra border pixel at the left edge of the year:
   var month = (year * 12) + monthOfYear;
   var day = 1;
	if(monthOff % 2 == 1) {
		day = 15;
	}
	var dateString = 
		zeroPad(year + firstYear) + 
		zeroPad(monthOfYear+1,2) +
		zeroPad(day,2) + "000000";

	var monthString = prettyMonths[monthOfYear];
	document.getElementById("displayYearEl").innerHTML = year + 1996;
	document.getElementById("displayMonthEl").innerHTML = monthString;
	// looks too jarring when it changes..
	//document.getElementById("displayDayEl").innerHTML = zeroPad(day,2);

	var url = wbPrefix + dateString + '/' +  wbCurrentUrl;
	document.getElementById('wm-graph-anchor').href = url;

   //document.getElementById("wmtbURL").value="evX("+eventX+") elX("+elementX+") xO("+xOff+") y("+year+") m("+month+") monthOff("+monthOff+") DS("+dateString+") Moy("+monthOfYear+") ms("+monthString+")";
   if(curYear != year) {
       var yrOff = year * yearImgWidth;
       document.getElementById("wbMouseTrackYearImg").style.left = yrOff + "px";
       curYear = year;
   }
   if(curMonth != month) {
       var mtOff = year + (month * monthImgWidth) + 1;
       document.getElementById("wbMouseTrackMonthImg").style.left = mtOff + "px";
       curMonth = month;
   }
}
//]]>
</script>

<style type="text/css">body{margin-top:0!important;padding-top:0!important;min-width:800px!important;}#wm-ipp a:hover{text-decoration:underline!important;}</style>
<div id="wm-ipp" style="display:none; position:relative;padding:0 5px;min-height:70px;min-width:800px; z-index:9000;">
<div id="wm-ipp-inside" style="position:fixed;padding:0!important;margin:0!important;width:97%;min-width:780px;border:5px solid #000;border-top:none;background-image:url(/static/images/toolbar/wm_tb_bk_trns.png);text-align:center;-moz-box-shadow:1px 1px 3px #333;-webkit-box-shadow:1px 1px 3px #333;box-shadow:1px 1px 3px #333;font-size:11px!important;font-family:'Lucida Grande','Arial',sans-serif!important;">
   <table style="border-collapse:collapse;margin:0;padding:0;width:100%;"><tbody><tr>
   <td style="padding:10px;vertical-align:top;min-width:110px;">
   <a href="/web/" title="Wayback Machine home page" style="background-color:transparent;border:none;"><img src="/static/images/toolbar/wayback-toolbar-logo.png" alt="Wayback Machine" width="110" height="39" border="0"/></a>
   </td>
   <td style="padding:0!important;text-align:center;vertical-align:top;width:100%;">

       <table style="border-collapse:collapse;margin:0 auto;padding:0;width:570px;"><tbody><tr>
       <td style="padding:3px 0;" colspan="2">
       <form target="_top" method="get" action="/web/form-submit.jsp" name="wmtb" id="wmtb" style="margin:0!important;padding:0!important;"><input type="text" name="url" id="wmtbURL" value="http://rubyquiz.com/quiz70.html" style="width:400px;font-size:11px;font-family:'Lucida Grande','Arial',sans-serif;" onfocus="javascript:this.focus();this.select();" /><input type="hidden" name="type" value="replay" /><input type="hidden" name="date" value="20120121221601" /><input type="submit" value="Go" style="font-size:11px;font-family:'Lucida Grande','Arial',sans-serif;margin-left:5px;" /><span id="wm_tb_options" style="display:block;"></span></form>
       </td>
       <td style="vertical-align:bottom;padding:5px 0 0 0!important;" rowspan="2">
           <table style="border-collapse:collapse;width:110px;color:#99a;font-family:'Helvetica','Lucida Grande','Arial',sans-serif;"><tbody>
			
           <!-- NEXT/PREV MONTH NAV AND MONTH INDICATOR -->
           <tr style="width:110px;height:16px;font-size:10px!important;">
           	<td style="padding-right:9px;font-size:11px!important;font-weight:bold;text-transform:uppercase;text-align:right;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20110709071527/http://www.rubyquiz.com/quiz70.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="9 Jul 2011"><strong>JUL</strong></a>
		                
               </td>
               <td id="displayMonthEl" style="background:#000;color:#ff0;font-size:11px!important;font-weight:bold;text-transform:uppercase;width:34px;height:15px;padding-top:1px;text-align:center;" title="You are here: 22:16:01 Jan 21, 2012">JAN</td>
				<td style="padding-left:9px;font-size:11px!important;font-weight:bold;text-transform:uppercase;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20120418110802/http://www.rubyquiz.com/quiz70.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="18 Apr 2012"><strong>APR</strong></a>
		                
               </td>
           </tr>

           <!-- NEXT/PREV CAPTURE NAV AND DAY OF MONTH INDICATOR -->
           <tr>
               <td style="padding-right:9px;white-space:nowrap;overflow:visible;text-align:right!important;vertical-align:middle!important;" nowrap="nowrap">
               
		                <a href="/web/20110709071527/http://www.rubyquiz.com/quiz70.html" title="7:15:27 Jul 9, 2011" style="background-color:transparent;border:none;"><img src="/static/images/toolbar/wm_tb_prv_on.png" alt="Previous capture" width="14" height="16" border="0" /></a>
		                
               </td>
               <td id="displayDayEl" style="background:#000;color:#ff0;width:34px;height:24px;padding:2px 0 0 0;text-align:center;font-size:24px;font-weight: bold;" title="You are here: 22:16:01 Jan 21, 2012">21</td>
				<td style="padding-left:9px;white-space:nowrap;overflow:visible;text-align:left!important;vertical-align:middle!important;" nowrap="nowrap">
               
		                <a href="/web/20120122034834/http://rubyquiz.com/quiz70.html" title="3:48:34 Jan 22, 2012" style="background-color:transparent;border:none;"><img src="/static/images/toolbar/wm_tb_nxt_on.png" alt="Next capture" width="14" height="16" border="0"/></a>
		                
			    </td>
           </tr>

           <!-- NEXT/PREV YEAR NAV AND YEAR INDICATOR -->
           <tr style="width:110px;height:13px;font-size:9px!important;">
				<td style="padding-right:9px;font-size:11px!important;font-weight: bold;text-align:right;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20101127181106/http://rubyquiz.com/quiz70.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="27 Nov 2010"><strong>2010</strong></a>
		                
               </td>
               <td id="displayYearEl" style="background:#000;color:#ff0;font-size:11px!important;font-weight: bold;padding-top:1px;width:34px;height:13px;text-align:center;" title="You are here: 22:16:01 Jan 21, 2012">2012</td>
				<td style="padding-left:9px;font-size:11px!important;font-weight: bold;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20130215053028/http://rubyquiz.com/quiz70.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="15 Feb 2013"><strong>2013</strong></a>
		                
				</td>
           </tr>
           </tbody></table>
       </td>

       </tr>
       <tr>
       <td style="vertical-align:middle;padding:0!important;">
           <a href="/web/20120121221601*/http://rubyquiz.com/quiz70.html" style="color:#33f;font-size:11px;font-weight:bold;background-color:transparent;border:none;" title="See a list of every capture for this URL"><strong>39 captures</strong></a>
           <div style="margin:0!important;padding:0!important;color:#666;font-size:9px;padding-top:2px!important;white-space:nowrap;" title="Timespan for captures of this URL">12 Apr 06 - 15 Feb 13</div>
       </td>
       <td style="padding:0!important;">
       <a style="position:relative; white-space:nowrap; width:450px;height:27px;" href="" id="wm-graph-anchor">
       <div id="wm-ipp-sparkline" style="position:relative; white-space:nowrap; width:450px;height:27px;background-color:#fff;cursor:pointer;border-right:1px solid #ccc;" title="Explore captures for this URL">
			<img id="sparklineImgId" style="position:absolute; z-index:9012; top:0px; left:0px;"
				onmouseover="showTrackers('inline');" 
				onmouseout="showTrackers('none');"
				onmousemove="trackMouseMove(event,this)"
				alt="sparklines"
				width="450"
				height="27"
				border="0"
				src="/web/jsp/graph.jsp?graphdata=450_27_1996:-1:000000000000_1997:-1:000000000000_1998:-1:000000000000_1999:-1:000000000000_2000:-1:000000000000_2001:-1:000000000000_2002:-1:000000000000_2003:-1:000000000000_2004:-1:000000000000_2005:-1:000000000000_2006:-1:000110000100_2007:-1:000100200000_2008:-1:000020000000_2009:-1:000000000000_2010:-1:100000000010_2011:-1:000000100000_2012:0:3001c000a100_2013:-1:010000000000"></img>
			<img id="wbMouseTrackYearImg" 
				style="display:none; position:absolute; z-index:9010;"
				width="25" 
				height="27"
				border="0"
				src="/static/images/toolbar/transp-yellow-pixel.png"></img>
			<img id="wbMouseTrackMonthImg"
				style="display:none; position:absolute; z-index:9011; " 
				width="2"
				height="27" 
				border="0"
				src="/static/images/toolbar/transp-red-pixel.png"></img>
       </div>
		</a>

       </td>
       </tr></tbody></table>
   </td>
   <td style="text-align:right;padding:5px;width:65px;font-size:11px!important;">
       <a href="javascript:;" onclick="document.getElementById('wm-ipp').style.display='none';" style="display:block;padding-right:18px;background:url(/static/images/toolbar/wm_tb_close.png) no-repeat 100% 0;color:#33f;font-family:'Lucida Grande','Arial',sans-serif;margin-bottom:23px;background-color:transparent;border:none;" title="Close the toolbar">Close</a>
       <a href="http://faq.web.archive.org/" style="display:block;padding-right:18px;background:url(/static/images/toolbar/wm_tb_help.png) no-repeat 100% 0;color:#33f;font-family:'Lucida Grande','Arial',sans-serif;background-color:transparent;border:none;" title="Get some help using the Wayback Machine">Help</a>
   </td>
   </tr></tbody></table>

</div>
</div>
<script type="text/javascript">
 var wmDisclaimBanner = document.getElementById("wm-ipp");
 if(wmDisclaimBanner != null) {
   disclaimElement(wmDisclaimBanner);
 }
</script>
<!-- END WAYBACK TOOLBAR INSERT -->

	<div id="page">
		<div id="header"><span class="ruby">Ruby</span> <span class="quiz">Quiz</span></div>
		<div id="content">
			<span class="title">Constraint Processing (#70)</span>
			<p>by Jay Anderson</p>
			<p>For this quiz the goal is to make a constraint processing library for ruby. A Constraint Satisfaction Problem consists of variables, domains for each variable, and constraints among the variables. Here's a sample (Solutions DO NOT need to follow this syntax, this is just an example): </p>
			<div class="code"><span class="type">ruby</span><div class="body">    a = IntVar.new(:a, (0..4).to_a) <span class="comment">#Set up the variables and their domains.</span><br />    b = IntVar.new(:b, (0..4).to_a)<br />    c = IntVar.new(:c, (0..4).to_a)<br />    con1 = a &lt; b <span class="comment">#Create constraints on the problem.</span><br />    con2 = a + b == c<br />    prob = Problem.new(con1, con2) <span class="comment">#Create a problem with the constraints</span><br />    solution = prob.solve <span class="comment">#Find a solution</span><br />    p solution<br /><br /></div></div>
			<p>There are many solutions. It could return any (or all) of the following:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    {:a =&gt; 0, :b =&gt; 1, :c =&gt; 1}<br />    {:a =&gt; 0, :b =&gt; 2, :c =&gt; 2}<br />    {:a =&gt; 0, :b =&gt; 3, :c =&gt; 3}<br />    {:a =&gt; 0, :b =&gt; 4, :c =&gt; 4}<br />    {:a =&gt; 1, :b =&gt; 2, :c =&gt; 3}<br />    {:a =&gt; 1, :b =&gt; 3, :c =&gt; 4}<br /><br /></div></div>
			<p>Another example would be to solve the magic square: </p>
			<div class="code"><span class="type">ruby</span><div class="body">    SIDE = 3<br />    MAX = SIDE**2<br />    SUM = (MAX*(MAX+1))/(2*SIDE)<br />    square = Array.new(SIDE) <span class="keyword">do</span> |x|<br />      Array.new(SIDE) {|y| IntVar.new(<span class="string">"#{x},#{y}"</span>, (1..MAX).to_a ) }<br />    <span class="keyword">end</span><br />    cons = []<br />    zero = IntVar.new(:zero, [0])<br />    SIDE.times <span class="keyword">do</span> |row|<br />    ÊÊÊ sum = zero<br />    ÊÊÊ SIDE.times {|col| sum += square[col][row] }<br />    ÊÊÊ cons &lt;&lt; sum == SUM<br />    <span class="keyword">end</span><br />    SIDE.times <span class="keyword">do</span> |col|<br />    ÊÊÊ sum = zero<br />    ÊÊÊ SIDE.times {|row| sum += square[col][row] }<br />    ÊÊÊ cons &lt;&lt; sum == SUM<br />    <span class="keyword">end</span><br />    <span class="comment">#A constraint to ensure no two variables have the same value in a solution.</span><br />    cons &lt;&lt; AllDistinct.new(*square.flatten)<br />    prob = Problem.new(*cons)<br />    solution = prob.solve<br />    p solution<br /><br /></div></div>
			<p>There are many problems that can be solved through constraint programming (even some past quizzes): gift exchanges, sudoku, magic squares, N queens, cryptoarithmetics, scheduling problems, etc... So be creative here. Pick a simple problem to solve with your Constraint Programming Engine. </p>
			<p>Good luck!</p>
			<p>For more information see:</p>
			<p><a href="/web/20120121221601/http://ktiml.mff.cuni.cz/~bartak/constraints/">On-line Guide to Constraint Programming</a></p>
			<p>and:</p>
			<p><a href="/web/20120121221601/http://en.wikipedia.org/wiki/Constraint_programming">Constraint programming</a></p>
			<hr />
			<p><span class="title">Quiz Summary</span></p>
			<p>Constraint processing is a form of declarative programming which, in the words of Dave Burt, "...allows you to find solutions to mathematical problems by stating the problem rather than the steps to the solution."  As indicated in the quiz, this can be used to solve all manner of problems without the programmer needing to find clever algorithms for each one.</p>
			<p>Generally, satisfying constraints will involve some form of backtracking search.  We can try some values and then back up to make different choices when the conditions of the problem begin failing.  Jim Weirich's mystical amb.rb library handles the back up with continuations, so let's see if we can make some sense of that.  Here's Jim's solution to the trivial quiz example:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    require <span class="string">'amb'</span><br /><br />    A = Amb.new<br /><br />    <span class="keyword">begin</span><br />      a = A.choose(*(0..4))<br />      b = A.choose(*(0..4))<br />      c = A.choose(*(0..4))<br /><br />      A.assert a &lt; b<br />      A.assert a + b == c<br /><br />      puts <span class="string">"a=#{a}, b=#{b}, c=#{c}"</span><br /><br />      A.failure<br /><br />    <span class="keyword">rescue</span> Amb::ExhaustedError<br />      puts <span class="string">"No More Solutions"</span><br />    <span class="keyword">end</span><br /><br /></div></div>
			<p>Running that gives the expected results:</p>
			<p class="example">a=0, b=1, c=1<br />a=0, b=2, c=2<br />a=0, b=3, c=3<br />a=0, b=4, c=4<br />a=1, b=2, c=3<br />a=1, b=3, c=4<br />No More Solutions</p>
			<p>Let's change the program ever so slightly though, so we can watch it work.  Here's the same code, with a bunch of debugging statements added:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    require <span class="string">'amb'</span><br /><br />    A = Amb.new<br /><br />    <span class="keyword">begin</span><br />      a = A.choose(*(0..4))<br />      puts <span class="string">"a=#{a}"</span> <span class="keyword">if</span> <span class="global">$DEBUG</span><br />      b = A.choose(*(0..4))<br />      puts <span class="string">"b=#{b}"</span> <span class="keyword">if</span> <span class="global">$DEBUG</span><br />      c = A.choose(*(0..4))<br />      puts <span class="string">"c=#{c}"</span> <span class="keyword">if</span> <span class="global">$DEBUG</span><br /><br />      puts <span class="string">'Asserting a &lt; b...'</span> <span class="keyword">if</span> <span class="global">$DEBUG</span><br />      A.assert a &lt; b<br />      puts <span class="string">'Asserting a + b == c...'</span> <span class="keyword">if</span> <span class="global">$DEBUG</span><br />      A.assert a + b == c<br /><br />      puts <span class="string">"a=#{a}, b=#{b}, c=#{c}"</span><br /><br />      puts <span class="string">'Forcing failure to search for the next solution...'</span> <span class="keyword">if</span> <span class="global">$DEBUG</span><br />      A.failure<br /><br />    <span class="keyword">rescue</span> Amb::ExhaustedError<br />      puts <span class="string">"No More Solutions"</span><br />    <span class="keyword">end</span><br /><br /></div></div>
			<p>Now, if we run that with Ruby's -d switch, we learn a lot more:</p>
			<p class="example">a=0<br />b=0<br />c=0<br />Asserting a &lt; b...<br />c=1<br />Asserting a &lt; b...<br />c=2<br />Asserting a &lt; b...<br />c=3<br />Asserting a &lt; b...<br />c=4<br />Asserting a &lt; b...<br />b=1<br />c=0<br />Asserting a &lt; b...<br />Asserting a + b == c...<br />c=1<br />Asserting a &lt; b...<br />Asserting a + b == c...<br />a=0, b=1, c=1<br />Forcing failure to search for the next solution...<br />c=2<br />...</p>
			<p>Notice that initially a, b, and c all equal the first choice.  When we get to the point of asserting that a &lt; b, the program magically backs up and begins trying different choices for c.  It runs through all of those choices, but none of them will satisfy a condition involving a and b.  The program is then forced to back up again, but this time to try new choices for b.  The first new choice finally satisfies a &lt; b so c is set back to the first option of 0 and we get to move on.  Asserting a + b == c triggers a final retry for c and then we have an actual solution that gets printed.  At that point, a failure is triggered manually, so the search can continue for more solutions.</p>
			<p>Seeing that work is almost mystical.  The program leaps all over the place without a control structure in sight.  How does it accomplish this?  Continuations.  It's time we look into amb.rb:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="keyword">class</span> Amb<br />      <span class="keyword">class</span> ExhaustedError &lt; RuntimeError; <span class="keyword">end</span><br /><br />      <span class="keyword">def</span> initialize<br />        <span class="variable">@fail</span> = proc { fail ExhaustedError, <span class="string">"amb tree exhausted"</span> }<br />      <span class="keyword">end</span><br /><br />      <span class="keyword">def</span> choose(*choices)<br />        prev_fail = <span class="variable">@fail</span><br />        callcc { |sk|<br />          choices.each { |choice|<br />              callcc { |fk|<br />                <span class="variable">@fail</span> = proc {<br />                  <span class="variable">@fail</span> = prev_fail<br />                  fk.call(:fail)<br />                }<br />                <span class="keyword">if</span> choice.respond_to? :call<br />                  sk.call(choice.call)<br />                <span class="keyword">else</span><br />                  sk.call(choice)<br />                <span class="keyword">end</span><br />              }<br />          }<br />          <span class="variable">@fail</span>.call<br />        }<br />      <span class="keyword">end</span><br /><br />      <span class="keyword">def</span> failure<br />        choose<br />      <span class="keyword">end</span><br /><br />      <span class="keyword">def</span> assert(cond)<br />        failure <span class="keyword">unless</span> cond<br />      <span class="keyword">end</span><br />    <span class="keyword">end</span><br /><br /></div></div>
			<p>Not much to it is there?  Only one tricky method to resolve, but let's tackle the little stuff first.  We can see that Amb creates a new error type to represent the search being exhausted and initialize() sets @fail to a Proc object that will throw this error.</p>
			<p>Now skip down to assert().  That just checks the condition for true or false, and calls failure() if needed.  failure() itself is just as simple.  It's just another name for choose() with no arguments.  Even choose() with no arguments is trivial.  First it assigns prev_fail and steps into a continuation block, but neither of those are actually used in this case.  There are no choices, so most of the method is just skipped.  The only meaningful result of the call is to trigger the Proc object in @fail.</p>
			<p>Now we are ready to tackle choose() with arguments, which is the source of the magic.  Here's the method one more time, with some comments added by me:</p>
			<div class="code"><span class="type">ruby</span><div class="body">      <span class="comment"># ...</span><br /><br />      <span class="keyword">def</span> choose(*choices)<br />        prev_fail = <span class="variable">@fail</span><br />        callcc { |sk|<br />          choices.each { |choice|<br />              callcc { |fk|<br />                <span class="variable">@fail</span> = proc {<br />                  <span class="variable">@fail</span> = prev_fail<br />                  fk.call(:fail)<br />                }<br />                <span class="keyword">if</span> choice.respond_to? :call  <span class="comment"># a feature not used in this example</span><br />                  sk.call(choice.call)       <span class="comment"># a feature not used in this example</span><br />                <span class="keyword">else</span>                         <span class="comment"># a feature not used in this example</span><br />                  sk.call(choice)<br />                <span class="keyword">end</span>                          <span class="comment"># a feature not used in this example</span><br />              }  <span class="comment"># end fk:  fk.call(...) will pick up execution on the next line</span><br />          }<br />          <span class="variable">@fail</span>.call<br />        }  <span class="comment"># end sk:  sk.call(arg) with return from the method the value of arg</span><br />      <span class="keyword">end</span><br /><br />      <span class="comment"># ...</span><br /><br /></div></div>
			<p>As the comments indicate, you can safely forget about four lines of this method right off the bat.  These are part of a clever, but not used in this example, feature.</p>
			<p>Now, the sk continuation is the easier one to understand.  When it is triggered, it will cause the method to return its call() argument.  There's not really a lot of magic there, the continuation block is just the last statement in the method and we know that is always returned in Ruby.  Furthermore, Contuation.call() always sets the value of the block to an argument, if provided.  In other words, this is just used to exit from some nested constructs later in this method (similar to a labeled goto in some languages).</p>
			<p>That leaves just one continuation between us and enlightenment.  You can see that the fk continuation is used inside an each iterator for the choices.  Each time a new choice is reached a continuation is generated.</p>
			<p>The first thing that continuation block does is to change the value in @fail.  When called, the new @fail will restore the previous value of @fail and then invoke the fk continuation.  Remember, @fail is first set to an ExhaustedError, but because that keeps getting pushed down on this stack of Proc objects, it won't trigger until we have run out of continuations to try.</p>
			<p>After that, the current choice is simply returned, via the sk continuation we have already discussed.  Now, when the fk continuation is eventually triggered, execution will pick up right after this return.  In other words, we will go to the next iteration for that set of choices, @fail will be reset, and the new choice returned.  When we finally run out of choices, we will hit the @fail.call line, causing the code to back up and try another path.  That's the magic that keeps the search going.</p>
			<p>As always, all the solutions were educational and looking over them could really teach you some new tricks.  My thanks to all who provided them and to Jim for taking us for a walk on the wild side with continuations.</p>
			<p>Tomorrow's quiz will require a little cooperation from your fellow Rubyists to complete...</p>
		</div>
		<div id="logo"><img src="/web/20120121221601im_/http://rubyquiz.com/images/ruby_quiz_logo.jpg" alt="" width="157" height="150" /></div>
		<div id="links">
			<span class="title">Quiz Solutions</span>
			<ol>
				<li><a href="/web/20120121221601/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/183846">Jim Weirich</a></li>
				<li><a href="/web/20120121221601/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/183992">James Edward Gray II</a></li>
				<li><a href="/web/20120121221601/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/184021">Matthew Moss</a></li>
				<li><a href="/web/20120121221601/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/184103">Jonathan Sillito</a></li>
				<li><a href="/web/20120121221601/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/184105">Jim Weirich (2)</a></li>
				<li><a href="/web/20120121221601/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/184190">Dave Burt</a></li>
				<li><a href="/web/20120121221601/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/184376">David Tran</a></li>
				<li><a href="/web/20120121221601/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/184407">Chris Parker</a></li>
				<li><a href="/web/20120121221601/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/184420">Jim Weirich (3)</a></li>
			</ol>
			<p><a href="/web/20120121221601/http://rubyquiz.com/quiz70_sols.zip">Download Solutions</a></p>
			<p><a href="/web/20120121221601/http://rubyquiz.com/index.html">Back to Quiz Listing</a></p>
		</div>
		<div id="footer">&nbsp;</div>
	</div>
</body>
</html>





<!--
     FILE ARCHIVED ON 22:16:01 Jan 21, 2012 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 13:10:02 Jun 5, 2013.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
