<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>


<!-- Start Wayback Rewrite JS Include -->
<script type="text/javascript" src="/static/js/jwplayer/jwplayer.js" ></script>
<script type="text/javascript" src="/static/js/video-embed-rewriter.js"></script>
<script type="text/javascript">
function initYTVideo(id)
{
	_wmVideos_.init("/web/", id);
}
</script>
<!-- End Wayback Rewrite JS Include -->

	<title>Ruby Quiz - B & E (#72)</title>
	<link rel="stylesheet" type="text/css" href="/web/20120121200228cs_/http://rubyquiz.com/quiz.css" />
	<link rel="stylesheet" type="text/css" href="/web/20120121200228cs_/http://rubyquiz.com/print.css" media="print" />
</head><body>
<!-- BEGIN WAYBACK TOOLBAR INSERT -->

<script type="text/javascript" src="/static/js/disclaim-element.js" ></script>
<script type="text/javascript" src="/static/js/graph-calc.js" ></script>
<script type="text/javascript" src="/static/jflot/jquery.min.js" ></script>
<script type="text/javascript">
//<![CDATA[
var firstDate = 820454400000;
var lastDate = 1388534399999;
var wbPrefix = "/web/";
var wbCurrentUrl = "http:\/\/rubyquiz.com\/quiz72.html";

var curYear = -1;
var curMonth = -1;
var yearCount = 18;
var firstYear = 1996;
var imgWidth = 450;
var yearImgWidth = 25;
var monthImgWidth = 2;
var trackerVal = "none";
var displayDay = "21";
var displayMonth = "Jan";
var displayYear = "2012";
var prettyMonths = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

function showTrackers(val) {
	if(val == trackerVal) {
		return;
	}
	if(val == "inline") {
		document.getElementById("displayYearEl").style.color = "#ec008c";
		document.getElementById("displayMonthEl").style.color = "#ec008c";
		document.getElementById("displayDayEl").style.color = "#ec008c";		
	} else {
		document.getElementById("displayYearEl").innerHTML = displayYear;
		document.getElementById("displayYearEl").style.color = "#ff0";
		document.getElementById("displayMonthEl").innerHTML = displayMonth;
		document.getElementById("displayMonthEl").style.color = "#ff0";
		document.getElementById("displayDayEl").innerHTML = displayDay;
		document.getElementById("displayDayEl").style.color = "#ff0";
	}
   document.getElementById("wbMouseTrackYearImg").style.display = val;
   document.getElementById("wbMouseTrackMonthImg").style.display = val;
   trackerVal = val;
}
function getElementX2(obj) {
	var thing = jQuery(obj);
	if((thing == undefined) 
			|| (typeof thing == "undefined") 
			|| (typeof thing.offset == "undefined")) {
		return getElementX(obj);
	}
	return Math.round(thing.offset().left);
}
function trackMouseMove(event,element) {

   var eventX = getEventX(event);
   var elementX = getElementX2(element);
   var xOff = eventX - elementX;
	if(xOff < 0) {
		xOff = 0;
	} else if(xOff > imgWidth) {
		xOff = imgWidth;
	}
   var monthOff = xOff % yearImgWidth;

   var year = Math.floor(xOff / yearImgWidth);
	var yearStart = year * yearImgWidth;
   var monthOfYear = Math.floor(monthOff / monthImgWidth);
   if(monthOfYear > 11) {
       monthOfYear = 11;
   }
   // 1 extra border pixel at the left edge of the year:
   var month = (year * 12) + monthOfYear;
   var day = 1;
	if(monthOff % 2 == 1) {
		day = 15;
	}
	var dateString = 
		zeroPad(year + firstYear) + 
		zeroPad(monthOfYear+1,2) +
		zeroPad(day,2) + "000000";

	var monthString = prettyMonths[monthOfYear];
	document.getElementById("displayYearEl").innerHTML = year + 1996;
	document.getElementById("displayMonthEl").innerHTML = monthString;
	// looks too jarring when it changes..
	//document.getElementById("displayDayEl").innerHTML = zeroPad(day,2);

	var url = wbPrefix + dateString + '/' +  wbCurrentUrl;
	document.getElementById('wm-graph-anchor').href = url;

   //document.getElementById("wmtbURL").value="evX("+eventX+") elX("+elementX+") xO("+xOff+") y("+year+") m("+month+") monthOff("+monthOff+") DS("+dateString+") Moy("+monthOfYear+") ms("+monthString+")";
   if(curYear != year) {
       var yrOff = year * yearImgWidth;
       document.getElementById("wbMouseTrackYearImg").style.left = yrOff + "px";
       curYear = year;
   }
   if(curMonth != month) {
       var mtOff = year + (month * monthImgWidth) + 1;
       document.getElementById("wbMouseTrackMonthImg").style.left = mtOff + "px";
       curMonth = month;
   }
}
//]]>
</script>

<style type="text/css">body{margin-top:0!important;padding-top:0!important;min-width:800px!important;}#wm-ipp a:hover{text-decoration:underline!important;}</style>
<div id="wm-ipp" style="display:none; position:relative;padding:0 5px;min-height:70px;min-width:800px; z-index:9000;">
<div id="wm-ipp-inside" style="position:fixed;padding:0!important;margin:0!important;width:97%;min-width:780px;border:5px solid #000;border-top:none;background-image:url(/static/images/toolbar/wm_tb_bk_trns.png);text-align:center;-moz-box-shadow:1px 1px 3px #333;-webkit-box-shadow:1px 1px 3px #333;box-shadow:1px 1px 3px #333;font-size:11px!important;font-family:'Lucida Grande','Arial',sans-serif!important;">
   <table style="border-collapse:collapse;margin:0;padding:0;width:100%;"><tbody><tr>
   <td style="padding:10px;vertical-align:top;min-width:110px;">
   <a href="/web/" title="Wayback Machine home page" style="background-color:transparent;border:none;"><img src="/static/images/toolbar/wayback-toolbar-logo.png" alt="Wayback Machine" width="110" height="39" border="0"/></a>
   </td>
   <td style="padding:0!important;text-align:center;vertical-align:top;width:100%;">

       <table style="border-collapse:collapse;margin:0 auto;padding:0;width:570px;"><tbody><tr>
       <td style="padding:3px 0;" colspan="2">
       <form target="_top" method="get" action="/web/form-submit.jsp" name="wmtb" id="wmtb" style="margin:0!important;padding:0!important;"><input type="text" name="url" id="wmtbURL" value="http://rubyquiz.com/quiz72.html" style="width:400px;font-size:11px;font-family:'Lucida Grande','Arial',sans-serif;" onfocus="javascript:this.focus();this.select();" /><input type="hidden" name="type" value="replay" /><input type="hidden" name="date" value="20120121200228" /><input type="submit" value="Go" style="font-size:11px;font-family:'Lucida Grande','Arial',sans-serif;margin-left:5px;" /><span id="wm_tb_options" style="display:block;"></span></form>
       </td>
       <td style="vertical-align:bottom;padding:5px 0 0 0!important;" rowspan="2">
           <table style="border-collapse:collapse;width:110px;color:#99a;font-family:'Helvetica','Lucida Grande','Arial',sans-serif;"><tbody>
			
           <!-- NEXT/PREV MONTH NAV AND MONTH INDICATOR -->
           <tr style="width:110px;height:16px;font-size:10px!important;">
           	<td style="padding-right:9px;font-size:11px!important;font-weight:bold;text-transform:uppercase;text-align:right;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20101127180359/http://rubyquiz.com/quiz72.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="27 Nov 2010"><strong>NOV</strong></a>
		                
               </td>
               <td id="displayMonthEl" style="background:#000;color:#ff0;font-size:11px!important;font-weight:bold;text-transform:uppercase;width:34px;height:15px;padding-top:1px;text-align:center;" title="You are here: 20:02:28 Jan 21, 2012">JAN</td>
				<td style="padding-left:9px;font-size:11px!important;font-weight:bold;text-transform:uppercase;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20120418060144/http://www.rubyquiz.com/quiz72.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="18 Apr 2012"><strong>APR</strong></a>
		                
               </td>
           </tr>

           <!-- NEXT/PREV CAPTURE NAV AND DAY OF MONTH INDICATOR -->
           <tr>
               <td style="padding-right:9px;white-space:nowrap;overflow:visible;text-align:right!important;vertical-align:middle!important;" nowrap="nowrap">
               
		                <a href="/web/20120103142200/http://www.rubyquiz.com/quiz72.html" title="14:22:00 Jan 3, 2012" style="background-color:transparent;border:none;"><img src="/static/images/toolbar/wm_tb_prv_on.png" alt="Previous capture" width="14" height="16" border="0" /></a>
		                
               </td>
               <td id="displayDayEl" style="background:#000;color:#ff0;width:34px;height:24px;padding:2px 0 0 0;text-align:center;font-size:24px;font-weight: bold;" title="You are here: 20:02:28 Jan 21, 2012">21</td>
				<td style="padding-left:9px;white-space:nowrap;overflow:visible;text-align:left!important;vertical-align:middle!important;" nowrap="nowrap">
               
		                <a href="/web/20120418060144/http://www.rubyquiz.com/quiz72.html" title="6:01:44 Apr 18, 2012" style="background-color:transparent;border:none;"><img src="/static/images/toolbar/wm_tb_nxt_on.png" alt="Next capture" width="14" height="16" border="0"/></a>
		                
			    </td>
           </tr>

           <!-- NEXT/PREV YEAR NAV AND YEAR INDICATOR -->
           <tr style="width:110px;height:13px;font-size:9px!important;">
				<td style="padding-right:9px;font-size:11px!important;font-weight: bold;text-align:right;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20101127180359/http://rubyquiz.com/quiz72.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="27 Nov 2010"><strong>2010</strong></a>
		                
               </td>
               <td id="displayYearEl" style="background:#000;color:#ff0;font-size:11px!important;font-weight: bold;padding-top:1px;width:34px;height:13px;text-align:center;" title="You are here: 20:02:28 Jan 21, 2012">2012</td>
				<td style="padding-left:9px;font-size:11px!important;font-weight: bold;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20130215052926/http://rubyquiz.com/quiz72.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="15 Feb 2013"><strong>2013</strong></a>
		                
				</td>
           </tr>
           </tbody></table>
       </td>

       </tr>
       <tr>
       <td style="vertical-align:middle;padding:0!important;">
           <a href="/web/20120121200228*/http://rubyquiz.com/quiz72.html" style="color:#33f;font-size:11px;font-weight:bold;background-color:transparent;border:none;" title="See a list of every capture for this URL"><strong>34 captures</strong></a>
           <div style="margin:0!important;padding:0!important;color:#666;font-size:9px;padding-top:2px!important;white-space:nowrap;" title="Timespan for captures of this URL">12 Apr 06 - 15 Feb 13</div>
       </td>
       <td style="padding:0!important;">
       <a style="position:relative; white-space:nowrap; width:450px;height:27px;" href="" id="wm-graph-anchor">
       <div id="wm-ipp-sparkline" style="position:relative; white-space:nowrap; width:450px;height:27px;background-color:#fff;cursor:pointer;border-right:1px solid #ccc;" title="Explore captures for this URL">
			<img id="sparklineImgId" style="position:absolute; z-index:9012; top:0px; left:0px;"
				onmouseover="showTrackers('inline');" 
				onmouseout="showTrackers('none');"
				onmousemove="trackMouseMove(event,this)"
				alt="sparklines"
				width="450"
				height="27"
				border="0"
				src="/web/jsp/graph.jsp?graphdata=450_27_1996:-1:000000000000_1997:-1:000000000000_1998:-1:000000000000_1999:-1:000000000000_2000:-1:000000000000_2001:-1:000000000000_2002:-1:000000000000_2003:-1:000000000000_2004:-1:000000000000_2005:-1:000000000000_2006:-1:000110000100_2007:-1:000101000000_2008:-1:000020000000_2009:-1:000000000000_2010:-1:000000000010_2011:-1:000000000000_2012:0:2001b000a100_2013:-1:010000000000"></img>
			<img id="wbMouseTrackYearImg" 
				style="display:none; position:absolute; z-index:9010;"
				width="25" 
				height="27"
				border="0"
				src="/static/images/toolbar/transp-yellow-pixel.png"></img>
			<img id="wbMouseTrackMonthImg"
				style="display:none; position:absolute; z-index:9011; " 
				width="2"
				height="27" 
				border="0"
				src="/static/images/toolbar/transp-red-pixel.png"></img>
       </div>
		</a>

       </td>
       </tr></tbody></table>
   </td>
   <td style="text-align:right;padding:5px;width:65px;font-size:11px!important;">
       <a href="javascript:;" onclick="document.getElementById('wm-ipp').style.display='none';" style="display:block;padding-right:18px;background:url(/static/images/toolbar/wm_tb_close.png) no-repeat 100% 0;color:#33f;font-family:'Lucida Grande','Arial',sans-serif;margin-bottom:23px;background-color:transparent;border:none;" title="Close the toolbar">Close</a>
       <a href="http://faq.web.archive.org/" style="display:block;padding-right:18px;background:url(/static/images/toolbar/wm_tb_help.png) no-repeat 100% 0;color:#33f;font-family:'Lucida Grande','Arial',sans-serif;background-color:transparent;border:none;" title="Get some help using the Wayback Machine">Help</a>
   </td>
   </tr></tbody></table>

</div>
</div>
<script type="text/javascript">
 var wmDisclaimBanner = document.getElementById("wm-ipp");
 if(wmDisclaimBanner != null) {
   disclaimElement(wmDisclaimBanner);
 }
</script>
<!-- END WAYBACK TOOLBAR INSERT -->

	<div id="page">
		<div id="header"><span class="ruby">Ruby</span> <span class="quiz">Quiz</span></div>
		<div id="content">
			<span class="title">B & E (#72)</span>
			<p>by Stephen Waits</p>
			<p>Like many homeowners, I have a residential monitored alarm system installed in my house.  It consists of a few keypads and several remote sensors.</p>
			<p>My alarm has three modes of operation:</p>
			<p class="example">1. Off - completely disarmed<br />2. Away - everything (perimeter and interior) armed<br />3. Stay - perimeter armed</p>
			<p>The keypad consists of 12 buttons, which includes the digits '0' through '9', plus '*' and '#'.  The '*' and '#' are only used for special programming.</p>
			<p>The digits '1', '2', and '3' are also labeled "Off", "Away", and "Stay". This corresponds to the three system modes mentioned above.</p>
			<p>The security code is 4 digits long.  To set or change the system's mode, you simply enter your 4 digit security code, followed by the digit ('1', '2', or '3') which corresponds to the mode you want to set.</p>
			<p>For example, if the security code was 1234:</p>
			<p class="example">12341 - sets system to "Off"<br />12342 - sets system to "Away"<br />12343 - sets system to "Stay"</p>
			<p>What if you make a mistake when you're entering your code?  Yes, this is where an interesting observation comes into play.  To answer the question... if you make a mistake you just start over.  In other words, the keypad seems to only care that the last 5 keypresses match a valid code+command sequence.</p>
			<p>For example, if you entered the first two digits of your code incorrectly, you could just simply start over with the correct code, without any kind of reset:</p>
			<p class="example">8912341<br />++      =&gt; first 2 keypresses erroneous, oops!<br />  +++++ =&gt; last 5 keypresses == valid code+command sequence</p>
			<p>The thought occurs to me, and I'm sure to the reader, that perhaps this can be exploited.  For example, if you entered the sequence 1234123, you are actually testing 3 different codes:</p>
			<p class="example">1234123 =&gt; what you entered<br />12341   =&gt; 1234 + 1/off<br />.23412  =&gt; 2341 + 2/away<br />..34123 =&gt; 3412 + 3/stay</p>
			<p>Problems:</p>
			<p>1. What is the shortest sequence of digits you can come up with that tests every code in this alarm system?  The worst case is 5*10**4, or 50000 keypresses.</p>
			<p>2. What if the security code was 5 digits instead of 4?  Worst case here is 6*10**5, or 600000 keypresses.</p>
			<p>3. What if the "stop digits" changed from [1, 2, 3], to just [1]?  For instance, maybe the system is armed (mode 2 or 3) and only actually beeps when switching to mode 1.  (See Assumptions below)</p>
			<p>4. Can you also minimize the number of duplicate code tests?</p>
			<p>Assumptions:</p>
			<p>* We assume the keypad will actually let you go on entering digits for this long.  I haven't tested it, but it seems silly that it might actually allow this.  However, as a long time comp.risks reader, almost nothing surprises me.</p>
			<p>* We assume that the keypad will always signify a valid code+command sequence, regardless of mode.  In reality, if you set to Away when it's already in Away, it might not emit it's "success" signal.</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="comment">#!/usr/bin/env ruby -w</span><br /><br />    <span class="comment">#</span><br />    <span class="comment"># Stephen Waits &lt;steve@waits.net&gt;</span><br />    <span class="comment">#</span><br /><br />    <span class="keyword">class</span> AlarmKeypad<br /><br />        <span class="comment"># init a keypad, with length of security code, and the code's</span><br />        <span class="comment"># stop digits</span><br />        <span class="keyword">def</span> initialize(code_length = 4, stop_digits = [1,2,3])<br />            <span class="comment"># remember the length of the security code</span><br />            <span class="variable">@code_length</span> = code_length<br /><br />            <span class="comment"># and which digits cause a code to be checked</span><br />            <span class="variable">@stop_digits</span> = stop_digits<br /><br />            <span class="comment"># and reset our data structures to 0</span><br />            clear<br />        <span class="keyword">end</span><br /><br /><br />        <span class="comment"># reset keypad to initial state</span><br />        <span class="keyword">def</span> clear<br />            <span class="comment"># an array of each code and how many times it's been entered</span><br />            <span class="variable">@codes</span>       = Array.new(10**<span class="variable">@code_length</span>,0)<br /><br />            <span class="comment"># last N+1 keypad button presses</span><br />            <span class="variable">@key_history</span> = []<br /><br />            <span class="comment"># total number of keypad button presses</span><br />            <span class="variable">@key_presses</span> = 0<br />        <span class="keyword">end</span><br /><br /><br />        <span class="comment"># press a single digit</span><br />        <span class="keyword">def</span> press(digit)<br />            <span class="comment"># add digit to key history</span><br />            <span class="variable">@key_history</span>.shift <span class="keyword">while</span> <span class="variable">@key_history</span>.size &gt; <span class="variable">@code_length</span><br />            <span class="variable">@key_history</span> &lt;&lt; digit<br />            <span class="variable">@key_presses</span> += 1<br /><br />            <span class="comment"># see if we just tested a code</span><br />            <span class="keyword">if</span> <span class="variable">@stop_digits</span>.include?(<span class="variable">@key_history</span>.last) <span class="keyword">and</span><br />               <span class="variable">@key_history</span>.length &gt; <span class="variable">@code_length</span><br />                <span class="variable">@codes</span>[<span class="variable">@key_history</span>[0,<span class="variable">@code_length</span>].join.to_i] += 1<br />            <span class="keyword">end</span><br />        <span class="keyword">end</span><br /><br />        <span class="comment"># find out if every code had been tested</span><br />        <span class="keyword">def</span> fully_tested?<br />            <span class="keyword">not</span> <span class="variable">@codes</span>.include?(0)<br />        <span class="keyword">end</span><br /><br />        <span class="comment"># find out if an individual code has been tested</span><br />        <span class="comment"># NOTE: an actual keypad obviously doesn't offer this functionality;</span><br />        <span class="comment">#       but, it's useful and convenient (and might save duplication)</span><br />        <span class="keyword">def</span> tested?(code)<br />            <span class="variable">@codes</span>[code] &gt; 0<br />        <span class="keyword">end</span><br /><br />        <span class="comment"># output a summary</span><br />        <span class="keyword">def</span> summarize<br />            tested          = <span class="variable">@codes</span>.select { |c| c &gt; 0 }.size<br />            tested_multiple = <span class="variable">@codes</span>.select { |c| c &gt; 1 }.size<br /><br />            puts <span class="string">"Search space exhausted."</span> <span class="keyword">if</span> fully_tested?<br />            puts <span class="string">"Tested #{tested} of #{@codes.size} codes "</span> +<br />                 <span class="string">"in #{@key_presses} keystrokes."</span><br />            puts <span class="string">"#{tested_multiple} codes were tested more than once."</span><br />        <span class="keyword">end</span><br />    <span class="keyword">end</span><br /><br /><br />    <span class="keyword">if</span> <span class="global">$0</span> == <span class="keyword">__FILE__</span><br />        <span class="comment"># a random button presser, 3 digit codes</span><br />        a = AlarmKeypad.new(3)<br />        a.press( rand(10) ) <span class="keyword">until</span> a.fully_tested?<br />        a.summarize<br /><br />        <span class="comment"># sequential code entry, 4 digit codes</span><br />        a = AlarmKeypad.new(4)<br />        (<span class="string">"0000"</span>..<span class="string">"9999"</span>).each <span class="keyword">do</span> |c|<br />            <span class="keyword">next</span> <span class="keyword">if</span> a.tested?(c.to_i)<br />            c.split(<span class="string">//</span>).each { |d| a.press(d.to_i) }<br />            a.press(rand(3)+1)<br />        <span class="keyword">end</span><br />        a.summarize<br /><br />        <span class="comment"># sequential code entry, 5 digit codes, only [1] as a stop digit</span><br />        a = AlarmKeypad.new(5,[1])<br />        (<span class="string">"00000"</span>..<span class="string">"99999"</span>).each <span class="keyword">do</span> |c|<br />            <span class="keyword">next</span> <span class="keyword">if</span> a.tested?(c.to_i)<br />            c.split(<span class="string">//</span>).each { |d| a.press(d.to_i) }<br />            a.press(1)<br />        <span class="keyword">end</span><br />        a.summarize<br />    <span class="keyword">end</span><br /></div></div>
			<hr />
			<p><span class="title">Quiz Summary</span></p>
			<p>This quiz turned out to be surprisingly tough.  Ross Bamford seemed to get the tighter solution and it's not as big a difference as you might think.  Here's some output from running Ross's solution:</p>
			<p class="example"> ### 4 digits, [1,2,3] stops ### <br />      user     system      total        real<br />seq.     1.000000   0.020000   1.020000 (  1.021674)<br />Search space exhausted.<br />Tested 10000 of 10000 codes in 50000 keystrokes.<br />6146 codes were tested more than once.<br /><br />seq/chk  0.790000   0.000000   0.790000 (  0.804365)<br />Search space exhausted.<br />Tested 10000 of 10000 codes in 33395 keystrokes.<br />2557 codes were tested more than once.<br /><br />simple   2.840000   0.040000   2.880000 (  2.930310)<br />Search space exhausted.<br />Tested 10000 of 10000 codes in 33830 keystrokes.<br />2721 codes were tested more than once.<br /><br />best   665.050000   5.390000 670.440000 (678.840230)<br />Search space exhausted.<br />Tested 10000 of 10000 codes in 28687 keystrokes.<br />464 codes were tested more than once.</p>
			<p>Compare that with the trivial tests in the quiz code:</p>
			<p class="example">Search space exhausted.<br />Tested 10000 of 10000 codes in 33635 keystrokes.<br />2664 codes were tested more than once.</p>
			<p>At "best", Ross managed to trim 4,948 keystrokes and there was a hefty time penalty to pay for getting that far.</p>
			<p>Let's work through the code that amounts to the "best" search.  First we need to examine a helper class it makes use of:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="comment"># This was originally a delegator, but that was *slow*</span><br />    <span class="keyword">class</span> PoolStr &lt; String<br />      <span class="keyword">def</span> initialize(obj, parent = <span class="keyword">nil</span>)<br />        <span class="keyword">super</span>(obj)<br />        <span class="variable">@parent</span> = parent<br />      <span class="keyword">end</span><br />      <span class="keyword">def</span> suffixes(maxlen = <span class="keyword">nil</span>)<br />        <span class="variable">@suffixes</span> ||= get_suffixes(maxlen).map <span class="keyword">do</span> |s|<br />          PoolStr.new(s,<span class="keyword">self</span>)<br />        <span class="keyword">end</span><br />      <span class="keyword">end</span><br />      <span class="keyword">def</span> prefixes(maxlen = <span class="keyword">nil</span>)<br />        <span class="variable">@prefixes</span> ||= get_suffixes(maxlen,reverse).map <span class="keyword">do</span> |s|<br />          PoolStr.new(s.reverse,<span class="keyword">self</span>)<br />        <span class="keyword">end</span><br />      <span class="keyword">end</span><br />      private<br />      <span class="keyword">def</span> get_suffixes(maxlen = <span class="keyword">nil</span>, str = <span class="keyword">self</span>)<br />        start = maxlen ? str.length-maxlen : 1<br />        (start..(str.length-1)).map <span class="keyword">do</span> |i|<br />          suf = str[i..-1]<br />          suf<br />        <span class="keyword">end</span><br />      <span class="keyword">end</span><br />    <span class="keyword">end</span><br /><br /></div></div>
			<p>There's nothing too tricky hiding in here.  Basically we have a String, that can give us an Array of suffixes or prefixes as needed.  Those are both found with some simple index work in get_suffixes().  To handle prefixes, the String is reversed before it goes in, and the suffixes are reversed as they come out to transform them into prefixes.  Note that both of these are cached the first time they are figured, to speed up future calls.  (I'm not sure what @parent is for here.  It doesn't seem to be used.)</p>
			<p>Next we need to look at one more short helper, which turns out to be the heart of the "seq." search from the results:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="comment"># Make our codes. Using random stop digits gives a more</span><br />    <span class="comment"># compressible string (less stop digits = longer string).</span><br />    <span class="keyword">def</span> mkpool(digits, stops)<br />      ((<span class="string">"0"</span>*digits)..(<span class="string">"9"</span>*digits)).inject([]) <span class="keyword">do</span> |ary,e|<br />        ary &lt;&lt; PoolStr.new(<span class="string">"#{e}#{stops[rand(stops.length)] if stops}"</span>, <span class="keyword">nil</span>)<br />      <span class="keyword">end</span><br />    <span class="keyword">end</span><br /><br /></div></div>
			<p>Again, nothing tricky here.  Assuming a parameter of 4 for digits, this builds an Array of the codes from "0000" to "9999", with a random stop digit at the end of each one.</p>
			<p>Now we are ready for the main method of the "best" search:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="comment"># A more involved way, a simplified greedy heuristic</span><br />    <span class="comment"># that takes _forever_ but gives (slightly) better results.</span><br />    <span class="keyword">def</span> best_code(digits, stops = [1,2,3])<br />      out = <span class="string">""</span><br />      pool = mkpool(digits, stops)<br />      best = []<br />      bestcode = <span class="keyword">nil</span><br /><br />      <span class="comment"># Keep going until it's empty - if ever we can't find a match </span><br />      <span class="comment"># we'll just take one at random.</span><br />      <span class="keyword">until</span> pool.empty?<br />        <span class="keyword">unless</span> bestcode<br />          <span class="comment"># first iteration, just grab a start and carry on</span><br />          bestscore = 0<br />          bestcode = pool[rand(pool.length)]<br />        <span class="keyword">else</span><br />          <span class="comment"># Get the array of arrays of best matches for the previous code.</span><br />          <span class="comment"># This array matches suffixes to best-fit prefixes for </span><br />          <span class="comment"># the previously-added code to find the most mergeable code </span><br />          <span class="comment"># (i.e. the one that shares most of it's prefix with the end</span><br />          <span class="comment"># of the output string).</span><br />          <span class="comment">#</span><br />          <span class="comment"># This contains at a given index all the codes that share that </span><br />          <span class="comment"># many letters of pre/suffix with 'need'. Eh? Well, it's like this:</span><br />          <span class="comment">#</span><br />          <span class="comment">#   best for "1234" =&gt; [ nil, ["4321", "4048"], ["3412"], ["2348"]]</span><br />          <span class="comment">#</span><br />          <span class="comment"># Then, (one of) the highest scoring code(s) is taken from</span><br />          <span class="comment"># the top of the last nested array, best[best.length-1].</span><br />          <span class="comment">#</span><br />          <span class="comment"># We do it this way, rather than reversing the array, because</span><br />          <span class="comment"># we need to know what the actual score was, to merge the</span><br />          <span class="comment"># strings. Running on each iteration helps a bit</span><br />          <span class="comment"># with performance, since as time goes on the number of</span><br />          <span class="comment"># elements decreases.</span><br />          best.clear<br />          pool.each <span class="keyword">do</span> |nxt|<br />            <span class="keyword">next</span> <span class="keyword">if</span> nxt == bestcode<br />            <span class="keyword">if</span> r = (bestcode.suffixes &amp; nxt.prefixes).first<br />              (best[r.length] ||= []) &lt;&lt; nxt<br />            <span class="keyword">end</span><br />          <span class="keyword">end</span><br /><br />          bestcode = (best[bestscore = best.length - 1] || EMPTYARRAY).first<br /><br />          <span class="comment"># No best code? Nothing with matching pre/suff, so let's just grab</span><br />          <span class="comment"># a code at random instead to keep things moving. </span><br />          <span class="keyword">unless</span> bestcode<br />            bestscore = 0<br />            bestcode = pool[rand(pool.length)]<br />          <span class="keyword">end</span><br />        <span class="keyword">end</span><br /><br />        <span class="comment"># Remove from the pool. Bit slow...</span><br />        pool[pool.index(bestcode),1] = <span class="keyword">nil</span><br /><br />        <span class="comment"># Chop off matched prefix from this code and append it</span><br />        merged = bestcode[bestscore..-1]<br />        out &lt;&lt; merged<br />      <span class="keyword">end</span><br />      out<br />    <span class="keyword">end</span><br /><br /></div></div>
			<p>Here's the beast, but the comments are good and they will get us through it.  First you can see that the method makes a pool of all the codes, using the mkpool() method we just examined.  Now anytime this method doesn't have a bestcode, like right at the beginning here, it just pulls one at random from the pool.  (You can see the code for this in the first unless clause and at the end of the big else clause.)</p>
			<p>The real work is done right after that big comment.  The pool is walked comparing prefixes of possible codes with the suffixes of the bestcode (our last find).  The matching groups are placed in an Array where the index is their score or how many digits they share.  The code then just chooses a match with the highest score so it shares the most possible digits.  (The EMPTYARRAY constant used here is defined elsewhere in the code as `EMPTYARRAY = []`.)</p>
			<p>From there the code merges the suffix of the selected code (we already have the matching prefix from the last code), and adds it to the digits to enter.  It then loops until the pool is exhausted.</p>
			<p>The actual solution is just one line from that:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    best_code(n).split(<span class="string">//</span>).each { |c| a.press c.to_i }<br /><br /></div></div>
			<p>You saw the results of that at the beginning of this summary.  You would have to examine usage for this code carefully though, to determine if shaving around 5,000 keystrokes is worth the unfortunately large speed penalty.  It's all about tradeoffs.</p>
			<p>A huge thank you to the quiz creator for a challenging little problem and the two brave souls who were equal to the task.</p>
			<p>Tomorrow's quiz is still up in the air!  We're trying to sneak in a research project we can all help with, if we can get it ready in time...</p>
		</div>
		<div id="logo"><img src="/web/20120121200228im_/http://rubyquiz.com/images/ruby_quiz_logo.jpg" alt="" width="157" height="150" /></div>
		<div id="links">
			<span class="title">Quiz Solutions</span>
			<ol>
				<li><a href="/web/20120121200228/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/186172">Shane Emmons</a></li>
				<li><a href="/web/20120121200228/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/186176">Ross Bamford</a></li>
				<li><a href="/web/20120121200228/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/186360">Shane Emmons (2)</a></li>
				<li><a href="/web/20120121200228/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/186418">Shane Emmons (3)</a></li>
				<li><a href="/web/20120121200228/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/186605">Ross Bamford (2)</a></li>
				<li><a href="/web/20120121200228/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/186780">Timothy Bennett</a></li>
			</ol>
			<p><a href="/web/20120121200228/http://rubyquiz.com/quiz72_sols.zip">Download Solutions</a></p>
			<p><a href="/web/20120121200228/http://rubyquiz.com/index.html">Back to Quiz Listing</a></p>
		</div>
		<div id="footer">&nbsp;</div>
	</div>
</body>
</html>





<!--
     FILE ARCHIVED ON 20:02:28 Jan 21, 2012 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 13:10:04 Jun 5, 2013.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
