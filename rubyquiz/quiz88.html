<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>


<!-- Start Wayback Rewrite JS Include -->
<script type="text/javascript" src="/static/js/jwplayer/jwplayer.js" ></script>
<script type="text/javascript" src="/static/js/video-embed-rewriter.js"></script>
<script type="text/javascript">
function initYTVideo(id)
{
	_wmVideos_.init("/web/", id);
}
</script>
<!-- End Wayback Rewrite JS Include -->

	<title>Ruby Quiz - Chip-8 (#88)</title>
	<link rel="stylesheet" type="text/css" href="/web/20120120002938cs_/http://rubyquiz.com/quiz.css" />
	<link rel="stylesheet" type="text/css" href="/web/20120120002938cs_/http://rubyquiz.com/print.css" media="print" />
</head><body>
<!-- BEGIN WAYBACK TOOLBAR INSERT -->

<script type="text/javascript" src="/static/js/disclaim-element.js" ></script>
<script type="text/javascript" src="/static/js/graph-calc.js" ></script>
<script type="text/javascript" src="/static/jflot/jquery.min.js" ></script>
<script type="text/javascript">
//<![CDATA[
var firstDate = 820454400000;
var lastDate = 1388534399999;
var wbPrefix = "/web/";
var wbCurrentUrl = "http:\/\/rubyquiz.com\/quiz88.html";

var curYear = -1;
var curMonth = -1;
var yearCount = 18;
var firstYear = 1996;
var imgWidth = 450;
var yearImgWidth = 25;
var monthImgWidth = 2;
var trackerVal = "none";
var displayDay = "20";
var displayMonth = "Jan";
var displayYear = "2012";
var prettyMonths = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

function showTrackers(val) {
	if(val == trackerVal) {
		return;
	}
	if(val == "inline") {
		document.getElementById("displayYearEl").style.color = "#ec008c";
		document.getElementById("displayMonthEl").style.color = "#ec008c";
		document.getElementById("displayDayEl").style.color = "#ec008c";		
	} else {
		document.getElementById("displayYearEl").innerHTML = displayYear;
		document.getElementById("displayYearEl").style.color = "#ff0";
		document.getElementById("displayMonthEl").innerHTML = displayMonth;
		document.getElementById("displayMonthEl").style.color = "#ff0";
		document.getElementById("displayDayEl").innerHTML = displayDay;
		document.getElementById("displayDayEl").style.color = "#ff0";
	}
   document.getElementById("wbMouseTrackYearImg").style.display = val;
   document.getElementById("wbMouseTrackMonthImg").style.display = val;
   trackerVal = val;
}
function getElementX2(obj) {
	var thing = jQuery(obj);
	if((thing == undefined) 
			|| (typeof thing == "undefined") 
			|| (typeof thing.offset == "undefined")) {
		return getElementX(obj);
	}
	return Math.round(thing.offset().left);
}
function trackMouseMove(event,element) {

   var eventX = getEventX(event);
   var elementX = getElementX2(element);
   var xOff = eventX - elementX;
	if(xOff < 0) {
		xOff = 0;
	} else if(xOff > imgWidth) {
		xOff = imgWidth;
	}
   var monthOff = xOff % yearImgWidth;

   var year = Math.floor(xOff / yearImgWidth);
	var yearStart = year * yearImgWidth;
   var monthOfYear = Math.floor(monthOff / monthImgWidth);
   if(monthOfYear > 11) {
       monthOfYear = 11;
   }
   // 1 extra border pixel at the left edge of the year:
   var month = (year * 12) + monthOfYear;
   var day = 1;
	if(monthOff % 2 == 1) {
		day = 15;
	}
	var dateString = 
		zeroPad(year + firstYear) + 
		zeroPad(monthOfYear+1,2) +
		zeroPad(day,2) + "000000";

	var monthString = prettyMonths[monthOfYear];
	document.getElementById("displayYearEl").innerHTML = year + 1996;
	document.getElementById("displayMonthEl").innerHTML = monthString;
	// looks too jarring when it changes..
	//document.getElementById("displayDayEl").innerHTML = zeroPad(day,2);

	var url = wbPrefix + dateString + '/' +  wbCurrentUrl;
	document.getElementById('wm-graph-anchor').href = url;

   //document.getElementById("wmtbURL").value="evX("+eventX+") elX("+elementX+") xO("+xOff+") y("+year+") m("+month+") monthOff("+monthOff+") DS("+dateString+") Moy("+monthOfYear+") ms("+monthString+")";
   if(curYear != year) {
       var yrOff = year * yearImgWidth;
       document.getElementById("wbMouseTrackYearImg").style.left = yrOff + "px";
       curYear = year;
   }
   if(curMonth != month) {
       var mtOff = year + (month * monthImgWidth) + 1;
       document.getElementById("wbMouseTrackMonthImg").style.left = mtOff + "px";
       curMonth = month;
   }
}
//]]>
</script>

<style type="text/css">body{margin-top:0!important;padding-top:0!important;min-width:800px!important;}#wm-ipp a:hover{text-decoration:underline!important;}</style>
<div id="wm-ipp" style="display:none; position:relative;padding:0 5px;min-height:70px;min-width:800px; z-index:9000;">
<div id="wm-ipp-inside" style="position:fixed;padding:0!important;margin:0!important;width:97%;min-width:780px;border:5px solid #000;border-top:none;background-image:url(/static/images/toolbar/wm_tb_bk_trns.png);text-align:center;-moz-box-shadow:1px 1px 3px #333;-webkit-box-shadow:1px 1px 3px #333;box-shadow:1px 1px 3px #333;font-size:11px!important;font-family:'Lucida Grande','Arial',sans-serif!important;">
   <table style="border-collapse:collapse;margin:0;padding:0;width:100%;"><tbody><tr>
   <td style="padding:10px;vertical-align:top;min-width:110px;">
   <a href="/web/" title="Wayback Machine home page" style="background-color:transparent;border:none;"><img src="/static/images/toolbar/wayback-toolbar-logo.png" alt="Wayback Machine" width="110" height="39" border="0"/></a>
   </td>
   <td style="padding:0!important;text-align:center;vertical-align:top;width:100%;">

       <table style="border-collapse:collapse;margin:0 auto;padding:0;width:570px;"><tbody><tr>
       <td style="padding:3px 0;" colspan="2">
       <form target="_top" method="get" action="/web/form-submit.jsp" name="wmtb" id="wmtb" style="margin:0!important;padding:0!important;"><input type="text" name="url" id="wmtbURL" value="http://rubyquiz.com/quiz88.html" style="width:400px;font-size:11px;font-family:'Lucida Grande','Arial',sans-serif;" onfocus="javascript:this.focus();this.select();" /><input type="hidden" name="type" value="replay" /><input type="hidden" name="date" value="20120120002938" /><input type="submit" value="Go" style="font-size:11px;font-family:'Lucida Grande','Arial',sans-serif;margin-left:5px;" /><span id="wm_tb_options" style="display:block;"></span></form>
       </td>
       <td style="vertical-align:bottom;padding:5px 0 0 0!important;" rowspan="2">
           <table style="border-collapse:collapse;width:110px;color:#99a;font-family:'Helvetica','Lucida Grande','Arial',sans-serif;"><tbody>
			
           <!-- NEXT/PREV MONTH NAV AND MONTH INDICATOR -->
           <tr style="width:110px;height:16px;font-size:10px!important;">
           	<td style="padding-right:9px;font-size:11px!important;font-weight:bold;text-transform:uppercase;text-align:right;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20101127175654/http://rubyquiz.com/quiz88.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="27 Nov 2010"><strong>NOV</strong></a>
		                
               </td>
               <td id="displayMonthEl" style="background:#000;color:#ff0;font-size:11px!important;font-weight:bold;text-transform:uppercase;width:34px;height:15px;padding-top:1px;text-align:center;" title="You are here: 0:29:38 Jan 20, 2012">JAN</td>
				<td style="padding-left:9px;font-size:11px!important;font-weight:bold;text-transform:uppercase;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20120418094158/http://www.rubyquiz.com/quiz88.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="18 Apr 2012"><strong>APR</strong></a>
		                
               </td>
           </tr>

           <!-- NEXT/PREV CAPTURE NAV AND DAY OF MONTH INDICATOR -->
           <tr>
               <td style="padding-right:9px;white-space:nowrap;overflow:visible;text-align:right!important;vertical-align:middle!important;" nowrap="nowrap">
               
		                <a href="/web/20101127175654/http://rubyquiz.com/quiz88.html" title="17:56:54 Nov 27, 2010" style="background-color:transparent;border:none;"><img src="/static/images/toolbar/wm_tb_prv_on.png" alt="Previous capture" width="14" height="16" border="0" /></a>
		                
               </td>
               <td id="displayDayEl" style="background:#000;color:#ff0;width:34px;height:24px;padding:2px 0 0 0;text-align:center;font-size:24px;font-weight: bold;" title="You are here: 0:29:38 Jan 20, 2012">20</td>
				<td style="padding-left:9px;white-space:nowrap;overflow:visible;text-align:left!important;vertical-align:middle!important;" nowrap="nowrap">
               
		                <a href="/web/20120418094158/http://www.rubyquiz.com/quiz88.html" title="9:41:58 Apr 18, 2012" style="background-color:transparent;border:none;"><img src="/static/images/toolbar/wm_tb_nxt_on.png" alt="Next capture" width="14" height="16" border="0"/></a>
		                
			    </td>
           </tr>

           <!-- NEXT/PREV YEAR NAV AND YEAR INDICATOR -->
           <tr style="width:110px;height:13px;font-size:9px!important;">
				<td style="padding-right:9px;font-size:11px!important;font-weight: bold;text-align:right;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20101127175654/http://rubyquiz.com/quiz88.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="27 Nov 2010"><strong>2010</strong></a>
		                
               </td>
               <td id="displayYearEl" style="background:#000;color:#ff0;font-size:11px!important;font-weight: bold;padding-top:1px;width:34px;height:13px;text-align:center;" title="You are here: 0:29:38 Jan 20, 2012">2012</td>
				<td style="padding-left:9px;font-size:11px!important;font-weight: bold;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20130215052213/http://rubyquiz.com/quiz88.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="15 Feb 2013"><strong>2013</strong></a>
		                
				</td>
           </tr>
           </tbody></table>
       </td>

       </tr>
       <tr>
       <td style="vertical-align:middle;padding:0!important;">
           <a href="/web/20120120002938*/http://rubyquiz.com/quiz88.html" style="color:#33f;font-size:11px;font-weight:bold;background-color:transparent;border:none;" title="See a list of every capture for this URL"><strong>32 captures</strong></a>
           <div style="margin:0!important;padding:0!important;color:#666;font-size:9px;padding-top:2px!important;white-space:nowrap;" title="Timespan for captures of this URL">20 Oct 06 - 15 Feb 13</div>
       </td>
       <td style="padding:0!important;">
       <a style="position:relative; white-space:nowrap; width:450px;height:27px;" href="" id="wm-graph-anchor">
       <div id="wm-ipp-sparkline" style="position:relative; white-space:nowrap; width:450px;height:27px;background-color:#fff;cursor:pointer;border-right:1px solid #ccc;" title="Explore captures for this URL">
			<img id="sparklineImgId" style="position:absolute; z-index:9012; top:0px; left:0px;"
				onmouseover="showTrackers('inline');" 
				onmouseout="showTrackers('none');"
				onmousemove="trackMouseMove(event,this)"
				alt="sparklines"
				width="450"
				height="27"
				border="0"
				src="/web/jsp/graph.jsp?graphdata=450_27_1996:-1:000000000000_1997:-1:000000000000_1998:-1:000000000000_1999:-1:000000000000_2000:-1:000000000000_2001:-1:000000000000_2002:-1:000000000000_2003:-1:000000000000_2004:-1:000000000000_2005:-1:000000000000_2006:-1:000000000100_2007:-1:000000110000_2008:-1:000010000000_2009:-1:000000000000_2010:-1:100000000010_2011:-1:000000000000_2012:0:1001c000a100_2013:-1:010000000000"></img>
			<img id="wbMouseTrackYearImg" 
				style="display:none; position:absolute; z-index:9010;"
				width="25" 
				height="27"
				border="0"
				src="/static/images/toolbar/transp-yellow-pixel.png"></img>
			<img id="wbMouseTrackMonthImg"
				style="display:none; position:absolute; z-index:9011; " 
				width="2"
				height="27" 
				border="0"
				src="/static/images/toolbar/transp-red-pixel.png"></img>
       </div>
		</a>

       </td>
       </tr></tbody></table>
   </td>
   <td style="text-align:right;padding:5px;width:65px;font-size:11px!important;">
       <a href="javascript:;" onclick="document.getElementById('wm-ipp').style.display='none';" style="display:block;padding-right:18px;background:url(/static/images/toolbar/wm_tb_close.png) no-repeat 100% 0;color:#33f;font-family:'Lucida Grande','Arial',sans-serif;margin-bottom:23px;background-color:transparent;border:none;" title="Close the toolbar">Close</a>
       <a href="http://faq.web.archive.org/" style="display:block;padding-right:18px;background:url(/static/images/toolbar/wm_tb_help.png) no-repeat 100% 0;color:#33f;font-family:'Lucida Grande','Arial',sans-serif;background-color:transparent;border:none;" title="Get some help using the Wayback Machine">Help</a>
   </td>
   </tr></tbody></table>

</div>
</div>
<script type="text/javascript">
 var wmDisclaimBanner = document.getElementById("wm-ipp");
 if(wmDisclaimBanner != null) {
   disclaimElement(wmDisclaimBanner);
 }
</script>
<!-- END WAYBACK TOOLBAR INSERT -->

	<div id="page">
		<div id="header"><span class="ruby">Ruby</span> <span class="quiz">Quiz</span></div>
		<div id="content">
			<span class="title">Chip-8 (#88)</span>
			<p>by Ethan Price</p>
			<p>CHIP-8 was an interpreted language used in the 1970's for basic games like Pong. While it is technically an interpreted language, it defines many components a real computer has, such as registers and a processor.  Today, like many other gaming consoles, it is kept alive by emulators allowing it to be played on most any modern computer. Emulation is where raw operation codes (the most low-level way of feeding instructions to a computer) are translated by another computer, giving a totally different system the ability to run programs not designed for it.</p>
			<p>Your job is to make an emulator. It will only cover some basic parts of it, but all emulators have to start somewhere. I have written a simple program, and will give you a list of all the opcodes I used and what they are supposed to do. We won't worry about graphics right now, just simple operations.  Four things need to be done:</p>
			<p class="example">1. Make the emulator read the file. All opcodes are four digit hex numbers,<br />   but those will need to be split.<br />2. Set up the registers and other assorted things so they can be modified.<br />3. Interpret the function of the opcode in Ruby.<br />4. Dump all the registers so you can check and make sure everything went well.</p>
			<p>Like I said, all opcodes are four digit long hex numbers. So you read four hex digits worth of data, process it, then move on to the next four digits.  There are 16 registers (areas where data can be stored). They are named V0 through VF, and are all eight bits wide. VF is usually used as a carry for math operations.</p>
			<p>Here is the list of opcodes you will need to interpret:</p>
			<p class="example">NNN is an address<br />KK is an 8 bit constant<br />X and Y are two 4 bits constants<br /><br />0000 This is nothing. If you see this,  it should mean that you are at the end<br />     of the file and have nothing left to read, so you therefore need to exit<br />     gracefully.<br /><br />1NNN Jump to the address NNN of the file<br /><br />3XKK Skip next instruction if VX == KK<br /><br />6XKK VX = KK<br /><br />7XKK VX = VX + KK (Note: The documentation does not mention this, but I would<br />                         assume that VF would act as a carry if needed. The<br />                         included program will not need a carry for this<br />                         function, so providing for one is purely optional.)<br /><br />8XY0 VX = VY<br /><br />8XY1 VX = VX OR VY<br /><br />8XY2 VX = VX AND VY<br /><br />8XY3 VX = VX XOR VY<br /><br />8XY4 VX = VX + VY, Sets VF to 1 if there is a carry, 0 if there isn't<br /><br />8XY5 VX = VX - VY, VF is set to 0 if there is a borrow, 1 if there isn't.<br /><br />8X06 VX = VX SHIFT RIGHT 1 (VX=VX/2), VF is set to the value of the least<br />                                      significant bit of VX before the shift.<br /><br />8XY7 VX = VY - VX, VF is set to 0 if there is a borrow, 1 if there isn't.<br /><br />8X0E VX = VX SHIFT LEFT 1 (VX=VX*2), VF is set to the value of the most<br />                                     significant bit of VX before the shift.<br /><br />CXKK VX = Random number AND KK</p>
			<p>Lets explain how to read these opcodes. Take opcode 1NNN for example. Since the 1NNN starts with 1, we know that no matter what comes after it we will be doing a jump instruction. Same with the other codes. For the opcode 8XY2, we know if an opcode starts with 8 and ends in 2 it will be the operation "VX = VX AND VY".</p>
			<p>The variables NNN, KK, X and Y are a little different. They can represent any hex number (0-F), and also are used to note how big of chunks to read them in. For NNN, you will want to read those as a three digit hex number. Lets do an example opcode (in hex): 1234. Since it starts with 1, we know it is a "Jump to address NNN" command. The three numbers after that (the NNN part), are 234, so we know to jump to location 234 in the file (this is a hex number, not decimal). KK and X/Y are similar, just for different sized chunks.</p>
			<p>While I'm on the subject, let's talk about addresses in detail. Your current address in the file is how many bytes you are from the beginning of the file. So if I am at address 008 in the file, I am eight bytes away from the beginning of the file, and therefore the next byte I read will be byte nine. Say we had the opcode 100F, that means we would jump to after byte 16 (it is a hex remember).</p>
			<p>If your wondering how the carries work, here are some examples. First off, addition. Say we add these two numbers (opcode 8xy4):</p>
			<p class="example">11111111 &lt;--This is VX<br />+<br />00000001 &lt;--This is VY</p>
			<p>Obviously this would equal 100000000, but that is too big for one register. So what we do is make VF equal 00000001, and then roll over to 00000000. Sort of like an old car odometer. When it hits 99,999 miles, it goes back to 00,000 miles, except we are keeping track of the fact that it rolled over. Subtraction is similar (opcode 8xy5):</p>
			<p class="example">00000000 &lt;-- This is VX<br />-<br />00000001 &lt;-- This is VY</p>
			<p>Since the registers can only deal with positive numbers, we have to keep it positive. So what we do is "borrow", making VX equal to 100000000. All of a sudden our subtraction works:</p>
			<p class="example">100000000 &lt;--VX<br />-<br />00000001 &lt;--VY<br />=<br />11111111</p>
			<p>If we do this though, we have to make sure VF is zero to indicate that a borrow was needed. If a borrow was not needed, VF gets set to 00000001, since you didn't need the extra.</p>
			<p>Now for shifts. To sum it up, if you shift left, the far left number gets taken away, and a zero added to the far right. So 10101111 would become 01011110, because we got rid of the far left number and added a zero to the far right. Shift right is the same except going the other way (get rid of far right number, add 0 to the left). As you can see, a number disappears when you shift. VF is set to the number that disappears (obviously it can only be a 1 or 0).</p>
			<p>A full list of opcodes can be had at David Winter's page, under section 1.5:</p>
			<p class="example">http://www.pdc.kth.se/%7Elfo/chip8/CHIP8.htm</p>
			<p>He also has a full explanation of everything, so if check there for more details. If you want to write code for an opcode that I didn't list, by all means go for it.</p>
			<p>Be sure to start reading the attached program from the beginning. To my understanding in a real Chip-8 game up to address 200 was reserved for machine code which we wont worry about.</p>
			<p>The register values you should get are:</p>
			<p class="example">V1:01000101<br />V2:10111011<br />V3:11101100<br />V4:this number should be random, so do multiple runs to make sure it changes<br />VF:00000000</p>
			<p>A note: If everything is working as it is supposed to, you should run straight through the file once. If you are looping, I would start with double checking all your math operations.</p>
			<p>Good Luck!</p>
			<p><a href="/web/20120120002938/http://www.rubyquiz.com/Chip8Test">Chip-8 Test Program</a></p>
			<hr />
			<p><span class="title">Quiz Summary</span></p>
			<p>As some of you may know, the annual ICFP contest was just two weekends ago and this year's problem involved the creation of a small virtual machine, much as this quiz does.  We didn't plan that, but it turned out to be a pleasant synergy.</p>
			<p>The ICFP machine was really a non-ideal environment for Ruby.  The performance issues there really called for C speed.  In contrast, Chip-8 programs seem to fit Ruby emulation nicely.</p>
			<p>I'm not going to cover it below, but do spend a little time playing with Sander Land's complete emulator if you have a Windows box handy.  It runs games from the quiz-linked site and isn't much more code than some of the other solutions.</p>
			<p>I do want to take a look at Boris Prinz's solution though, so let's get to it.  This first chunk of code isn't the actual quiz solution, but it's a wonderful tool for seeing how solutions process Chip-8 files.  Here's Boris's disassembler:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="keyword">class</span> Chip8Disassembler<br />      CODES = {<br />        <span class="string">/0000/</span>     =&gt; <span class="string">'exit'</span>,<br />        <span class="string">/1(...)/</span>   =&gt; <span class="string">'goto \1'</span>,<br />        <span class="string">/3(.)(..)/</span> =&gt; <span class="string">'skip next if V\1 == 0x\2'</span>,<br />        <span class="string">/6(.)(..)/</span> =&gt; <span class="string">'V\1 = 0x\2'</span>,<br />        <span class="string">/7(.)(..)/</span> =&gt; <span class="string">'V\1 = V\1 + 0x\2'</span>,<br />        <span class="string">/8(.)(.)0/</span> =&gt; <span class="string">'V\1 = V\2'</span>,<br />        <span class="string">/8(.)(.)1/</span> =&gt; <span class="string">'V\1 = V\1 | V\2'</span>,<br />        <span class="string">/8(.)(.)2/</span> =&gt; <span class="string">'V\1 = V\1 &amp; V\2'</span>,<br />        <span class="string">/8(.)(.)3/</span> =&gt; <span class="string">'V\1 = V\1 ^ V\2'</span>,<br />        <span class="string">/8(.)(.)4/</span> =&gt; <span class="string">'V\1 = V\1 + V\2'</span>,<br />        <span class="string">/8(.)(.)5/</span> =&gt; <span class="string">'V\1 = V\1 - V\2'</span>,<br />        <span class="string">/8(.)06/</span>   =&gt; <span class="string">'V\1 = V\1 &gt;&gt; 1'</span>,<br />        <span class="string">/8(.)(.)7/</span> =&gt; <span class="string">'V\1 = V\2 - V\1'</span>,<br />        <span class="string">/8(.)0E/</span>   =&gt; <span class="string">'V\1 = V\1 &lt;&lt; 1'</span>,<br />        <span class="string">/C(.)(..)/</span> =&gt; <span class="string">'V\1 = rand() &amp; 0x\2'</span>,<br />      }<br /><br />      <span class="keyword">def</span> <span class="keyword">self</span>.code2text hexcode<br />        CODES.each <span class="keyword">do</span> |re, subs|<br />          <span class="keyword">if</span> hexcode =~ re<br />            <span class="keyword">return</span> hexcode.sub(re, subs)<br />          <span class="keyword">end</span><br />        <span class="keyword">end</span><br />        <span class="string">'???'</span><br />      <span class="keyword">end</span><br /><br />      <span class="keyword">def</span> <span class="keyword">self</span>.dump binary<br />        opcodes = binary.unpack <span class="string">"n*"</span><br />        opcodes.each_with_index <span class="keyword">do</span> |code, waddr|<br />          code_hex = <span class="string">"%04X"</span> % code<br />          printf(<span class="string">"%03X: [%s] %s\n"</span>, waddr*2, code_hex, code2text(code_hex));<br />        <span class="keyword">end</span><br />      <span class="keyword">end</span><br />    <span class="keyword">end</span><br /><br />    binary = File.read(ARGV[0])<br />    Chip8Disassembler.dump(binary)<br /><br /></div></div>
			<p>If you skip to the end, you can see that this code just slurps the Chip-8 program passed as an argument and feeds the whole thing to dump().</p>
			<p>The dump() method separates the program into opcodes with a simple call to unpack().  The "n*" pattern for unpack() has it read two characters at a time as an unsigned integer.  It also dictates that the number is in "network byte-order" which avoids endian issues on different architectures.  From there each opcode is traversed, turned into a hex code, and handed off to the code2text() method for translation.</p>
			<p>Inside code2text(), the passed hexcode is compared to each pattern of the CODES Hash in turn.  When a match is found, the key and value Hash pair are used to perform a regular expression conversion from code to source statement and that statement is returned.</p>
			<p>Each of those statements is decorated with the code_hex and the address of the instruction in the program file, then printed.  The end result looks like this, for the quiz test program:</p>
			<p class="example">000: [6177] V1 = 0x77<br />002: [6245] V2 = 0x45<br />004: [7101] V1 = V1 + 0x01<br />006: [8320] V3 = V2<br />008: [8121] V1 = V1 | V2<br />00A: [8122] V1 = V1 &amp; V2<br />00C: [8233] V2 = V2 ^ V3<br />00E: [8134] V1 = V1 + V3<br />010: [8235] V2 = V2 - V3<br />012: [8106] V1 = V1 &gt;&gt; 1<br />014: [8327] V3 = V2 - V3<br />016: [830E] V3 = V3 &lt;&lt; 1<br />018: [64FF] V4 = 0xFF<br />01A: [C411] V4 = rand() &amp; 0x11<br />01C: [32BB] skip next if V2 == 0xBB<br />01E: [1000] goto 000<br />020: [0000] exit</p>
			<p>The hex codes from the quiz description are in brackets in the middle and you can see the operations just to the right of that.  Hopefully that makes it clear how you break down instructions and what they are suppose to do.</p>
			<p>Now we should be well equipped to read Boris's actual solution.  Here's how it begins:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="keyword">class</span> Chip8Emulator<br />      attr_accessor :register<br /><br />      VF = 15 <span class="comment"># index of the carry/borrow register</span><br /><br />      <span class="keyword">def</span> initialize<br />        <span class="variable">@register</span> = [0] * 16 <span class="comment"># V0..VF</span><br />      <span class="keyword">end</span><br /><br />      <span class="comment"># ...</span><br /><br /></div></div>
			<p>I doubt there is anything tricky there.  The registers are just an Array of Integers which are made available through the accessor.  We also see a convenient VF constant defined for accessing that register.</p>
			<p>Here's the main event loop of the emulator:</p>
			<div class="code"><span class="type">ruby</span><div class="body">        <span class="comment"># ...</span><br /><br />        <span class="keyword">def</span> exec(program)<br />          opcodes = program.unpack(<span class="string">'n*'</span>)<br />          current = 0 <span class="comment"># current opcode index</span><br />          loop <span class="keyword">do</span><br />            opcode = opcodes[current]<br /><br />            <span class="comment"># these are needed often:</span><br />            x   = opcode &gt;&gt; 8 &amp; 0x0F<br />            y   = opcode &gt;&gt; 4 &amp; 0x0F<br />            kk  = opcode &amp; 0xFF<br />            nnn = opcode &amp; 0x0FFF<br /><br />            <span class="keyword">case</span> opcode &gt;&gt; 12 <span class="comment"># first nibble</span><br />            <span class="keyword">when</span> 0 <span class="keyword">then</span> <span class="keyword">return</span><br />            <span class="keyword">when</span> 1 <span class="keyword">then</span> current = (nnn) / 2 <span class="keyword">and</span> <span class="keyword">next</span><br />            <span class="keyword">when</span> 3 <span class="keyword">then</span> current += 1 <span class="keyword">if</span> <span class="variable">@register</span>[x] == kk<br />            <span class="keyword">when</span> 6 <span class="keyword">then</span> <span class="variable">@register</span>[x] = kk<br />            <span class="keyword">when</span> 7 <span class="keyword">then</span> add(x, kk)<br />            <span class="keyword">when</span> 8<br />              <span class="keyword">case</span> opcode &amp; 0x0F <span class="comment"># last nibble</span><br />              <span class="keyword">when</span> 0 <span class="keyword">then</span> <span class="variable">@register</span>[x]  = <span class="variable">@register</span>[y]<br />              <span class="keyword">when</span> 1 <span class="keyword">then</span> <span class="variable">@register</span>[x] |= <span class="variable">@register</span>[y]<br />              <span class="keyword">when</span> 2 <span class="keyword">then</span> <span class="variable">@register</span>[x] &amp;= <span class="variable">@register</span>[y]<br />              <span class="keyword">when</span> 3 <span class="keyword">then</span> <span class="variable">@register</span>[x] ^= <span class="variable">@register</span>[y]<br />              <span class="keyword">when</span> 4 <span class="keyword">then</span> add(x, <span class="variable">@register</span>[y])<br />              <span class="keyword">when</span> 5 <span class="keyword">then</span> subtract(x, x, y)<br />              <span class="keyword">when</span> 6 <span class="keyword">then</span> shift_right(x)<br />              <span class="keyword">when</span> 7 <span class="keyword">then</span> subtract(x, y, x)<br />              <span class="keyword">when</span> 0xE <span class="keyword">then</span> shift_left(x)<br />              <span class="keyword">else</span> raise <span class="string">"Unknown opcode: "</span> + opcode.to_s(16)<br />              <span class="keyword">end</span><br />            <span class="keyword">when</span> 0xC <span class="keyword">then</span> random(x, kk)<br />            <span class="keyword">else</span> raise <span class="string">"Unknown opcode: "</span> + opcode.to_s(16)<br />            <span class="keyword">end</span><br />            current += 1 <span class="comment"># next opcode</span><br />          <span class="keyword">end</span><br />        <span class="keyword">end</span><br /><br />        <span class="comment"># ...</span><br /><br /></div></div>
			<p>This entire method basically comes right out of the quiz.  The program is first unpack()ed into opcodes, as we saw with the disassembler and a current opcode pointer is initialized.</p>
			<p>Next the code enters into an infinite loop() of opcode processing.  Inside that loop(), the current opcode is pulled and then split into the x, y, kk, and nnn variables the quiz discusses.</p>
			<p>The big case statement after that is the opcode instruction processor.  Most of those are trivial implementations of the quiz descriptions, but you can see that the more complex operations are delegated to helper methods, which we will examine in just a moment.</p>
			<p>The last thing of note here is the jump implementation with the `and next` code on the end of it.  That forces the next iteration of the loop() to start immediately, bypassing the current opcode pointer increment after the case statement.</p>
			<p>Let's see those helper methods:</p>
			<div class="code"><span class="type">ruby</span><div class="body">      <span class="comment"># ...</span><br /><br />      <span class="keyword">def</span> add(reg, value)<br />        result = <span class="variable">@register</span>[reg] + value<br />        <span class="variable">@register</span>[reg] = result &amp; 0xFF<br />        <span class="variable">@register</span>[VF]  = result &gt;&gt; 8 <span class="comment"># carry</span><br />      <span class="keyword">end</span><br /><br />      <span class="keyword">def</span> subtract(reg, a, b)<br />        result = <span class="variable">@register</span>[a] - <span class="variable">@register</span>[b]<br />        <span class="variable">@register</span>[reg] = result &amp; 0xFF<br />        <span class="variable">@register</span>[VF]  = - (result &gt;&gt; 8) <span class="comment"># borrow</span><br />      <span class="keyword">end</span><br /><br />      <span class="keyword">def</span> shift_right(reg)<br />        <span class="variable">@register</span>[VF] = <span class="variable">@register</span>[reg] &amp; 0x01<br />        <span class="variable">@register</span>[reg] &gt;&gt;= 1<br />      <span class="keyword">end</span><br /><br />      <span class="keyword">def</span> shift_left(reg)<br />        <span class="variable">@register</span>[VF] = <span class="variable">@register</span>[reg] &gt;&gt; 7<br />        <span class="variable">@register</span>[reg] = (<span class="variable">@register</span>[reg] &lt;&lt; 1) &amp; 0xFF<br />      <span class="keyword">end</span><br /><br />      <span class="keyword">def</span> random(reg, kk)<br />        <span class="variable">@register</span>[reg] = rand(256) &amp; kk<br />      <span class="keyword">end</span><br /><br />      <span class="comment"># ...</span><br /><br /></div></div>
			<p>These are mainly just the operations that affect the VF register.  Because they require multiple steps, it was easier to move these into separate methods and leave the event loop case statement clear.  These definitions still come right out of the quiz.</p>
			<p>Finally, we have the last bit of code needed to dump registers and kick-off the program run in the first place.  Here's the code:</p>
			<div class="code"><span class="type">ruby</span><div class="body">      <span class="comment"># ...</span><br /><br />      <span class="comment"># show all registers</span><br />      <span class="keyword">def</span> dump<br />        0.upto(VF) <span class="keyword">do</span> |reg|<br />          printf(<span class="string">"V%1X:%08b\n"</span>, reg, <span class="variable">@register</span>[reg])<br />        <span class="keyword">end</span><br />      <span class="keyword">end</span><br />    <span class="keyword">end</span><br /><br />    <span class="keyword">if</span> <span class="global">$0</span> == <span class="keyword">__FILE__</span><br />      ARGV.each <span class="keyword">do</span> |program|<br />        emu = Chip8Emulator.new<br />        emu.exec(File.read(program))<br />        emu.dump<br />      <span class="keyword">end</span><br />    <span class="keyword">end</span><br /><br /></div></div>
			<p>The dump() method is a simple print routine for register names and values, iterating over all the registers.  Below that we have the code the executes and dumps each program provided as an argument, using the methods we have been examining.</p>
			<p>Boris's code did include unit tests.  Each opcode was tested against a hand crafted mini-program to check functionality.  Here's the subtraction test, for example:</p>
			<div class="code"><span class="type">ruby</span><div class="body">      <span class="comment"># ... other test code not shown ...</span><br /><br />      <span class="keyword">def</span> test_subtract<br />        <span class="variable">@emu</span>.exec(<span class="string">"\x60\x00"</span> + <span class="string">"\x61\x01"</span> + <span class="string">"\x80\x15"</span> + <span class="string">"\0\0"</span>)<br />        assert_equal [255, 1] + [0]*13 + [1], <span class="variable">@emu</span>.register<br />      <span class="keyword">end</span><br /><br />      <span class="comment"># ... other test code not shown ...</span><br /><br /></div></div>
			<p>Don't miss the other solutions folks.  Take some time to look them over.  All are quite clever.  You will even find elements not covered in this summary, like Alexandru E. Ungur's assembler!</p>
			<p>My thanks to all who took tried their hand at building their own emulator.  I hope you found it a lot easier than I did building a good ICFP emulator.</p>
			<p>In tomorrow's quiz, we will see just how far a simple method like upcase() can really go in terms of useful application...</p>
		</div>
		<div id="logo"><img src="/web/20120120002938im_/http://rubyquiz.com/images/ruby_quiz_logo.jpg" alt="" width="157" height="150" /></div>
		<div id="links">
			<span class="title">Quiz Solutions</span>
			<ol>
				<li><a href="/web/20120120002938/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/205041">Tom Rauchenwald</a></li>
				<li><a href="/web/20120120002938/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/205045">Boris Prinz</a></li>
				<li><a href="/web/20120120002938/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/205050">Alexandru E. Ungur</a></li>
				<li><a href="/web/20120120002938/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/205053">Sander Land</a></li>
				<li><a href="/web/20120120002938/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/205055">Andre Ben Hamou</a></li>
				<li><a href="/web/20120120002938/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/205093">Tom Rauchenwald (2)</a></li>
				<li><a href="/web/20120120002938/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/205132">Mitchell Koch</a></li>
				<li><a href="/web/20120120002938/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/205165">Daniel Martin</a></li>
				<li><a href="/web/20120120002938/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/205230">Adam Shelly</a></li>
				<li><a href="/web/20120120002938/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/205250">Glen F. Pankow</a></li>
				<li><a href="/web/20120120002938/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/205251">Adrian Falcone</a></li>
				<li><a href="/web/20120120002938/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/205260">Adrian Falcone (2)</a></li>
				<li><a href="/web/20120120002938/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/205285">James Edward Gray II</a></li>
				<li><a href="/web/20120120002938/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/205592">Adrian Falcone (3)</a></li>
			</ol>
			<p><a href="/web/20120120002938/http://rubyquiz.com/quiz88_sols.zip">Download Solutions</a></p>
			<p><a href="/web/20120120002938/http://rubyquiz.com/index.html">Back to Quiz Listing</a></p>
		</div>
		<div id="footer">&nbsp;</div>
	</div>
</body>
</html>





<!--
     FILE ARCHIVED ON 0:29:38 Jan 20, 2012 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 13:10:16 Jun 5, 2013.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
