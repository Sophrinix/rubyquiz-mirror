<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>


<!-- Start Wayback Rewrite JS Include -->
<script type="text/javascript" src="/static/js/jwplayer/jwplayer.js" ></script>
<script type="text/javascript" src="/static/js/video-embed-rewriter.js"></script>
<script type="text/javascript">
function initYTVideo(id)
{
	_wmVideos_.init("/web/", id);
}
</script>
<!-- End Wayback Rewrite JS Include -->

	<title>Ruby Quiz - Secret Agent 00111 (#94)</title>
	<link rel="stylesheet" type="text/css" href="/web/20120121212849cs_/http://rubyquiz.com/quiz.css" />
	<link rel="stylesheet" type="text/css" href="/web/20120121212849cs_/http://rubyquiz.com/print.css" media="print" />
</head><body>
<!-- BEGIN WAYBACK TOOLBAR INSERT -->

<script type="text/javascript" src="/static/js/disclaim-element.js" ></script>
<script type="text/javascript" src="/static/js/graph-calc.js" ></script>
<script type="text/javascript" src="/static/jflot/jquery.min.js" ></script>
<script type="text/javascript">
//<![CDATA[
var firstDate = 820454400000;
var lastDate = 1388534399999;
var wbPrefix = "/web/";
var wbCurrentUrl = "http:\/\/rubyquiz.com\/quiz94.html";

var curYear = -1;
var curMonth = -1;
var yearCount = 18;
var firstYear = 1996;
var imgWidth = 450;
var yearImgWidth = 25;
var monthImgWidth = 2;
var trackerVal = "none";
var displayDay = "21";
var displayMonth = "Jan";
var displayYear = "2012";
var prettyMonths = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

function showTrackers(val) {
	if(val == trackerVal) {
		return;
	}
	if(val == "inline") {
		document.getElementById("displayYearEl").style.color = "#ec008c";
		document.getElementById("displayMonthEl").style.color = "#ec008c";
		document.getElementById("displayDayEl").style.color = "#ec008c";		
	} else {
		document.getElementById("displayYearEl").innerHTML = displayYear;
		document.getElementById("displayYearEl").style.color = "#ff0";
		document.getElementById("displayMonthEl").innerHTML = displayMonth;
		document.getElementById("displayMonthEl").style.color = "#ff0";
		document.getElementById("displayDayEl").innerHTML = displayDay;
		document.getElementById("displayDayEl").style.color = "#ff0";
	}
   document.getElementById("wbMouseTrackYearImg").style.display = val;
   document.getElementById("wbMouseTrackMonthImg").style.display = val;
   trackerVal = val;
}
function getElementX2(obj) {
	var thing = jQuery(obj);
	if((thing == undefined) 
			|| (typeof thing == "undefined") 
			|| (typeof thing.offset == "undefined")) {
		return getElementX(obj);
	}
	return Math.round(thing.offset().left);
}
function trackMouseMove(event,element) {

   var eventX = getEventX(event);
   var elementX = getElementX2(element);
   var xOff = eventX - elementX;
	if(xOff < 0) {
		xOff = 0;
	} else if(xOff > imgWidth) {
		xOff = imgWidth;
	}
   var monthOff = xOff % yearImgWidth;

   var year = Math.floor(xOff / yearImgWidth);
	var yearStart = year * yearImgWidth;
   var monthOfYear = Math.floor(monthOff / monthImgWidth);
   if(monthOfYear > 11) {
       monthOfYear = 11;
   }
   // 1 extra border pixel at the left edge of the year:
   var month = (year * 12) + monthOfYear;
   var day = 1;
	if(monthOff % 2 == 1) {
		day = 15;
	}
	var dateString = 
		zeroPad(year + firstYear) + 
		zeroPad(monthOfYear+1,2) +
		zeroPad(day,2) + "000000";

	var monthString = prettyMonths[monthOfYear];
	document.getElementById("displayYearEl").innerHTML = year + 1996;
	document.getElementById("displayMonthEl").innerHTML = monthString;
	// looks too jarring when it changes..
	//document.getElementById("displayDayEl").innerHTML = zeroPad(day,2);

	var url = wbPrefix + dateString + '/' +  wbCurrentUrl;
	document.getElementById('wm-graph-anchor').href = url;

   //document.getElementById("wmtbURL").value="evX("+eventX+") elX("+elementX+") xO("+xOff+") y("+year+") m("+month+") monthOff("+monthOff+") DS("+dateString+") Moy("+monthOfYear+") ms("+monthString+")";
   if(curYear != year) {
       var yrOff = year * yearImgWidth;
       document.getElementById("wbMouseTrackYearImg").style.left = yrOff + "px";
       curYear = year;
   }
   if(curMonth != month) {
       var mtOff = year + (month * monthImgWidth) + 1;
       document.getElementById("wbMouseTrackMonthImg").style.left = mtOff + "px";
       curMonth = month;
   }
}
//]]>
</script>

<style type="text/css">body{margin-top:0!important;padding-top:0!important;min-width:800px!important;}#wm-ipp a:hover{text-decoration:underline!important;}</style>
<div id="wm-ipp" style="display:none; position:relative;padding:0 5px;min-height:70px;min-width:800px; z-index:9000;">
<div id="wm-ipp-inside" style="position:fixed;padding:0!important;margin:0!important;width:97%;min-width:780px;border:5px solid #000;border-top:none;background-image:url(/static/images/toolbar/wm_tb_bk_trns.png);text-align:center;-moz-box-shadow:1px 1px 3px #333;-webkit-box-shadow:1px 1px 3px #333;box-shadow:1px 1px 3px #333;font-size:11px!important;font-family:'Lucida Grande','Arial',sans-serif!important;">
   <table style="border-collapse:collapse;margin:0;padding:0;width:100%;"><tbody><tr>
   <td style="padding:10px;vertical-align:top;min-width:110px;">
   <a href="/web/" title="Wayback Machine home page" style="background-color:transparent;border:none;"><img src="/static/images/toolbar/wayback-toolbar-logo.png" alt="Wayback Machine" width="110" height="39" border="0"/></a>
   </td>
   <td style="padding:0!important;text-align:center;vertical-align:top;width:100%;">

       <table style="border-collapse:collapse;margin:0 auto;padding:0;width:570px;"><tbody><tr>
       <td style="padding:3px 0;" colspan="2">
       <form target="_top" method="get" action="/web/form-submit.jsp" name="wmtb" id="wmtb" style="margin:0!important;padding:0!important;"><input type="text" name="url" id="wmtbURL" value="http://rubyquiz.com/quiz94.html" style="width:400px;font-size:11px;font-family:'Lucida Grande','Arial',sans-serif;" onfocus="javascript:this.focus();this.select();" /><input type="hidden" name="type" value="replay" /><input type="hidden" name="date" value="20120121212849" /><input type="submit" value="Go" style="font-size:11px;font-family:'Lucida Grande','Arial',sans-serif;margin-left:5px;" /><span id="wm_tb_options" style="display:block;"></span></form>
       </td>
       <td style="vertical-align:bottom;padding:5px 0 0 0!important;" rowspan="2">
           <table style="border-collapse:collapse;width:110px;color:#99a;font-family:'Helvetica','Lucida Grande','Arial',sans-serif;"><tbody>
			
           <!-- NEXT/PREV MONTH NAV AND MONTH INDICATOR -->
           <tr style="width:110px;height:16px;font-size:10px!important;">
           	<td style="padding-right:9px;font-size:11px!important;font-weight:bold;text-transform:uppercase;text-align:right;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20101127173809/http://rubyquiz.com/quiz94.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="27 Nov 2010"><strong>NOV</strong></a>
		                
               </td>
               <td id="displayMonthEl" style="background:#000;color:#ff0;font-size:11px!important;font-weight:bold;text-transform:uppercase;width:34px;height:15px;padding-top:1px;text-align:center;" title="You are here: 21:28:49 Jan 21, 2012">JAN</td>
				<td style="padding-left:9px;font-size:11px!important;font-weight:bold;text-transform:uppercase;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20120418123157/http://www.rubyquiz.com/quiz94.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="18 Apr 2012"><strong>APR</strong></a>
		                
               </td>
           </tr>

           <!-- NEXT/PREV CAPTURE NAV AND DAY OF MONTH INDICATOR -->
           <tr>
               <td style="padding-right:9px;white-space:nowrap;overflow:visible;text-align:right!important;vertical-align:middle!important;" nowrap="nowrap">
               
		                <a href="/web/20101127173809/http://rubyquiz.com/quiz94.html" title="17:38:09 Nov 27, 2010" style="background-color:transparent;border:none;"><img src="/static/images/toolbar/wm_tb_prv_on.png" alt="Previous capture" width="14" height="16" border="0" /></a>
		                
               </td>
               <td id="displayDayEl" style="background:#000;color:#ff0;width:34px;height:24px;padding:2px 0 0 0;text-align:center;font-size:24px;font-weight: bold;" title="You are here: 21:28:49 Jan 21, 2012">21</td>
				<td style="padding-left:9px;white-space:nowrap;overflow:visible;text-align:left!important;vertical-align:middle!important;" nowrap="nowrap">
               
		                <a href="/web/20120122024728/http://rubyquiz.com/quiz94.html" title="2:47:28 Jan 22, 2012" style="background-color:transparent;border:none;"><img src="/static/images/toolbar/wm_tb_nxt_on.png" alt="Next capture" width="14" height="16" border="0"/></a>
		                
			    </td>
           </tr>

           <!-- NEXT/PREV YEAR NAV AND YEAR INDICATOR -->
           <tr style="width:110px;height:13px;font-size:9px!important;">
				<td style="padding-right:9px;font-size:11px!important;font-weight: bold;text-align:right;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20101127173809/http://rubyquiz.com/quiz94.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="27 Nov 2010"><strong>2010</strong></a>
		                
               </td>
               <td id="displayYearEl" style="background:#000;color:#ff0;font-size:11px!important;font-weight: bold;padding-top:1px;width:34px;height:13px;text-align:center;" title="You are here: 21:28:49 Jan 21, 2012">2012</td>
				<td style="padding-left:9px;font-size:11px!important;font-weight: bold;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20130215052537/http://rubyquiz.com/quiz94.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="15 Feb 2013"><strong>2013</strong></a>
		                
				</td>
           </tr>
           </tbody></table>
       </td>

       </tr>
       <tr>
       <td style="vertical-align:middle;padding:0!important;">
           <a href="/web/20120121212849*/http://rubyquiz.com/quiz94.html" style="color:#33f;font-size:11px;font-weight:bold;background-color:transparent;border:none;" title="See a list of every capture for this URL"><strong>26 captures</strong></a>
           <div style="margin:0!important;padding:0!important;color:#666;font-size:9px;padding-top:2px!important;white-space:nowrap;" title="Timespan for captures of this URL">20 Oct 06 - 15 Feb 13</div>
       </td>
       <td style="padding:0!important;">
       <a style="position:relative; white-space:nowrap; width:450px;height:27px;" href="" id="wm-graph-anchor">
       <div id="wm-ipp-sparkline" style="position:relative; white-space:nowrap; width:450px;height:27px;background-color:#fff;cursor:pointer;border-right:1px solid #ccc;" title="Explore captures for this URL">
			<img id="sparklineImgId" style="position:absolute; z-index:9012; top:0px; left:0px;"
				onmouseover="showTrackers('inline');" 
				onmouseout="showTrackers('none');"
				onmousemove="trackMouseMove(event,this)"
				alt="sparklines"
				width="450"
				height="27"
				border="0"
				src="/web/jsp/graph.jsp?graphdata=450_27_1996:-1:000000000000_1997:-1:000000000000_1998:-1:000000000000_1999:-1:000000000000_2000:-1:000000000000_2001:-1:000000000000_2002:-1:000000000000_2003:-1:000000000000_2004:-1:000000000000_2005:-1:000000000000_2006:-1:000000000100_2007:-1:000100100000_2008:-1:000000000000_2009:-1:000000000000_2010:-1:000000000010_2011:-1:000000000000_2012:0:30016000a100_2013:-1:010000000000"></img>
			<img id="wbMouseTrackYearImg" 
				style="display:none; position:absolute; z-index:9010;"
				width="25" 
				height="27"
				border="0"
				src="/static/images/toolbar/transp-yellow-pixel.png"></img>
			<img id="wbMouseTrackMonthImg"
				style="display:none; position:absolute; z-index:9011; " 
				width="2"
				height="27" 
				border="0"
				src="/static/images/toolbar/transp-red-pixel.png"></img>
       </div>
		</a>

       </td>
       </tr></tbody></table>
   </td>
   <td style="text-align:right;padding:5px;width:65px;font-size:11px!important;">
       <a href="javascript:;" onclick="document.getElementById('wm-ipp').style.display='none';" style="display:block;padding-right:18px;background:url(/static/images/toolbar/wm_tb_close.png) no-repeat 100% 0;color:#33f;font-family:'Lucida Grande','Arial',sans-serif;margin-bottom:23px;background-color:transparent;border:none;" title="Close the toolbar">Close</a>
       <a href="http://faq.web.archive.org/" style="display:block;padding-right:18px;background:url(/static/images/toolbar/wm_tb_help.png) no-repeat 100% 0;color:#33f;font-family:'Lucida Grande','Arial',sans-serif;background-color:transparent;border:none;" title="Get some help using the Wayback Machine">Help</a>
   </td>
   </tr></tbody></table>

</div>
</div>
<script type="text/javascript">
 var wmDisclaimBanner = document.getElementById("wm-ipp");
 if(wmDisclaimBanner != null) {
   disclaimElement(wmDisclaimBanner);
 }
</script>
<!-- END WAYBACK TOOLBAR INSERT -->

	<div id="page">
		<div id="header"><span class="ruby">Ruby</span> <span class="quiz">Quiz</span></div>
		<div id="content">
			<span class="title">Secret Agent 00111 (#94)</span>
			<p>by Mauricio Fernandez</p>
			<p>"Secret Agent 00111 is back at the Casino again, playing a game of chance, while the fate of mankind hangs in the balance. Each game consists of a series of favorable events (probability p), terminated by the first occurrence of an unfavorable event (probability q = 1 - p). More specifically, the game is roulette, and the unfavorable event is the occurrence of 0, which has a probability of q = 1 / 37. No one seriously doubts that 00111 will come through again, but the Secret Service is quite concerned about communicating the blow-by-blow description to Whitehall.</p>
			<p>The bartender, who is a free-lance agent, has a binary channel available, but he charges a stiff fee for each bit sent. The problem perplexing the Service is how to encode the vicissitudes of the wheel[1] so as to place the least strain on the Royal Exchequer."</p>
			<p>00111 will be needing the communication device in 48H. Q has decided to give him a programmable gizmo, with a built-in Ruby interpreter, in the hope that 00111 will code/play with it on his own and do his best to return it in the original condition, very unlike all the other gadgets he's been given before. </p>
			<p>Therefore, Q can enjoy the luxury of coding in Ruby, and he's confident he will be able to complete the task in time. Q's first thought of using Zlib::Deflate to compress the data as shown in the following example:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="comment"># EVENTS will be a large sequence of boolean events:</span><br />    <span class="comment">#   true     favorable event   (00111 wins)</span><br />    <span class="comment">#   false    unfavorable event (00111 loses)</span><br />    <span class="comment"># we generate a sample one as follows:</span><br />    EVENTS = (0..1000).map{ rand() &gt; 1.0 / 37 }<br /><br />    <span class="comment"># compress</span><br />    require <span class="string">'zlib'</span><br />    string = EVENTS.map{|x| x ? <span class="string">"0"</span> : <span class="string">"1"</span>}.join(<span class="string">""</span>)<br />    string.size                                       <span class="comment"># =&gt; 1001</span><br />    compressed = Zlib::Deflate.deflate(string)<br />    compressed.size                                   <span class="comment"># =&gt; 69</span><br /><br />    <span class="comment"># now 'compressed' is transmitted by the bartender</span><br /><br /></div></div>
			<p>However, Q has been wary of Zlib since he ran into some sort of BufferError when he was installing Mongrel using RubyGems, and he still mourns the sad demise of 00110, which was the direct result of a binary incompatibility between a Ruby build and a third-party extension.</p>
			<p>Moreover, the MI6 has been spying on the management of the Casino, which faced a similar problem and solved it long ago, and intercepted the following message at the time the Casino's system was being developed:</p>
			<p class="example">TEST RUN 43<br />-----------<br />Original size: 10000<br />Compressed to: 242 bytes<br />Result using deflate: 462 bytes</p>
			<p>Q keeps a very detailed log of his activities, so you know he has been reading up on Information Theory, and has found a paper that addresses the very problem he needs to solve:</p>
			<p class="example">Run-length encodings--S. W. Golomb (1966); IEEE Trans Info Theory 12(3):399[1] </p>
			<p>He also found some information in the Wikipedia[2], and wrote the following unit tests before feeling indisposed while reading RailsBlob[3]:</p>
			<p><a href="/web/20120121212849/http://rubyquiz.com/test_00111_gizmo.rb">Quiz Tests</a></p>
			<p>Q has also wrote some code to exert the SecretAgent00111CommunicationGizmo:</p>
			<p><a href="/web/20120121212849/http://rubyquiz.com/00111.rb">Quiz Gimzo</a></p>
			<p>Finally, Q left a note with the expected (approximate) output one should get when running 00111.rb:</p>
			<p class="example">Dear myself,<br /><br />please make sure that<br /> ruby 00111.rb<br />writes something like this to stdout before you hand your beautiful creation<br />to the brutish 00111:<br /><br />  Probability : 0.972972972972973<br />  Approx. with: 0.957603280698574<br />  Exponent: 4  (p**4 = 1/2; m = 2 ** e = 16)<br />  Decoded correctly?   yes<br />  Original size: 1000<br />  Compressed to: 23 bytes (2.3%)<br />  Compare to     57 bytes  using deflate...<br />  =========================================<br />  Testing buffered encoder/decoder<br />  Decoded correctly? (b)  yes<br />  Decoded correctly? (c)  yes<br />  <br />Sincerely,<br /><br />Q</p>
			<p>Unfortunately, it seems Q is not doing any better, but management is sure you will be able to complete Q's code (that is, write 00111_gizmo.rb such that the above unit tests pass and the sample program works) in time, given all the material he left. </p>
			<p>00111's mission will require _at least_ the following tests to pass:</p>
			<p class="example">* test_rle<br />* test_unrle<br />* test_basic_encoding<br />* test_basic_decoding<br />* test_round_trip_probabilistic</p>
			<p>The other tests are optional (you can choose to comment them, but the sample program won't execute correctly if they fail, though), but you should probably do your best to make them pass: this is an excellent opportunity to prove your skills, and it seems Q's retirement is not too far away...</p>
			<p>Good luck.</p>
			<p>PS: you owe me one, man. Such opportunities are rare.</p>
			<p class="example">----<br />[1] http://urchin.earth.li/~twic/Golombs_Original_Paper/<br />[2] http://en.wikipedia.org/wiki/Golomb_coding<br />[3] http://railsblob.blogspot.com/</p>
			<hr />
			<p><span class="title">Quiz Summary</span></p>
			<p class="example">Mission Report</p>
			<p>Once again Secret Agent 00111 has saved the world from certain doom.  As usual the damage report was gratuitous:  destroyed vehicles worth my salary for the next five years, the usual string of sexual harassment and unwanted pregnancy lawsuits we will need to address, and one missing flock of sheep according to a local farmer.  (Don't ask!)  Full details to follow under separate cover.</p>
			<p>00111's secret to success really was rather brilliant, though please don't let on that we know that.  The agent has more than enough ego as it is.  Recognizing that Q was not going to come through this time, 00111 took the prototype device to a hacker operating under the alias Boris Prinz.  (We're still trying to link Boris to a real identity, but we suspect him of numerous famous hacker incidents.)  This turned out to be the key choice for 00111.</p>
			<p>I'm sure you recall the brutal demise of 00100 when forced to rely on a Java programmer's abilities while under severe time constraints.  Desperate for quicker results, 00111 gambled on a not-yet-mainstream community of Ruby programmers.  It turns out these Ruby guys are a hidden community of elite hackers who seem to do this kind of this for fun.  It's rather bizarre, but the results are undeniable.</p>
			<p>Naturally, Q's gizmo was utterly destroyed during 00111's daring escape through the casino's canal drainage system.  However, we're now monitoring all Boris Prinz communications and have managed to intercept an email message where he is bragging to the Ruby community about his success.  The message contains a prototype of the code 00111 loaded into the gizmo.  I'm going to examine that code in this next section so we have it on file.</p>
			<p class="example">Ruby Code Analysis</p>
			<p>We will look at this code slightly out of order, so that we might better understand the thinking of Boris in his design.  First, here is the heart of how boris managed to keep the communications so short and to the point:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="keyword">module</span> SecretAgent00111CommunicationGizmo<br />      <span class="keyword">class</span> UndefinedRLE &lt; Exception<br />      <span class="keyword">end</span><br /><br />      <span class="keyword">def</span> <span class="keyword">self</span>.rle events<br />        raise UndefinedRLE.new <span class="keyword">if</span> events.size == 0<br />        rl = []<br />        truevals = 0<br />        events.each <span class="keyword">do</span> |result|<br />          <span class="keyword">if</span> result<br />            truevals += 1<br />          <span class="keyword">else</span><br />            rl &lt;&lt; truevals<br />            truevals = 0<br />          <span class="keyword">end</span><br />        <span class="keyword">end</span><br />        raise UndefinedRLE.new <span class="keyword">if</span> truevals != 0<br />        rl<br />      <span class="keyword">end</span><br />    <span class="keyword">end</span><br /><br /></div></div>
			<p>What you have here is a method that accepts a series of favorable or unfavorable events, represented by Ruby's boolean values true and false.  The method returns a Run Length Encoding for these events, counting the number of truths that occur in a row.  In order for this to be possible for any size stream, a trailing false must be appended after each each series of truths.</p>
			<p>Here's a sample usage, so you can see what I mean here:</p>
			<p class="example">&gt;&gt; SecretAgent00111CommunicationGizmo.rle(<br />?&gt;   [true] * 10 +    # 10 favorable events<br />?&gt;   [false]     +    # the trailing false<br />?&gt;   [false]     +    # 0 favorable events and trailing false<br />?&gt;   [true] * 10 +    # 10 more favorable events<br />?&gt;   [false]          # the trailing false<br />&gt;&gt; )<br />=&gt; [10, 0, 10]</p>
			<p>This method wasn't used in the gizmo's actual solution, though it helped us make sense of the process.  Boriz claimed it was part of some "Test Driven Development (TDD)" process.  Since none of our programmers are familiar with the concept, we assume he made it up.</p>
			<p>This leads us to the closely related unencode method:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="keyword">module</span> SecretAgent00111CommunicationGizmo<br />      <span class="keyword">def</span> <span class="keyword">self</span>.unrle rl<br />        events = []<br />        rl.each {|n| events += [<span class="keyword">true</span>]*n + [<span class="keyword">false</span>]}<br />        events<br />      <span class="keyword">end</span><br />    <span class="keyword">end</span><br /><br /></div></div>
			<p>Here we are examining the reverse operation, which unencodes the counts and adds back the trailing false markers.</p>
			<p>The gizmo's actual encoding process was driven by the following method:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    require <span class="string">'stringio'</span><br /><br />    <span class="keyword">module</span> SecretAgent00111CommunicationGizmo<br />      <span class="keyword">def</span> <span class="keyword">self</span>.encode events, exponent<br />        io = StringIO.new<br />        e = Encoder.new(exponent, io)<br />        events.each <span class="keyword">do</span> |result|<br />          e &lt;&lt; result<br />        <span class="keyword">end</span><br />        e.finish<br />        io.string<br />      <span class="keyword">end</span><br />    <span class="keyword">end</span><br /><br /></div></div>
			<p>Here again we have the events and you can see that we also receive an exponent, which we will discuss in a bit.  The events are fed to a custom Encoder object which encodes them and writes them to the specified IO parameter.  A StringIO object is used as a stand-in IO here to collect the results in a Ruby String.</p>
			<p>The Encoder is the source of most of the magic.  Here is that code:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="keyword">module</span> SecretAgent00111CommunicationGizmo<br />      <span class="keyword">class</span> Encoder<br />        <span class="keyword">def</span> initialize exponent, io<br />          <span class="variable">@exponent</span> = exponent<br />          <span class="variable">@io</span> = io<br />          <span class="variable">@events</span> = []<br />          <span class="variable">@bits</span> = <span class="string">''</span><br />          <span class="variable">@io</span> &lt;&lt; exponent.chr<br />        <span class="keyword">end</span><br /><br />        <span class="keyword">def</span> &lt;&lt; result<br />          <span class="variable">@events</span> &lt;&lt; result<br />          <span class="keyword">if</span> result == <span class="keyword">false</span><br />            encode_events<br />          <span class="keyword">end</span><br />        <span class="keyword">end</span><br /><br />        <span class="keyword">def</span> encode_events<br />          n = <span class="variable">@events</span>.size - 1<br />          <span class="variable">@events</span> = []<br />          <span class="variable">@bits</span> &lt;&lt; <span class="string">"1"</span> * (n / 2**<span class="variable">@exponent</span>)<br />          <span class="variable">@bits</span> &lt;&lt; <span class="string">"%0#{@exponent+1}B"</span> % (n % 2**<span class="variable">@exponent</span>)<br />          flush_bytes<br />        <span class="keyword">end</span><br /><br />        <span class="keyword">def</span> flush_bytes<br />          <span class="comment"># write every 8 bits to the stream:</span><br />          <span class="variable">@bits</span>.gsub!(<span class="string">/[01]{8}/</span>) <span class="keyword">do</span> |byte|<br />            <span class="variable">@io</span> &lt;&lt; byte.to_i(2).chr<br />            <span class="string">''</span><br />          <span class="keyword">end</span><br />        <span class="keyword">end</span><br /><br />        <span class="keyword">def</span> finish<br />          <span class="variable">@events</span> &lt;&lt; <span class="keyword">false</span><br />          encode_events<br />          <span class="comment"># fill up remaining byte with "1"s:</span><br />          rest = <span class="variable">@bits</span>.size % 8<br />          <span class="keyword">if</span> rest != 0<br />            <span class="variable">@bits</span> &lt;&lt; <span class="string">"1"</span> * (8 - rest)<br />          <span class="keyword">end</span><br />          flush_bytes<br />        <span class="keyword">end</span><br />      <span class="keyword">end</span><br />    <span class="keyword">end</span><br /><br /></div></div>
			<p>The Encoder begins by setting up variables to hold the exponent, IO stream, events, and a bit encoding.  You can see that it sends the exponent through the stream right away.  That's required by the encoding, which works out to be this:</p>
			<p class="example">1.  A byte representing the exponent used to encode events<br />2.  One or more encoded numbers, each consisting of the following:<br />    a.  A group of one bits number / 2 ** exponent in length<br />    b.  A zero bit<br />    c.  Exponent bits representing number % 2 ** exponent<br />3.  Any one bits needed to pad the stream length to a multiple of eight</p>
			<p>That list, really defines the rest of the methods we are looking at here.  First, &lt;&lt;() is used to add events and it always triggers the call to encode_events() when a false is encountered.  That method turns the event list into the bits described by 2a, 2b, and 2c.  encode_events() then triggers a call to flush_bytes(), which sends those bits to the stream whenever we have at least eight (so they can be converted into binary byte data).  Finally, finish() handles step 3 by adding the extra one bits needed.</p>
			<p>Let's look at how that turns out when received at the other end.  Again, we have a simple method driving the process:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    require <span class="string">'stringio'</span><br /><br />    <span class="keyword">module</span> SecretAgent00111CommunicationGizmo<br />      <span class="keyword">def</span> <span class="keyword">self</span>.decode data<br />        events = Decoder.new(StringIO.new(data)).read<br />        events.pop <span class="comment"># remove last false</span><br />        events<br />      <span class="keyword">end</span><br />    <span class="keyword">end</span><br /><br /></div></div>
			<p>This method wraps the stream in a custom Decoder object and reads the encoded events.  The last false is removed, because it's just the marker that came with the final series of true events, and the event list is returned.</p>
			<p>The Decoder is the final piece of the puzzle:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="keyword">module</span> SecretAgent00111CommunicationGizmo<br />      <span class="keyword">class</span> ExponentUndefined &lt; Exception<br />      <span class="keyword">end</span><br /><br />      <span class="keyword">class</span> Decoder<br />        <span class="keyword">def</span> bits(string)<br />          string.unpack(<span class="string">"B*"</span>)[0]<br />        <span class="keyword">end</span><br /><br />        <span class="keyword">def</span> initialize io<br />          <span class="variable">@io</span> = io<br />          <span class="variable">@exponent</span> = <span class="keyword">nil</span><br />          <span class="variable">@bits</span> = <span class="string">''</span><br />          <span class="variable">@t</span> = <span class="variable">@n</span> = <span class="keyword">nil</span><br />        <span class="keyword">end</span><br /><br />        <span class="keyword">def</span> exponent<br />          <span class="keyword">return</span> <span class="variable">@exponent</span> <span class="keyword">if</span> <span class="variable">@exponent</span><br />          e = <span class="variable">@io</span>.getc<br />          <span class="keyword">if</span> e<br />            <span class="variable">@exponent</span> = e<br />          <span class="keyword">else</span><br />            raise ExponentUndefined.new<br />          <span class="keyword">end</span><br />          <span class="variable">@exponent</span><br />        <span class="keyword">end</span><br /><br />        <span class="keyword">def</span> add_events<br />          n = <span class="variable">@n</span><br />          n += <span class="variable">@t</span> * 2**exponent <span class="keyword">if</span> <span class="variable">@t</span><br />          <span class="variable">@t</span> = <span class="variable">@n</span> = <span class="keyword">nil</span><br />          <span class="variable">@events</span> += SecretAgent00111CommunicationGizmo.unrle([n])<br />        <span class="keyword">end</span><br /><br />        <span class="keyword">def</span> decode_bits<br />          loop <span class="keyword">do</span><br />            found = <span class="keyword">false</span><br />            <span class="keyword">if</span> <span class="variable">@bits</span> =~ <span class="string">/^(1+)0/</span><br />              <span class="variable">@t</span> = <span class="global">$1</span>.size<br />              <span class="variable">@bits</span>.sub!(<span class="string">/^(1+)/</span>, <span class="string">''</span>)<br />              found = <span class="keyword">true</span><br />            <span class="keyword">end</span><br />            re = Regexp.new(<span class="string">"^0([01]{#{exponent}})"</span>)<br />            <span class="keyword">if</span> <span class="variable">@bits</span> =~ re<br />              <span class="variable">@n</span> = <span class="global">$1</span>.to_i(2)<br />              <span class="variable">@bits</span>.sub!(re, <span class="string">''</span>)<br />              add_events<br />              found = <span class="keyword">true</span><br />            <span class="keyword">end</span><br />            <span class="keyword">return</span> <span class="keyword">unless</span> found<br />          <span class="keyword">end</span><br />        <span class="keyword">end</span><br /><br />        <span class="keyword">def</span> read<br />          <span class="variable">@events</span> = []<br />          <span class="keyword">begin</span><br />            exponent<br />            data = <span class="variable">@io</span>.read<br />            <span class="variable">@bits</span> += bits(data)<br />            decode_bits<br />          <span class="keyword">rescue</span> ExponentUndefined<br />            <span class="comment"># exponent not available yet in stream, try again later</span><br />          <span class="keyword">end</span><br />          <span class="variable">@events</span><br />        <span class="keyword">end</span><br />      <span class="keyword">end</span><br />    <span class="keyword">end</span><br /><br /></div></div>
			<p>Start with initialize(), which is a setup very similar to Encoder.  The @t and @n variables are used to track the sequence of true events found and the encoded number itself.  Next skip to read() which is the primary work method.  It begins by using exponent() to find the magic number, if present.  If the exponent isn't yet available, read() returns zero events and the code can try the stream again later.  Next, bits() is a trivial wrapper to unpack all of the bytes (most significant first) into a String of ones and zeros.</p>
			<p>The real work is done in decode_bits().  This method loops over the bits looking first for the run of one bits and then for the exponent length remainder.  When both of those are located, a call to add_events() rebuilds the original encoded number which unrle() reverts to a series of events.</p>
			<p class="example">Summary</p>
			<p>As you can see, 00111 survived thanks the the cunning of the hacker Boris Prinz.  Had a less skilled coder been involved we might be inducting 01000 right now.  Please send a care package to Boris's team:  Daniel Martin, Karl Czisch, Kero, and Pierre Barbier de Reuille.  We own them all our gratitude.</p>
			<p>Don't let 00111 get too comfortable.  We'll be sending him back out on assignment tomorrow morning, this time into the villainous Lisp domains to hijack their secrets...</p>
		</div>
		<div id="logo"><img src="/web/20120121212849im_/http://rubyquiz.com/images/ruby_quiz_logo.jpg" alt="" width="157" height="150" /></div>
		<div id="links">
			<span class="title">Quiz Solutions</span>
			<ol>
				<li><a href="/web/20120121212849/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/213888">Daniel Martin</a></li>
				<li><a href="/web/20120121212849/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/213903">Karl Czisch</a></li>
				<li><a href="/web/20120121212849/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/215030">Kero</a></li>
				<li><a href="/web/20120121212849/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/215254">Pierre Barbier de Reuille</a></li>
				<li><a href="/web/20120121212849/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/215263">Boris Prinz</a></li>
				<li><a href="/web/20120121212849/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/215707">Eric Torreborre</a></li>
			</ol>
			<p><a href="/web/20120121212849/http://rubyquiz.com/quiz94_sols.zip">Download Solutions</a></p>
			<p><a href="/web/20120121212849/http://rubyquiz.com/index.html">Back to Quiz Listing</a></p>
		</div>
		<div id="footer">&nbsp;</div>
	</div>
</body>
</html>





<!--
     FILE ARCHIVED ON 21:28:49 Jan 21, 2012 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 13:10:22 Jun 5, 2013.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
