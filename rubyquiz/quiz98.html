<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>


<!-- Start Wayback Rewrite JS Include -->
<script type="text/javascript" src="/static/js/jwplayer/jwplayer.js" ></script>
<script type="text/javascript" src="/static/js/video-embed-rewriter.js"></script>
<script type="text/javascript">
function initYTVideo(id)
{
	_wmVideos_.init("/web/", id);
}
</script>
<!-- End Wayback Rewrite JS Include -->

	<title>Ruby Quiz - A* (#98)</title>
	<link rel="stylesheet" type="text/css" href="/web/20120121222850cs_/http://rubyquiz.com/quiz.css" />
	<link rel="stylesheet" type="text/css" href="/web/20120121222850cs_/http://rubyquiz.com/print.css" media="print" />
</head><body>
<!-- BEGIN WAYBACK TOOLBAR INSERT -->

<script type="text/javascript" src="/static/js/disclaim-element.js" ></script>
<script type="text/javascript" src="/static/js/graph-calc.js" ></script>
<script type="text/javascript" src="/static/jflot/jquery.min.js" ></script>
<script type="text/javascript">
//<![CDATA[
var firstDate = 820454400000;
var lastDate = 1388534399999;
var wbPrefix = "/web/";
var wbCurrentUrl = "http:\/\/rubyquiz.com\/quiz98.html";

var curYear = -1;
var curMonth = -1;
var yearCount = 18;
var firstYear = 1996;
var imgWidth = 450;
var yearImgWidth = 25;
var monthImgWidth = 2;
var trackerVal = "none";
var displayDay = "21";
var displayMonth = "Jan";
var displayYear = "2012";
var prettyMonths = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

function showTrackers(val) {
	if(val == trackerVal) {
		return;
	}
	if(val == "inline") {
		document.getElementById("displayYearEl").style.color = "#ec008c";
		document.getElementById("displayMonthEl").style.color = "#ec008c";
		document.getElementById("displayDayEl").style.color = "#ec008c";		
	} else {
		document.getElementById("displayYearEl").innerHTML = displayYear;
		document.getElementById("displayYearEl").style.color = "#ff0";
		document.getElementById("displayMonthEl").innerHTML = displayMonth;
		document.getElementById("displayMonthEl").style.color = "#ff0";
		document.getElementById("displayDayEl").innerHTML = displayDay;
		document.getElementById("displayDayEl").style.color = "#ff0";
	}
   document.getElementById("wbMouseTrackYearImg").style.display = val;
   document.getElementById("wbMouseTrackMonthImg").style.display = val;
   trackerVal = val;
}
function getElementX2(obj) {
	var thing = jQuery(obj);
	if((thing == undefined) 
			|| (typeof thing == "undefined") 
			|| (typeof thing.offset == "undefined")) {
		return getElementX(obj);
	}
	return Math.round(thing.offset().left);
}
function trackMouseMove(event,element) {

   var eventX = getEventX(event);
   var elementX = getElementX2(element);
   var xOff = eventX - elementX;
	if(xOff < 0) {
		xOff = 0;
	} else if(xOff > imgWidth) {
		xOff = imgWidth;
	}
   var monthOff = xOff % yearImgWidth;

   var year = Math.floor(xOff / yearImgWidth);
	var yearStart = year * yearImgWidth;
   var monthOfYear = Math.floor(monthOff / monthImgWidth);
   if(monthOfYear > 11) {
       monthOfYear = 11;
   }
   // 1 extra border pixel at the left edge of the year:
   var month = (year * 12) + monthOfYear;
   var day = 1;
	if(monthOff % 2 == 1) {
		day = 15;
	}
	var dateString = 
		zeroPad(year + firstYear) + 
		zeroPad(monthOfYear+1,2) +
		zeroPad(day,2) + "000000";

	var monthString = prettyMonths[monthOfYear];
	document.getElementById("displayYearEl").innerHTML = year + 1996;
	document.getElementById("displayMonthEl").innerHTML = monthString;
	// looks too jarring when it changes..
	//document.getElementById("displayDayEl").innerHTML = zeroPad(day,2);

	var url = wbPrefix + dateString + '/' +  wbCurrentUrl;
	document.getElementById('wm-graph-anchor').href = url;

   //document.getElementById("wmtbURL").value="evX("+eventX+") elX("+elementX+") xO("+xOff+") y("+year+") m("+month+") monthOff("+monthOff+") DS("+dateString+") Moy("+monthOfYear+") ms("+monthString+")";
   if(curYear != year) {
       var yrOff = year * yearImgWidth;
       document.getElementById("wbMouseTrackYearImg").style.left = yrOff + "px";
       curYear = year;
   }
   if(curMonth != month) {
       var mtOff = year + (month * monthImgWidth) + 1;
       document.getElementById("wbMouseTrackMonthImg").style.left = mtOff + "px";
       curMonth = month;
   }
}
//]]>
</script>

<style type="text/css">body{margin-top:0!important;padding-top:0!important;min-width:800px!important;}#wm-ipp a:hover{text-decoration:underline!important;}</style>
<div id="wm-ipp" style="display:none; position:relative;padding:0 5px;min-height:70px;min-width:800px; z-index:9000;">
<div id="wm-ipp-inside" style="position:fixed;padding:0!important;margin:0!important;width:97%;min-width:780px;border:5px solid #000;border-top:none;background-image:url(/static/images/toolbar/wm_tb_bk_trns.png);text-align:center;-moz-box-shadow:1px 1px 3px #333;-webkit-box-shadow:1px 1px 3px #333;box-shadow:1px 1px 3px #333;font-size:11px!important;font-family:'Lucida Grande','Arial',sans-serif!important;">
   <table style="border-collapse:collapse;margin:0;padding:0;width:100%;"><tbody><tr>
   <td style="padding:10px;vertical-align:top;min-width:110px;">
   <a href="/web/" title="Wayback Machine home page" style="background-color:transparent;border:none;"><img src="/static/images/toolbar/wayback-toolbar-logo.png" alt="Wayback Machine" width="110" height="39" border="0"/></a>
   </td>
   <td style="padding:0!important;text-align:center;vertical-align:top;width:100%;">

       <table style="border-collapse:collapse;margin:0 auto;padding:0;width:570px;"><tbody><tr>
       <td style="padding:3px 0;" colspan="2">
       <form target="_top" method="get" action="/web/form-submit.jsp" name="wmtb" id="wmtb" style="margin:0!important;padding:0!important;"><input type="text" name="url" id="wmtbURL" value="http://rubyquiz.com/quiz98.html" style="width:400px;font-size:11px;font-family:'Lucida Grande','Arial',sans-serif;" onfocus="javascript:this.focus();this.select();" /><input type="hidden" name="type" value="replay" /><input type="hidden" name="date" value="20120121222850" /><input type="submit" value="Go" style="font-size:11px;font-family:'Lucida Grande','Arial',sans-serif;margin-left:5px;" /><span id="wm_tb_options" style="display:block;"></span></form>
       </td>
       <td style="vertical-align:bottom;padding:5px 0 0 0!important;" rowspan="2">
           <table style="border-collapse:collapse;width:110px;color:#99a;font-family:'Helvetica','Lucida Grande','Arial',sans-serif;"><tbody>
			
           <!-- NEXT/PREV MONTH NAV AND MONTH INDICATOR -->
           <tr style="width:110px;height:16px;font-size:10px!important;">
           	<td style="padding-right:9px;font-size:11px!important;font-weight:bold;text-transform:uppercase;text-align:right;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20110728131810/http://www.rubyquiz.com/quiz98.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="28 Jul 2011"><strong>JUL</strong></a>
		                
               </td>
               <td id="displayMonthEl" style="background:#000;color:#ff0;font-size:11px!important;font-weight:bold;text-transform:uppercase;width:34px;height:15px;padding-top:1px;text-align:center;" title="You are here: 22:28:50 Jan 21, 2012">JAN</td>
				<td style="padding-left:9px;font-size:11px!important;font-weight:bold;text-transform:uppercase;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20120418112342/http://www.rubyquiz.com/quiz98.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="18 Apr 2012"><strong>APR</strong></a>
		                
               </td>
           </tr>

           <!-- NEXT/PREV CAPTURE NAV AND DAY OF MONTH INDICATOR -->
           <tr>
               <td style="padding-right:9px;white-space:nowrap;overflow:visible;text-align:right!important;vertical-align:middle!important;" nowrap="nowrap">
               
		                <a href="/web/20110728131810/http://www.rubyquiz.com/quiz98.html" title="13:18:10 Jul 28, 2011" style="background-color:transparent;border:none;"><img src="/static/images/toolbar/wm_tb_prv_on.png" alt="Previous capture" width="14" height="16" border="0" /></a>
		                
               </td>
               <td id="displayDayEl" style="background:#000;color:#ff0;width:34px;height:24px;padding:2px 0 0 0;text-align:center;font-size:24px;font-weight: bold;" title="You are here: 22:28:50 Jan 21, 2012">21</td>
				<td style="padding-left:9px;white-space:nowrap;overflow:visible;text-align:left!important;vertical-align:middle!important;" nowrap="nowrap">
               
		                <a href="/web/20120122040251/http://rubyquiz.com/quiz98.html" title="4:02:51 Jan 22, 2012" style="background-color:transparent;border:none;"><img src="/static/images/toolbar/wm_tb_nxt_on.png" alt="Next capture" width="14" height="16" border="0"/></a>
		                
			    </td>
           </tr>

           <!-- NEXT/PREV YEAR NAV AND YEAR INDICATOR -->
           <tr style="width:110px;height:13px;font-size:9px!important;">
				<td style="padding-right:9px;font-size:11px!important;font-weight: bold;text-align:right;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20101127171802/http://rubyquiz.com/quiz98.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="27 Nov 2010"><strong>2010</strong></a>
		                
               </td>
               <td id="displayYearEl" style="background:#000;color:#ff0;font-size:11px!important;font-weight: bold;padding-top:1px;width:34px;height:13px;text-align:center;" title="You are here: 22:28:50 Jan 21, 2012">2012</td>
				<td style="padding-left:9px;font-size:11px!important;font-weight: bold;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20130215052453/http://rubyquiz.com/quiz98.html" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="15 Feb 2013"><strong>2013</strong></a>
		                
				</td>
           </tr>
           </tbody></table>
       </td>

       </tr>
       <tr>
       <td style="vertical-align:middle;padding:0!important;">
           <a href="/web/20120121222850*/http://rubyquiz.com/quiz98.html" style="color:#33f;font-size:11px;font-weight:bold;background-color:transparent;border:none;" title="See a list of every capture for this URL"><strong>25 captures</strong></a>
           <div style="margin:0!important;padding:0!important;color:#666;font-size:9px;padding-top:2px!important;white-space:nowrap;" title="Timespan for captures of this URL">20 Oct 06 - 15 Feb 13</div>
       </td>
       <td style="padding:0!important;">
       <a style="position:relative; white-space:nowrap; width:450px;height:27px;" href="" id="wm-graph-anchor">
       <div id="wm-ipp-sparkline" style="position:relative; white-space:nowrap; width:450px;height:27px;background-color:#fff;cursor:pointer;border-right:1px solid #ccc;" title="Explore captures for this URL">
			<img id="sparklineImgId" style="position:absolute; z-index:9012; top:0px; left:0px;"
				onmouseover="showTrackers('inline');" 
				onmouseout="showTrackers('none');"
				onmousemove="trackMouseMove(event,this)"
				alt="sparklines"
				width="450"
				height="27"
				border="0"
				src="/web/jsp/graph.jsp?graphdata=450_27_1996:-1:000000000000_1997:-1:000000000000_1998:-1:000000000000_1999:-1:000000000000_2000:-1:000000000000_2001:-1:000000000000_2002:-1:000000000000_2003:-1:000000000000_2004:-1:000000000000_2005:-1:000000000000_2006:-1:000000000100_2007:-1:000000100000_2008:-1:000000000000_2009:-1:000000000000_2010:-1:000000000010_2011:-1:000000100000_2012:0:30015000a100_2013:-1:010000000000"></img>
			<img id="wbMouseTrackYearImg" 
				style="display:none; position:absolute; z-index:9010;"
				width="25" 
				height="27"
				border="0"
				src="/static/images/toolbar/transp-yellow-pixel.png"></img>
			<img id="wbMouseTrackMonthImg"
				style="display:none; position:absolute; z-index:9011; " 
				width="2"
				height="27" 
				border="0"
				src="/static/images/toolbar/transp-red-pixel.png"></img>
       </div>
		</a>

       </td>
       </tr></tbody></table>
   </td>
   <td style="text-align:right;padding:5px;width:65px;font-size:11px!important;">
       <a href="javascript:;" onclick="document.getElementById('wm-ipp').style.display='none';" style="display:block;padding-right:18px;background:url(/static/images/toolbar/wm_tb_close.png) no-repeat 100% 0;color:#33f;font-family:'Lucida Grande','Arial',sans-serif;margin-bottom:23px;background-color:transparent;border:none;" title="Close the toolbar">Close</a>
       <a href="http://faq.web.archive.org/" style="display:block;padding-right:18px;background:url(/static/images/toolbar/wm_tb_help.png) no-repeat 100% 0;color:#33f;font-family:'Lucida Grande','Arial',sans-serif;background-color:transparent;border:none;" title="Get some help using the Wayback Machine">Help</a>
   </td>
   </tr></tbody></table>

</div>
</div>
<script type="text/javascript">
 var wmDisclaimBanner = document.getElementById("wm-ipp");
 if(wmDisclaimBanner != null) {
   disclaimElement(wmDisclaimBanner);
 }
</script>
<!-- END WAYBACK TOOLBAR INSERT -->

	<div id="page">
		<div id="header"><span class="ruby">Ruby</span> <span class="quiz">Quiz</span></div>
		<div id="content">
			<span class="title">A* (#98)</span>
			<p>by Steven Davidovitz</p>
			<p>The A* (A-Star) search algorithm is a path-finding algorithm with many uses, including Artificial Intelligence for games. The search builds the route from tile to tile until it reaches the goal. To help choose the best possible tile the algorithm will use an equation that takes into account the distance from the tile to the goal and the cost of moving to that tile.</p>
			<p>Let's work through an example, so you can see how this comes together.</p>
			<p class="example">Movement Cost for Terrain:<br />  Non-walkable:<br />    N/A = Water (~)<br />  Walkable:<br />    1 = Flatlands (. or @ or X)<br />    2 = Forest (*)<br />    3 = Mountain (^)<br /><br />Test Map:<br />  @*^^^    @ = User start<br />  ~~*~.    X = The goal tile<br />  **...<br />  ^..*~<br />  ~~*~X</p>
			<p>Step 1:  Search the surrounding tiles for walkable choices.</p>
			<p>The only possible tile for the fist step is to the right: a forest (*) tile.</p>
			<p>Step 2:  Go through that list finding the cost of movement for each of those choice tiles.  The cost of movement is the path cost so far, plus the cost to move to the tile being considered.</p>
			<p>Our cost so far is 0, since we just started.  The cost of a forest is 2 so the total cost of this move is 2 (0 + 2).</p>
			<p>Step 3:  Determine the distance from the choice tiles to the goal and add that to the cost from Step 2 to find the score for each tile.</p>
			<p>You can calculate the distance from the tile to the goal using Manhattan distance formula |x1 - x2| + |y1 - y2|.  For our example that is:</p>
			<p class="example">|1 - 4| + |0 - 4| = |-3| + |-4| = 7</p>
			<p>Knowing that we can produce the final score for this move:</p>
			<p class="example">score = cost (2) + distance to goal (7) = 9</p>
			<p>Step 4: Choose the best tile to move to by comparing the score of the surrounding tiles and choosing the lowest.</p>
			<p>Step 5:  Repeat Steps 1-4 until you reach the goal tile.  Be careful to prevent checking tiles twice and/or circling back.</p>
			<p class="example">Test Map Solution:<br />  ##^^^    # = Best path<br />  ~~#~.<br />  **.#.<br />  ^..#~<br />  ~~*~#</p>
			<p>When you have a working solution, try it out on this move involved map:</p>
			<p><a href="/web/20120121222850/http://www.rubyquiz.com/large_map.txt">Large Test Map</a></p>
			<hr />
			<p><span class="title">Quiz Summary</span></p>
			<p>As was brought up in the discussion, the effectiveness of the A* algorithm is very dependent on the estimate function used to gage distance remaining to the goal.  The quiz recommended the Manhattan Distance function for this role, but that's not very well suited to the kind of work we are doing here.  Daniel Martin suggested an alternate implementation producing better results.</p>
			<p>Let's have a look at Daniel's code below.</p>
			<p>Daniel first posted a set of unit tests to verify code correctness.  I won't go into all of those tests here, but let me show a couple.  As always, in unit testing it's a good idea to begin by verifying functionality in some trivial case:</p>
			<div class="code"><span class="type">ruby</span><div class="body">      <span class="comment"># ...</span><br /><br />      <span class="keyword">def</span> test_simple_horizontal<br />        map = <span class="string">%q(@..X)</span><br />        solution = <span class="variable">@solver</span>.do_quiz_solution(map)<br />        assert_paths_equal(<span class="string">%q(####)</span>, solution)<br />      <span class="keyword">end</span><br /><br />      <span class="comment"># ...</span><br /><br /></div></div>
			<p>This test ensures that the solver can walk a straight path, with no obstacles between the starting point and the goal.</p>
			<p>Daniel's tests increase in difficulty, of course, and the final test is the one Daniel used to show how the Manhattan Distance gets into trouble:</p>
			<div class="code"><span class="type">ruby</span><div class="body">      <span class="comment"># ...</span><br /><br />      <span class="keyword">def</span> test_bad_distance<br />        map = <span class="string">%q(@.*..<br />                 ..~..<br />                 ..^.X)</span>.sub(<span class="string">/ +/</span>,<span class="string">''</span>)<br />        solution = <span class="variable">@solver</span>.do_quiz_solution(map)<br />        assert_paths_equal(<br />              <span class="string">%q(#?#..<br />                 .?~#.<br />                 ..^.#)</span>, solution, <span class="string">"Got tripped up by manhattan distance"</span>)<br />      <span class="keyword">end</span><br /><br />      <span class="comment"># ...</span><br /><br /></div></div>
			<p>Here we see a neat feature of Daniel's custom assert_paths_equal() assertion (not shown).  The question marks allow any output in those cells.  The reasoning is that there are sometimes multiple correct paths.  Here the first move must be to one of the question marks, but either will produce the same length path.</p>
			<p>The real test here is to ensure that the path goes over the forrest.  The Manhattan Distance function can cause algorithms to favor the mountain route.</p>
			<p>Let's move on to the actual code now.</p>
			<p>One of the challenges the quiz didn't spend a lot of time on is that A* really needs a priority queue to manage the paths it is examining, always keeping the best path so far first in line.  Daniel took the easy way out of this problem and just resorted the paths after each insert:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="comment"># I suppose someone would think I should use a heap here.</span><br />    <span class="comment"># I've found that the built-in sort method is much faster</span><br />    <span class="comment"># than any heap implementation in ruby.  As a plus, the logic</span><br />    <span class="comment"># is easier to follow.</span><br />    <span class="keyword">class</span> PriorityQueue<br />      <span class="keyword">def</span> initialize<br />        <span class="variable">@list</span> = []<br />      <span class="keyword">end</span><br />      <span class="keyword">def</span> add(priority, item)<br />        <span class="comment"># Add @list.length so that sort is always using Fixnum comparisons,</span><br />        <span class="comment"># which should be fast, rather than whatever is comparison on `item'</span><br />        <span class="variable">@list</span> &lt;&lt; [priority, <span class="variable">@list</span>.length, item]<br />        <span class="variable">@list</span>.sort!<br />        <span class="keyword">self</span><br />      <span class="keyword">end</span><br />      <span class="keyword">def</span> &lt;&lt;(pritem)<br />        add(*pritem)<br />      <span class="keyword">end</span><br />      <span class="keyword">def</span> <span class="keyword">next</span><br />        <span class="variable">@list</span>.shift[2]<br />      <span class="keyword">end</span><br />      <span class="keyword">def</span> empty?<br />        <span class="variable">@list</span>.empty?<br />      <span class="keyword">end</span><br />    <span class="keyword">end</span><br /><br /></div></div>
			<p>The add() method is all of the magic here.  When an item is add()ed, Daniel actually adds a three element Array to the queue and resorts the entire queue.  The first element of the Array ensures that items are sorted by priority.  When priorities match, the second item breaks ties by add order.  The item never factors into the sort.  When the item is retrieved with next(), the two extra sort fields are discarded.</p>
			<p>I have to side-step a moment here and address Daniel's first comment.  To be clear, he is saying that using Ruby's sort() can be faster than a pure Ruby heap, since sort() is implemented in C.  If both elements are correctly implemented in C, the heap should definitely out perform resorting.  Finally, the Ruby heap can also be faster, as soon as significant input is involved:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="comment">#!/usr/bin/env ruby -w</span><br /><br />    require <span class="string">"sorted_array"</span>  <span class="comment"># Daniel's PriorityQueue</span><br />    require <span class="string">"heap"</span>          <span class="comment"># pure Ruby Heap, from Ruby Quiz #40</span><br />    require <span class="string">"benchmark"</span><br /><br />    DATA = Array.new(5_000) { rand(5_000) }.freeze<br />    Benchmark.bmbm(10) <span class="keyword">do</span> |results|<br />      results.report(<span class="string">"sorted_array:"</span>) <span class="keyword">do</span><br />        queue = PriorityQueue.new<br />        DATA.each { |n| queue.add(n, n) }<br />        queue.<span class="keyword">next</span> <span class="keyword">until</span> queue.empty?<br />      <span class="keyword">end</span><br />      results.report(<span class="string">"ruby_heap:"</span>) <span class="keyword">do</span><br />        queue = Heap.new<br />        DATA.each { |n| queue.insert(n) }<br />        queue.extract <span class="keyword">until</span> queue.empty?<br />      <span class="keyword">end</span><br />    <span class="keyword">end</span><br />    <span class="comment"># &gt;&gt; Rehearsal -------------------------------------------------</span><br />    <span class="comment"># &gt;&gt; sorted_array:  33.950000   0.020000  33.970000 ( 33.972859)</span><br />    <span class="comment"># &gt;&gt; ruby_heap:      0.450000   0.000000   0.450000 (  0.449776)</span><br />    <span class="comment"># &gt;&gt; --------------------------------------- total: 34.420000sec</span><br />    <span class="comment"># &gt;&gt; </span><br />    <span class="comment"># &gt;&gt;                     user     system      total        real</span><br />    <span class="comment"># &gt;&gt; sorted_array:  33.990000   0.010000  34.000000 ( 34.016562)</span><br />    <span class="comment"># &gt;&gt; ruby_heap:      0.440000   0.000000   0.440000 (  0.437217)</span><br /><br /></div></div>
			<p>OK, let's get back to Daniel's code:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    require <span class="string">'enumerator'</span><br /><br />    <span class="keyword">class</span> Astar<br />      <span class="keyword">def</span> do_quiz_solution(puzzle)<br />        <span class="variable">@terrain</span> = []<br />        instr = <span class="string">""</span><br />        puzzle.each {|rowstr|<br />          <span class="keyword">next</span> <span class="keyword">if</span> rowstr =~ <span class="string">/^\s*$/</span><br />          rowstr.gsub!(<span class="string">/[^.@~X*^]/</span>,<span class="string">''</span>)<br />          instr += rowstr<br />          instr += <span class="string">"\n"</span><br />          row = []<br />          rowstr.scan(<span class="string">/[.@~X*^]/</span>) {|terrain|<br />            <span class="keyword">case</span> terrain<br />            <span class="keyword">when</span> <span class="string">/[.@X]/</span>; row &lt;&lt; 1<br />            <span class="keyword">when</span> <span class="string">/[*]/</span>;   row &lt;&lt; 2<br />            <span class="keyword">when</span> <span class="string">/\^/</span>;    row &lt;&lt; 3<br />            <span class="keyword">when</span> <span class="string">/~/</span>;     row &lt;&lt; <span class="keyword">nil</span><br />            <span class="keyword">end</span><br />          }<br />          xind = rowstr.index(<span class="string">'X'</span>)<br />          aind = rowstr.index(<span class="string">'@'</span>)<br />          <span class="keyword">if</span> (aind)<br />            <span class="variable">@start</span> = [<span class="variable">@terrain</span>.length, aind]<br />          <span class="keyword">end</span><br />          <span class="keyword">if</span> (xind)<br />            <span class="variable">@goal</span> = [<span class="variable">@terrain</span>.length, xind]<br />          <span class="keyword">end</span><br />          <span class="variable">@terrain</span> &lt;&lt; row<br />        }<br />        <span class="keyword">if</span> do_find_path<br />          outarr = instr.split(<span class="string">/\n/</span>)<br />          <span class="variable">@path</span>.each{|row,col| outarr[row][col]=<span class="string">'#'</span>}<br />          <span class="keyword">return</span> outarr.join(<span class="string">"\n"</span>)<br />        <span class="keyword">else</span><br />          <span class="keyword">return</span> <span class="keyword">nil</span><br />        <span class="keyword">end</span><br />      <span class="keyword">end</span><br /><br />      <span class="comment"># ...</span><br /><br /></div></div>
			<p>This method manages the quiz process.  First, an Array is created to hold the costs of each cell and a String to hold the passed map.  The each() iterator cleans and dissects the input, filling both structures as it goes.  It also locates the @start and @goal coordinates while it works.</p>
			<p>With the setup out of the way, a hand-off is made to do_find_path() which is the A* implementation.  If a path is found, the indicated coordinates are marked on the original map String and returned.  Otherwise, nil is returned.</p>
			<p>Here's the heart of the matter:</p>
			<div class="code"><span class="type">ruby</span><div class="body">      <span class="comment"># ...</span><br /><br />      <span class="keyword">def</span> do_find_path<br />        been_there = {}<br />        pqueue = PriorityQueue.new<br />        pqueue &lt;&lt; [1,[<span class="variable">@start</span>,[],1]]<br />        <span class="keyword">while</span> !pqueue.empty?<br />          spot,path_so_far,cost_so_far = pqueue.<span class="keyword">next</span><br />          <span class="keyword">next</span> <span class="keyword">if</span> been_there[spot]<br />          newpath = [path_so_far, spot]<br />          <span class="keyword">if</span> (spot == <span class="variable">@goal</span>)<br />            <span class="variable">@path</span> = []<br />            newpath.flatten.each_slice(2) {|i,j| <span class="variable">@path</span> &lt;&lt; [i,j]}<br />            <span class="keyword">return</span> <span class="variable">@path</span><br />          <span class="keyword">end</span><br />          been_there[spot] = 1<br />          spotsfrom(spot).each {|newspot|<br />            <span class="keyword">next</span> <span class="keyword">if</span> been_there[newspot]<br />            tcost = <span class="variable">@terrain</span>[newspot[0]][newspot[1]]<br />            newcost = cost_so_far + tcost<br />            pqueue &lt;&lt; [newcost + estimate(newspot), [newspot,newpath,newcost]]<br />          }<br />        <span class="keyword">end</span><br />        <span class="keyword">return</span> <span class="keyword">nil</span><br />      <span class="keyword">end</span><br /><br />      <span class="comment"># ...</span><br /><br /></div></div>
			<p>This is the A* algorithm in Daniel's code.  It begins by establishing a Hash to track where it has been and a PriorityQueue to manage the paths being considered.  From there the code dives into the search loop which terminates when the the PriorityQueue is empty?(), indicating that all move options have been exhausted.</p>
			<p>At each step through the loop, where we are, the path so far, and the cumlative cost are pulled out of the PriorityQueue.  We skip ahead if we've been on this spot before.  (The first path would have been shorter, since the PriorityQueue keeps them sorted.)  The new path is built, including our new location, and we check to see if the @goal has been reached.  When it has, the path is converted from to a list of coordinates and returned.</p>
			<p>If we're not at the goal, we need to extend the path one step in every direction.  Here the helper method spotsfrom() generates the choices to iterate over.  If we've been there before we can skip it, otherwise the new cost is calculated via the other helper method estimate() and added, with the new path, to the PriorityQueue.</p>
			<p>Let's have a look at those helper methods:</p>
			<div class="code"><span class="type">ruby</span><div class="body">      <span class="comment"># ...</span><br /><br />      <span class="keyword">def</span> estimate(spot)<br />        <span class="comment"># quiz statement version</span><br />        <span class="comment"># (spot[0] - @goal[0]).abs + (spot[1] - @goal[1]).abs</span><br />        <span class="comment"># my version</span><br />        [(spot[0] - <span class="variable">@goal</span>[0]).abs, (spot[1] - <span class="variable">@goal</span>[1]).abs].max<br />      <span class="keyword">end</span><br /><br />      <span class="keyword">def</span> spotsfrom(spot)<br />        retval = []<br />        vertadds = [0,1]<br />        horizadds = [0,1]<br />        <span class="keyword">if</span> (spot[0] &gt; 0) <span class="keyword">then</span> vertadds &lt;&lt; -1; <span class="keyword">end</span><br />        <span class="keyword">if</span> (spot[1] &gt; 0) <span class="keyword">then</span> horizadds &lt;&lt; -1; <span class="keyword">end</span><br />        vertadds.each{|v| horizadds.each{|h|<br />            <span class="keyword">if</span> (v != 0 <span class="keyword">or</span> h != 0) <span class="keyword">then</span><br />              ns = [spot[0]+v,spot[1]+h]<br />              <span class="keyword">if</span> (<span class="variable">@terrain</span>[ns[0]] <span class="keyword">and</span> <span class="variable">@terrain</span>[ns[0]][ns[1]]) <span class="keyword">then</span><br />                retval &lt;&lt; ns<br />              <span class="keyword">end</span><br />            <span class="keyword">end</span><br />          }}<br />        retval<br />      <span class="keyword">end</span><br />    <span class="keyword">end</span><br /><br /></div></div>
			<p>The estimate() method is Daniel's improvement to distance calculation.  Since diagonal moves are allowed to shorten two distances at once, we really just need to consider the longer distance, vertically or horizontally, to the goal.</p>
			<p>The other helper builds a list of neighbors by adding combinations of -1, 0, and 1 as offsets to the current location coordinates.  The @terrain Array is used to reality check these coordinates as in-bounds and walkable, before they are added to the returned Array.</p>
			<p>The final solution is just an instance creation and interface method call away:</p>
			<div class="code"><span class="type">ruby</span><div class="body">    <span class="keyword">if</span> <span class="keyword">__FILE__</span> == <span class="global">$0</span><br />      puts Astar.new.do_quiz_solution(ARGF)<br />    <span class="keyword">end</span><br /><br /></div></div>
			<p>My thanks to all the pathfinders who fiddled around with the quiz and to Daniel Martin especially for helping to clarify intent.</p>
			<p>Ruby Quiz for this week:  Seek James out at RubyConf and introduce yourself!</p>
		</div>
		<div id="logo"><img src="/web/20120121222850im_/http://rubyquiz.com/images/ruby_quiz_logo.jpg" alt="" width="157" height="150" /></div>
		<div id="links">
			<span class="title">Quiz Solutions</span>
			<ol>
				<li><a href="/web/20120121222850/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/219807">Roland Swingler</a></li>
				<li><a href="/web/20120121222850/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/219851">Daniel Martin</a></li>
				<li><a href="/web/20120121222850/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/219868">Daniel Martin (2)</a></li>
				<li><a href="/web/20120121222850/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/219875">Paolo Negri</a></li>
				<li><a href="/web/20120121222850/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/219877">Boris Prinz</a></li>
				<li><a href="/web/20120121222850/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/219896">Tristram Gr&auml;bener</a></li>
				<li><a href="/web/20120121222850/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/219918">Glen F. Pankow</a></li>
				<li><a href="/web/20120121222850/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/219993">Edward Harman</a></li>
				<li><a href="/web/20120121222850/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/220117">Louis J Scoras</a></li>
				<li><a href="/web/20120121222850/http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/220117">Brendan Bauer-Peters</a></li>
			</ol>
			<p><a href="/web/20120121222850/http://rubyquiz.com/quiz98_sols.zip">Download Solutions</a></p>
			<p><a href="/web/20120121222850/http://rubyquiz.com/index.html">Back to Quiz Listing</a></p>
		</div>
		<div id="footer">&nbsp;</div>
	</div>
</body>
</html>





<!--
     FILE ARCHIVED ON 22:28:50 Jan 21, 2012 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 13:10:25 Jun 5, 2013.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
